# AUT-007: Email ë¡œê·¸ì¸

**Epic**: IAM Platform (AuthHub)
**Feature**: Email ë¡œê·¸ì¸ (INTERNAL ì‚¬ìš©ì ì „ìš©)
**Phase**: Phase 1 - Core Authentication
**ë¸Œëœì¹˜**: feature/AUT-007-email-login
**ì˜ì¡´ì„±**: AUT-000, AUT-001, AUT-006 (INTERNAL User), AUT-002 (AuthToken)

---

## ğŸ“ ëª©ì 

INTERNAL ì‚¬ìš©ì ì´ë©”ì¼ ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„
- Email + Password ì¸ì¦
- BCrypt ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
- Access Token ë° Refresh Token ë°œê¸‰ (JWT)
- Rate Limiting ë° ë³´ì•ˆ ì •ì±… ì ìš©

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

**ì¬ì‚¬ìš©** (AUT-002ì—ì„œ ì •ì˜ë¨):
- Credential VO (ì´ë©”ì¼ ê¸°ë°˜ ê²€ì¦)
- AuthToken VO
- User Aggregate (`authenticate(Credential)` ë©”ì„œë“œ)

#### 1.1 Domain Exception
- [ ] **InvalidEmailOrPasswordException** (ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜)
- [ ] **InactiveUserException** (ë¹„í™œì„±í™”ëœ ì‚¬ìš©ì, status != ACTIVE)

#### 1.2 Domain Event
- [ ] **UserLoggedInViaEmail** Event
  - userId, email, ipAddress, userAgent, loggedInAt

---

### 2. Application Layer

#### 2.1 LoginWithEmailUseCase (Command)
- [ ] **Input**: LoginWithEmailCommand
  - email (String)
  - password (String)
  - ipAddress (String)
  - userAgent (String)

- [ ] **Output**: AuthTokenResponse
  - accessToken (String)
  - refreshToken (String)
  - expiresAt (LocalDateTime)

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. Emailë¡œ User ì¡°íšŒ (LoadUserByEmailPort)
  2. User.authenticate(Credential) â†’ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (BCrypt)
  3. User.canLogin() ê²€ì¦ (status = ACTIVE í™•ì¸)
  4. Access Token ìƒì„± (GenerateAccessTokenPort)
  5. Refresh Token ìƒì„± ë° ì €ì¥ (SaveRefreshTokenPort)
  6. UserLoggedInViaEmail Event ë°œí–‰

#### 2.2 Port ì •ì˜
- [ ] **LoadUserByEmailPort** (Out):
  - load(Email) â†’ Optional<User>

**ì¬ì‚¬ìš© Port** (AUT-002):
- GenerateAccessTokenPort
- SaveRefreshTokenPort

---

### 3. Persistence Layer

**ê¸°ì¡´ Repository ë° Adapter ì¬ì‚¬ìš©** (AUT-001, AUT-002)

#### 3.1 UserJpaRepository í™•ì¥
- [ ] **findByEmail(String email) â†’ Optional<UserEntity>** ì¶”ê°€

#### 3.2 Adapter í™•ì¥
- [ ] **UserQueryAdapter** (LoadUserByEmailPort êµ¬í˜„)

---

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/auth/login/email**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 200 OK

#### 4.2 Request DTO
- [ ] **LoginWithEmailRequest**:
  - email (String, @NotBlank, @Email)
  - password (String, @NotBlank)

#### 4.3 Response DTO
- [ ] **AuthTokenResponse** (ì¬ì‚¬ìš©, AUT-002)

#### 4.4 Controller
- [ ] **AuthController**:
  - loginWithEmail(@Valid LoginWithEmailRequest, HttpServletRequest) â†’ ResponseEntity<AuthTokenResponse>

#### 4.5 Error Handling
- [ ] **InvalidEmailOrPasswordException** â†’ HTTP 401 Unauthorized
  ```json
  {
    "errorCode": "INVALID_EMAIL_OR_PASSWORD",
    "message": "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤",
    "timestamp": "2024-01-01T12:00:00"
  }
  ```

- [ ] **InactiveUserException** â†’ HTTP 403 Forbidden
  ```json
  {
    "errorCode": "INACTIVE_USER",
    "message": "ë¹„í™œì„±í™”ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤",
    "timestamp": "2024-01-01T12:00:00"
  }
  ```

---

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ ì´ë©”ì¼ ë¡œê·¸ì¸ (INTERNAL ì‚¬ìš©ì)**:
  - Given: ë“±ë¡ëœ INTERNAL ì‚¬ìš©ì (email: admin@company.com, userType: INTERNAL)
  - When: POST /api/v1/auth/login/email
  - Then:
    - HTTP 200, AuthTokenResponse ë°˜í™˜
    - DB í™•ì¸: refresh_tokens í…Œì´ë¸”ì— í† í° ì‚½ì…
    - Event í™•ì¸: UserLoggedInViaEmail ë°œí–‰
    - JWT ê²€ì¦: userId, userType, tenantId í¬í•¨

- [ ] **ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜**:
  - Given: ë“±ë¡ëœ ì‚¬ìš©ì (email: admin@company.com)
  - When: POST /api/v1/auth/login/email (ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸)
  - Then: HTTP 401, "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"

- [ ] **ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë©”ì¼**:
  - Given: ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ (notfound@example.com)
  - When: POST /api/v1/auth/login/email
  - Then: HTTP 401, "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"

- [ ] **ë¹„í™œì„±í™”ëœ ì‚¬ìš©ì ë¡œê·¸ì¸ ì‹œë„**:
  - Given: INTERNAL ì‚¬ìš©ì (status = INACTIVE)
  - When: POST /api/v1/auth/login/email
  - Then: HTTP 403, "ë¹„í™œì„±í™”ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤"

- [ ] **JWT í† í° êµ¬ì¡° ê²€ì¦**:
  - Given: ì •ìƒ ë¡œê·¸ì¸ ì™„ë£Œ
  - When: Access Token ë””ì½”ë”©
  - Then:
    - Header: {"alg": "HS256", "typ": "JWT"}
    - Payload: {"userId": 1, "userType": "INTERNAL", "tenantId": 1, "exp": 1800}
    - Signature: HMAC-SHA256 ê²€ì¦

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V4 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **INTERNAL ì‚¬ìš©ì**: email = "admin@company.com", password = BCrypt("test1234")

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Tell Don't Ask** - User.authenticate, User.canLogin ì‚¬ìš©
- [ ] **Transaction ê²½ê³„** - UseCase ì „ì²´ê°€ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì‹¤í–‰

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (ê¸°ë³¸ êµ¬ì¡°)
  - AUT-001 (User Aggregate, Credential VO)
  - AUT-001.5 (INTERNAL User ë“±ë¡)
  - AUT-002 (AuthToken ë°œê¸‰)

### ë³´ì•ˆ ê·œì¹™
- [ ] **BCrypt ê²€ì¦** - ë¹„ë°€ë²ˆí˜¸ëŠ” BCrypt.checkpwë¡œ ê²€ì¦
- [ ] **Rate Limiting** - ë¡œê·¸ì¸ APIëŠ” Rate Limiting ì ìš© (AUT-012)
- [ ] **User Enumeration ë°©ì§€** - "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤" (êµ¬ì²´ì  ì •ë³´ ë¯¸ì œê³µ)

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: User.authenticate, Credential.validate
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (ì¬ì‚¬ìš©)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (LoginWithEmailUseCase)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (findByEmail ì¶”ê°€)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (AuthController)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 5ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **BCrypt ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì™„ë£Œ**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (2.1.2 LoginWithEmailUseCase)
- **Plan**: docs/prd/plans/AUT-002.5-email-login-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-60

# AUT-005: Organization ìƒì„± ë° ë©¤ë²„ ê´€ë¦¬

**Epic**: IAM Platform (AuthHub)
**Feature**: Organization ìƒì„± ë° ë©¤ë²„ ê´€ë¦¬
**Phase**: Phase 1 - Core Authentication
**ë¸Œëœì¹˜**: feature/AUT-005-organization-member
**ì˜ì¡´ì„±**: AUT-000 (Organization Aggregate ê¸°ë³¸ êµ¬ì¡°), AUT-010 (Tenant ê´€ë¦¬)

---

## ğŸ“ ëª©ì 

Organization ìƒì„± ë° ë©¤ë²„ ê´€ë¦¬ ê¸°ëŠ¥ êµ¬í˜„
- Organization ìƒì„± (ORG_ADMIN ê¶Œí•œ í•„ìš”)
- Organization ë©¤ë²„ ì´ˆëŒ€
- Organization ë©¤ë²„ ì¡°íšŒ
- Organization ë©¤ë²„ ì œê±°

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 Organization Aggregate í™•ì¥
- [ ] **Organization Aggregateì— ì¶”ê°€**:
  - members (Set<OrganizationMember> VO)
  - `addMember(User, Role)` â†’ OrganizationMember
  - `removeMember(UserId)` â†’ void
  - `updateMemberRole(UserId, Role)` â†’ void
  - `canAddMember()` â†’ boolean (ê²€ì¦ ë¡œì§)

#### 1.2 OrganizationMember VO
- [ ] **OrganizationMember VO** ìƒì„±
  - userId (Long)
  - organizationId (Long)
  - role (OrganizationRole Enum)
  - joinedAt (LocalDateTime)

#### 1.3 OrganizationRole Enum
- [ ] **OrganizationRole Enum**:
  - ORG_ADMIN (ì¡°ì§ ê´€ë¦¬ì, ë©¤ë²„ ì´ˆëŒ€/ì œê±° ê°€ëŠ¥)
  - MEMBER (ì¼ë°˜ ë©¤ë²„)

#### 1.4 OrganizationName VO
- [ ] **OrganizationName VO**:
  - ê²€ì¦ ê·œì¹™: 2-100ì

#### 1.5 Domain Exception
- [ ] **DuplicateOrganizationNameException** (Organization ì´ë¦„ ì¤‘ë³µ)
- [ ] **OrganizationNotFoundException** (Organization ì—†ìŒ)
- [ ] **UserAlreadyMemberException** (ì´ë¯¸ ë©¤ë²„)
- [ ] **UserNotMemberException** (ë©¤ë²„ ì•„ë‹˜)
- [ ] **InsufficientOrganizationPermissionException** (ê¶Œí•œ ë¶€ì¡±)

#### 1.6 Domain Event
- [ ] **OrganizationCreated** Event
  - organizationId, tenantId, name, createdBy, createdAt

- [ ] **MemberAddedToOrganization** Event
  - organizationId, userId, role, addedBy, addedAt

- [ ] **MemberRemovedFromOrganization** Event
  - organizationId, userId, removedBy, removedAt

### 2. Application Layer

#### 2.1 CreateOrganizationUseCase (Command)
- [ ] **Input**: CreateOrganizationCommand
  - tenantId (Long)
  - name (String)
  - requestedBy (Long, userId)

- [ ] **Output**: OrganizationResponse
  - organizationId, tenantId, name, status, createdAt

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. ì‚¬ìš©ì ì¡°íšŒ ë° ORG_ADMIN ê¶Œí•œ ê²€ì¦ (LoadUserPort)
  2. Organization ì´ë¦„ ì¤‘ë³µ í™•ì¸ (CheckDuplicateOrganizationNamePort)
  3. Organization Aggregate ìƒì„±
  4. ìƒì„±ìë¥¼ ORG_ADMINìœ¼ë¡œ ìë™ ì¶”ê°€
  5. Organization ì €ì¥ (SaveOrganizationPort)
  6. OrganizationCreated Event ë°œí–‰

#### 2.2 AddMemberToOrganizationUseCase (Command)
- [ ] **Input**: AddMemberToOrganizationCommand
  - organizationId (Long)
  - userId (Long, ì´ˆëŒ€í•  ì‚¬ìš©ì)
  - role (OrganizationRole)
  - requestedBy (Long, í˜„ì¬ ì‚¬ìš©ì)

- [ ] **Output**: OrganizationMemberResponse

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. Organization ì¡°íšŒ (LoadOrganizationPort)
  2. requestedByê°€ ORG_ADMINì¸ì§€ ê²€ì¦
  3. ì´ˆëŒ€í•  ì‚¬ìš©ì ì¡°íšŒ (LoadUserPort)
  4. ì´ë¯¸ ë©¤ë²„ì¸ì§€ í™•ì¸
  5. Organization.addMember(user, role)
  6. Organization ì €ì¥ (SaveOrganizationPort)
  7. MemberAddedToOrganization Event ë°œí–‰

#### 2.3 RemoveMemberFromOrganizationUseCase (Command)
- [ ] **Input**: RemoveMemberFromOrganizationCommand
  - organizationId (Long)
  - userId (Long, ì œê±°í•  ì‚¬ìš©ì)
  - requestedBy (Long, í˜„ì¬ ì‚¬ìš©ì)

- [ ] **Output**: void

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. Organization ì¡°íšŒ (LoadOrganizationPort)
  2. requestedByê°€ ORG_ADMINì¸ì§€ ê²€ì¦
  3. Organization.removeMember(userId)
  4. Organization ì €ì¥ (SaveOrganizationPort)
  5. MemberRemovedFromOrganization Event ë°œí–‰

#### 2.4 ListOrganizationMembersQuery (Query)
- [ ] **Input**: ListOrganizationMembersQueryRequest
  - organizationId (Long)

- [ ] **Output**: List<OrganizationMemberResponse>

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. Organization ì¡°íšŒ (LoadOrganizationPort)
  2. ë©¤ë²„ ëª©ë¡ ë°˜í™˜

#### 2.5 Port ì •ì˜
- [ ] **SaveOrganizationPort** (Out):
  - save(Organization) â†’ Organization

- [ ] **LoadOrganizationPort** (Out):
  - load(Long organizationId) â†’ Optional<Organization>

- [ ] **CheckDuplicateOrganizationNamePort** (Out):
  - exists(Long tenantId, String name) â†’ boolean

### 3. Persistence Layer

#### 3.1 OrganizationMemberEntity
- [ ] **OrganizationMemberEntity** ìƒì„±
  - id (Long, PK)
  - organization_id (Long, FK)
  - user_id (Long, FK)
  - role (String, ORG_ADMIN/MEMBER)
  - joined_at (LocalDateTime)

#### 3.2 Flyway ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] **V8__create_organization_members.sql**:
  - organization_members í…Œì´ë¸” ìƒì„±
  - Unique Constraint: (organization_id, user_id)
  - Index: (user_id, organization_id)

#### 3.3 Repository
- [ ] **OrganizationJpaRepository**:
  - save(OrganizationEntity) â†’ OrganizationEntity
  - findById(Long) â†’ Optional<OrganizationEntity>
  - existsByTenantIdAndName(Long, String) â†’ boolean

- [ ] **OrganizationMemberJpaRepository**:
  - save(OrganizationMemberEntity) â†’ OrganizationMemberEntity
  - findByOrganizationId(Long) â†’ List<OrganizationMemberEntity>
  - deleteByOrganizationIdAndUserId(Long, Long) â†’ void

#### 3.4 Adapter
- [ ] **OrganizationCommandAdapter** (SaveOrganizationPort êµ¬í˜„)

- [ ] **OrganizationQueryAdapter** (LoadOrganizationPort, CheckDuplicateOrganizationNamePort êµ¬í˜„)

#### 3.5 Mapper
- [ ] **OrganizationMapper**:
  - toEntity(Organization) â†’ OrganizationEntity
  - toDomain(OrganizationEntity, List<OrganizationMemberEntity>) â†’ Organization

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/organizations**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 201 Created
  - ì¸ì¦ í•„ìˆ˜ (ORG_ADMIN)

- [ ] **POST /api/v1/organizations/{organizationId}/members**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 201 Created
  - ì¸ì¦ í•„ìˆ˜ (ORG_ADMIN)

- [ ] **GET /api/v1/organizations/{organizationId}/members**
  - HTTP Method: GET
  - Response: HTTP 200 OK

- [ ] **DELETE /api/v1/organizations/{organizationId}/members/{userId}**
  - HTTP Method: DELETE
  - Response: HTTP 204 No Content
  - ì¸ì¦ í•„ìˆ˜ (ORG_ADMIN)

#### 4.2 Request DTO
- [ ] **CreateOrganizationRequest**:
  - name (String, @NotBlank, @Size(min=2, max=100))

- [ ] **AddMemberToOrganizationRequest**:
  - userId (Long, @NotNull)
  - role (String, @NotBlank, ORG_ADMIN/MEMBER)

#### 4.3 Response DTO
- [ ] **OrganizationResponse**:
  - organizationId (Long)
  - tenantId (Long)
  - name (String)
  - status (String)
  - createdAt (LocalDateTime)

- [ ] **OrganizationMemberResponse**:
  - userId (Long)
  - organizationId (Long)
  - role (String)
  - joinedAt (LocalDateTime)

#### 4.4 Controller
- [ ] **OrganizationController**:
  - createOrganization(@Valid CreateOrganizationRequest, @AuthenticationPrincipal userId) â†’ ResponseEntity<OrganizationResponse>
  - addMember(@PathVariable Long organizationId, @Valid AddMemberToOrganizationRequest, @AuthenticationPrincipal userId) â†’ ResponseEntity<OrganizationMemberResponse>
  - listMembers(@PathVariable Long organizationId) â†’ ResponseEntity<List<OrganizationMemberResponse>>
  - removeMember(@PathVariable Long organizationId, @PathVariable Long userId, @AuthenticationPrincipal currentUserId) â†’ ResponseEntity<Void>

#### 4.5 Error Handling
- [ ] **DuplicateOrganizationNameException** â†’ HTTP 409, "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” Organization ì´ë¦„ì…ë‹ˆë‹¤"
- [ ] **OrganizationNotFoundException** â†’ HTTP 404, "Organizationì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
- [ ] **UserAlreadyMemberException** â†’ HTTP 409, "ì´ë¯¸ Organization ë©¤ë²„ì…ë‹ˆë‹¤"
- [ ] **UserNotMemberException** â†’ HTTP 400, "Organization ë©¤ë²„ê°€ ì•„ë‹™ë‹ˆë‹¤"
- [ ] **InsufficientOrganizationPermissionException** â†’ HTTP 403, "Organization ê´€ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ Organization ìƒì„±**:
  - Given: ORG_ADMIN ê¶Œí•œ ì‚¬ìš©ì
  - When: POST /api/v1/organizations (name: "Engineering")
  - Then: HTTP 201, OrganizationResponse ë°˜í™˜
  - DB í™•ì¸: organizations í…Œì´ë¸” + organization_members (ìƒì„±ì ORG_ADMIN)
  - Event í™•ì¸: OrganizationCreated ë°œí–‰

- [ ] **ì •ìƒ ë©¤ë²„ ì¶”ê°€**:
  - Given: Organization ORG_ADMIN
  - When: POST /api/v1/organizations/{id}/members (userId: 2, role: MEMBER)
  - Then: HTTP 201, OrganizationMemberResponse ë°˜í™˜
  - DB í™•ì¸: organization_members í…Œì´ë¸”ì— ë°ì´í„° ì‚½ì…
  - Event í™•ì¸: MemberAddedToOrganization ë°œí–‰

- [ ] **ì´ë¯¸ ë©¤ë²„ì¸ ì‚¬ìš©ì ì¶”ê°€ ì‹œë„**:
  - Given: ì´ë¯¸ ë©¤ë²„ì¸ ì‚¬ìš©ì
  - When: POST /api/v1/organizations/{id}/members
  - Then: HTTP 409, "ì´ë¯¸ Organization ë©¤ë²„ì…ë‹ˆë‹¤"

- [ ] **ì •ìƒ ë©¤ë²„ ì œê±°**:
  - Given: Organization ORG_ADMIN
  - When: DELETE /api/v1/organizations/{id}/members/{userId}
  - Then: HTTP 204
  - DB í™•ì¸: organization_members í…Œì´ë¸”ì—ì„œ ì‚­ì œ
  - Event í™•ì¸: MemberRemovedFromOrganization ë°œí–‰

- [ ] **ORG_ADMIN ê¶Œí•œ ê²€ì¦**:
  - Given: MEMBER ê¶Œí•œ ì‚¬ìš©ì
  - When: POST /api/v1/organizations/{id}/members
  - Then: HTTP 403, "Organization ê´€ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V8 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **ORG_ADMIN ì‚¬ìš©ì**: INTERNAL ì‚¬ìš©ì + ORG_ADMIN ê¶Œí•œ

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Tell Don't Ask** - Organization.addMember, removeMember ë©”ì„œë“œ ì‚¬ìš©
- [ ] **Long FK ì „ëµ** - OrganizationMemberEntityì— `private Long userId`

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (Organization Aggregate ê¸°ë³¸ êµ¬ì¡°)
  - AUT-007 (Tenant ê´€ë¦¬)

### ë³´ì•ˆ ê·œì¹™
- [ ] **ORG_ADMIN ê¶Œí•œ ê²€ì¦** - ë©¤ë²„ ì¶”ê°€/ì œê±°ëŠ” ORG_ADMINë§Œ ê°€ëŠ¥

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: Organization.addMember, removeMember
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (Organization í™•ì¥, OrganizationMember VO)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (CreateOrganizationUseCase, AddMemberToOrganizationUseCase, RemoveMemberFromOrganizationUseCase)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (OrganizationMemberEntity, Repository)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (OrganizationController)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 5ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **ORG_ADMIN ê¶Œí•œ ê²€ì¦ ì™„ë£Œ**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (3.2 Organization Creation and Member Management)
- **Plan**: docs/prd/plans/AUT-008-organization-member-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-58

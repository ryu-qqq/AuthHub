# AUT-005: Integration Test êµ¬í˜„

**Epic**: B2B AuthHub - ë©€í‹° í…Œë„ŒíŠ¸ ì¸ì¦/ì¸ê°€ ì‹œìŠ¤í…œ
**Issue Key**: AUT-005
**Layer**: Integration Test
**Branch**: `feature/AUT-005-integration-test`
**Jira Epic**: [AUT-73](https://ryuqqq.atlassian.net/browse/AUT-73)
**Jira Issue**: [AUT-78](https://ryuqqq.atlassian.net/browse/AUT-78)

---

## ğŸ“‹ Purpose

B2B AuthHubì˜ ëª¨ë“  ë ˆì´ì–´ë¥¼ í†µí•©í•œ E2E í…ŒìŠ¤íŠ¸ë¥¼ TDDë¡œ ê°œë°œí•©ë‹ˆë‹¤.

**í•µì‹¬ ì›ì¹™**:
- ì‹¤ì œ í™˜ê²½ê³¼ ìœ ì‚¬í•œ í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì„±
- Testcontainersë¥¼ í†µí•œ MySQL/Redis ê²©ë¦¬
- @Sqlì„ í†µí•œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„
- Flyway Migration ê²€ì¦
- ì „ì²´ í”Œë¡œìš° ê²€ì¦ (Controller â†’ UseCase â†’ Repository)

---

## ğŸ¯ Requirements

### 1. Integration Test í™˜ê²½ êµ¬ì„±

#### 1.1 Test Configuration

```java
// config/IntegrationTestConfig.java
@TestConfiguration
public class IntegrationTestConfig {

    @Bean
    public DataSource dataSource() {
        return DataSourceBuilder.create()
            .driverClassName("org.testcontainers.jdbc.ContainerDatabaseDriver")
            .url("jdbc:tc:mysql:8.0:///test_db")
            .build();
    }

    @Bean
    public RedisConnectionFactory redisConnectionFactory() {
        RedisStandaloneConfiguration config = new RedisStandaloneConfiguration();
        config.setHostName("localhost");
        config.setPort(6379); // Testcontainers Redis port
        return new LettuceConnectionFactory(config);
    }
}

// IntegrationTestBase.java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles("test")
@Testcontainers
public abstract class IntegrationTestBase {

    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
        .withDatabaseName("test_db")
        .withUsername("test")
        .withPassword("test");

    @Container
    static GenericContainer<?> redis = new GenericContainer<>("redis:7-alpine")
        .withExposedPorts(6379);

    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", mysql::getJdbcUrl);
        registry.add("spring.datasource.username", mysql::getUsername);
        registry.add("spring.datasource.password", mysql::getPassword);
        registry.add("spring.redis.host", redis::getHost);
        registry.add("spring.redis.port", redis::getFirstMappedPort);
    }

    @Autowired
    protected TestRestTemplate restTemplate;

    @Autowired
    protected JdbcTemplate jdbcTemplate;

    @BeforeEach
    void setUp() {
        // ê° í…ŒìŠ¤íŠ¸ ì „ Redis ì´ˆê¸°í™”
        clearRedisCache();
    }

    @AfterEach
    void tearDown() {
        // ê° í…ŒìŠ¤íŠ¸ í›„ DB ì •ë¦¬ (@Sqlë¡œ ê´€ë¦¬)
    }

    protected void clearRedisCache() {
        // Redis ìºì‹œ ì „ì²´ ì‚­ì œ
        RedisConnection connection = redisConnectionFactory.getConnection();
        connection.flushAll();
        connection.close();
    }
}
```

#### 1.2 Test Data (SQL)

```sql
-- test/resources/sql/auth/auth-test-data.sql
-- Tenant ë°ì´í„°
INSERT INTO tenants (id, name, status, mfa_required, token_expiry_minutes, refresh_token_expiry_days, max_refresh_tokens_per_user, created_at, updated_at, deleted_at)
VALUES
    (UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440001', '-', '')), 'Test Tenant', 'ACTIVE', false, 15, 7, 5, NOW(), NOW(), NULL);

-- Organization ë°ì´í„°
INSERT INTO organizations (id, tenant_id, name, status, created_at, updated_at, deleted_at)
VALUES
    (UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440101', '-', '')), UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440001', '-', '')), 'Test Organization', 'ACTIVE', NOW(), NOW(), NULL);

-- User ë°ì´í„°
INSERT INTO users (id, tenant_id, organization_id, username, email, password_hash, user_type, status, phone_number, created_at, updated_at, deleted_at)
VALUES
    (UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440201', '-', '')),
     UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440001', '-', '')),
     UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440101', '-', '')),
     'testuser',
     'test@example.com',
     '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy', -- Password123
     'INTERNAL',
     'ACTIVE',
     '+821012345678',
     NOW(),
     NOW(),
     NULL);

-- Role ë°ì´í„°
INSERT INTO roles (id, tenant_id, code, name, scope, created_at, updated_at, deleted_at)
VALUES
    (UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440301', '-', '')), NULL, 'SYSTEM_ADMIN', 'System Administrator', 'SYSTEM', NOW(), NOW(), NULL),
    (UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440302', '-', '')), UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440001', '-', '')), 'TENANT_ADMIN', 'Tenant Administrator', 'TENANT', NOW(), NOW(), NULL),
    (UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440303', '-', '')), UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440001', '-', '')), 'ORG_ADMIN', 'Organization Administrator', 'ORGANIZATION', NOW(), NOW(), NULL);

-- Permission ë°ì´í„°
INSERT INTO permissions (id, role_id, resource, action, created_at)
VALUES
    (UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440401', '-', '')), UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440301', '-', '')), 'USER', 'CREATE', NOW()),
    (UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440402', '-', '')), UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440301', '-', '')), 'USER', 'READ', NOW()),
    (UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440403', '-', '')), UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440301', '-', '')), 'USER', 'UPDATE', NOW()),
    (UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440404', '-', '')), UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440301', '-', '')), 'USER', 'DELETE', NOW());

-- UserRole ë°ì´í„°
INSERT INTO user_roles (id, user_id, role_id, scope, created_at)
VALUES
    (UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440501', '-', '')), UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440201', '-', '')), UNHEX(REPLACE('550e8400-e29b-41d4-a716-446655440303', '-', '')), 'ORG:550e8400-e29b-41d4-a716-446655440101', NOW());
```

---

### 2. Integration Test êµ¬í˜„ (ì£¼ìš” ì‹œë‚˜ë¦¬ì˜¤)

#### 2.1 Auth Integration Tests

```java
// AuthIntegrationTest.java
@DisplayName("Auth E2E í†µí•© í…ŒìŠ¤íŠ¸")
@Sql(scripts = "/sql/auth/auth-test-data.sql", executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD)
@Sql(scripts = "/sql/common/cleanup.sql", executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD)
public class AuthIntegrationTest extends IntegrationTestBase {

    @Test
    @DisplayName("ë¡œê·¸ì¸ ì„±ê³µ â†’ Access Token ë°œê¸‰ â†’ ê²€ì¦ ì„±ê³µ")
    void login_And_ValidateToken_Success() {
        // Given
        LoginRequestDto loginRequest = new LoginRequestDto("testuser", "Password123");

        // When - ë¡œê·¸ì¸
        ResponseEntity<LoginResponseDto> loginResponse = restTemplate.postForEntity(
            "/api/v1/auth/login",
            loginRequest,
            LoginResponseDto.class
        );

        // Then - ë¡œê·¸ì¸ ì„±ê³µ
        assertThat(loginResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(loginResponse.getBody()).isNotNull();
        assertThat(loginResponse.getBody().accessToken()).isNotBlank();
        assertThat(loginResponse.getBody().refreshToken()).isNotBlank();

        String accessToken = loginResponse.getBody().accessToken();

        // When - JWT ê²€ì¦
        ValidateTokenRequestDto validateRequest = new ValidateTokenRequestDto(accessToken);
        ResponseEntity<ValidateTokenResponseDto> validateResponse = restTemplate.postForEntity(
            "/api/v1/auth/validate",
            validateRequest,
            ValidateTokenResponseDto.class
        );

        // Then - ê²€ì¦ ì„±ê³µ
        assertThat(validateResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(validateResponse.getBody()).isNotNull();
        assertThat(validateResponse.getBody().userId()).isNotNull();
        assertThat(validateResponse.getBody().tenantId()).isNotNull();
        assertThat(validateResponse.getBody().organizationId()).isNotNull();
        assertThat(validateResponse.getBody().roles()).isNotEmpty();
        assertThat(validateResponse.getBody().permissions()).isNotEmpty();
    }

    @Test
    @DisplayName("ë¡œê·¸ì¸ â†’ Refresh Tokenìœ¼ë¡œ ì¬ë°œê¸‰ â†’ ê¸°ì¡´ í† í° ë¬´íš¨í™” (RTR)")
    void login_And_RefreshToken_RTR() {
        // Given - ë¡œê·¸ì¸
        LoginRequestDto loginRequest = new LoginRequestDto("testuser", "Password123");
        ResponseEntity<LoginResponseDto> loginResponse = restTemplate.postForEntity(
            "/api/v1/auth/login",
            loginRequest,
            LoginResponseDto.class
        );
        String oldRefreshToken = loginResponse.getBody().refreshToken();

        // When - Refresh Tokenìœ¼ë¡œ ì¬ë°œê¸‰
        RefreshTokenRequestDto refreshRequest = new RefreshTokenRequestDto(oldRefreshToken);
        ResponseEntity<RefreshTokenResponseDto> refreshResponse = restTemplate.postForEntity(
            "/api/v1/auth/refresh",
            refreshRequest,
            RefreshTokenResponseDto.class
        );

        // Then - ì¬ë°œê¸‰ ì„±ê³µ
        assertThat(refreshResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(refreshResponse.getBody()).isNotNull();
        assertThat(refreshResponse.getBody().accessToken()).isNotBlank();
        assertThat(refreshResponse.getBody().refreshToken()).isNotBlank();
        assertThat(refreshResponse.getBody().refreshToken()).isNotEqualTo(oldRefreshToken); // RTR: ìƒˆ í† í° ë°œê¸‰

        // When - ê¸°ì¡´ Refresh Tokenìœ¼ë¡œ ì¬ì‹œë„
        RefreshTokenRequestDto oldRefreshRequest = new RefreshTokenRequestDto(oldRefreshToken);
        ResponseEntity<ErrorResponseDto> errorResponse = restTemplate.postForEntity(
            "/api/v1/auth/refresh",
            oldRefreshRequest,
            ErrorResponseDto.class
        );

        // Then - ê¸°ì¡´ í† í° ë¬´íš¨í™”ë¨ (RTR)
        assertThat(errorResponse.getStatusCode()).isEqualTo(HttpStatus.UNAUTHORIZED);
    }

    @Test
    @DisplayName("ë¡œê·¸ì¸ â†’ ë¡œê·¸ì•„ì›ƒ â†’ Refresh Token ë¬´íš¨í™”")
    void login_And_Logout_Success() {
        // Given - ë¡œê·¸ì¸
        LoginRequestDto loginRequest = new LoginRequestDto("testuser", "Password123");
        ResponseEntity<LoginResponseDto> loginResponse = restTemplate.postForEntity(
            "/api/v1/auth/login",
            loginRequest,
            LoginResponseDto.class
        );
        String refreshToken = loginResponse.getBody().refreshToken();

        // When - ë¡œê·¸ì•„ì›ƒ
        LogoutRequestDto logoutRequest = new LogoutRequestDto(refreshToken);
        ResponseEntity<Void> logoutResponse = restTemplate.postForEntity(
            "/api/v1/auth/logout",
            logoutRequest,
            Void.class
        );

        // Then - ë¡œê·¸ì•„ì›ƒ ì„±ê³µ
        assertThat(logoutResponse.getStatusCode()).isEqualTo(HttpStatus.NO_CONTENT);

        // When - ë¡œê·¸ì•„ì›ƒ í›„ Refresh Token ì¬ì‚¬ìš© ì‹œë„
        RefreshTokenRequestDto refreshRequest = new RefreshTokenRequestDto(refreshToken);
        ResponseEntity<ErrorResponseDto> errorResponse = restTemplate.postForEntity(
            "/api/v1/auth/refresh",
            refreshRequest,
            ErrorResponseDto.class
        );

        // Then - ë¬´íš¨í™”ëœ í† í°
        assertThat(errorResponse.getStatusCode()).isEqualTo(HttpStatus.UNAUTHORIZED);
    }

    @Test
    @DisplayName("ì •ì§€ëœ ì‚¬ìš©ì ë¡œê·¸ì¸ ì‹¤íŒ¨")
    void login_SuspendedUser_Fails() {
        // Given - ì‚¬ìš©ì ì •ì§€ ì²˜ë¦¬
        jdbcTemplate.update(
            "UPDATE users SET status = 'SUSPENDED' WHERE username = 'testuser'"
        );

        // When - ë¡œê·¸ì¸ ì‹œë„
        LoginRequestDto loginRequest = new LoginRequestDto("testuser", "Password123");
        ResponseEntity<ErrorResponseDto> response = restTemplate.postForEntity(
            "/api/v1/auth/login",
            loginRequest,
            ErrorResponseDto.class
        );

        // Then - ë¡œê·¸ì¸ ì‹¤íŒ¨
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.FORBIDDEN);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().errorCode()).isEqualTo("U003");
    }

    @Test
    @DisplayName("ì •ì§€ëœ Tenantì˜ ì‚¬ìš©ì ë¡œê·¸ì¸ ì‹¤íŒ¨")
    void login_SuspendedTenant_Fails() {
        // Given - Tenant ì •ì§€ ì²˜ë¦¬
        jdbcTemplate.update(
            "UPDATE tenants SET status = 'SUSPENDED' WHERE name = 'Test Tenant'"
        );

        // When - ë¡œê·¸ì¸ ì‹œë„
        LoginRequestDto loginRequest = new LoginRequestDto("testuser", "Password123");
        ResponseEntity<ErrorResponseDto> response = restTemplate.postForEntity(
            "/api/v1/auth/login",
            loginRequest,
            ErrorResponseDto.class
        );

        // Then - ë¡œê·¸ì¸ ì‹¤íŒ¨
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.FORBIDDEN);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().errorCode()).isEqualTo("T002");
    }
}
```

#### 2.2 User Integration Tests

```java
// UserIntegrationTest.java
@DisplayName("User E2E í†µí•© í…ŒìŠ¤íŠ¸")
@Sql(scripts = "/sql/user/user-test-data.sql", executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD)
@Sql(scripts = "/sql/common/cleanup.sql", executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD)
public class UserIntegrationTest extends IntegrationTestBase {

    @Test
    @DisplayName("ì‚¬ìš©ì ìƒì„± â†’ ì¡°íšŒ â†’ ìˆ˜ì • â†’ ì‚­ì œ ì „ì²´ í”Œë¡œìš°")
    void userLifecycle_CreateReadUpdateDelete() {
        // Given - ì‚¬ìš©ì ìƒì„± ìš”ì²­
        CreateUserRequestDto createRequest = new CreateUserRequestDto(
            UUID.fromString("550e8400-e29b-41d4-a716-446655440001"), // tenantId
            UUID.fromString("550e8400-e29b-41d4-a716-446655440101"), // organizationId
            "newuser",
            "newuser@example.com",
            "Password123",
            "+821087654321"
        );

        // When - ì‚¬ìš©ì ìƒì„±
        ResponseEntity<CreateUserResponseDto> createResponse = restTemplate.postForEntity(
            "/api/v1/users",
            createRequest,
            CreateUserResponseDto.class
        );

        // Then - ìƒì„± ì„±ê³µ
        assertThat(createResponse.getStatusCode()).isEqualTo(HttpStatus.CREATED);
        assertThat(createResponse.getBody()).isNotNull();
        UUID userId = createResponse.getBody().id();

        // When - ì‚¬ìš©ì ì¡°íšŒ
        ResponseEntity<GetUserResponseDto> getResponse = restTemplate.getForEntity(
            "/api/v1/users/" + userId,
            GetUserResponseDto.class
        );

        // Then - ì¡°íšŒ ì„±ê³µ
        assertThat(getResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(getResponse.getBody()).isNotNull();
        assertThat(getResponse.getBody().username()).isEqualTo("newuser");

        // When - ì‚¬ìš©ì ìˆ˜ì •
        UpdateUserRequestDto updateRequest = new UpdateUserRequestDto(
            "updated@example.com",
            "+821011112222"
        );
        HttpEntity<UpdateUserRequestDto> updateEntity = new HttpEntity<>(updateRequest);
        ResponseEntity<UpdateUserResponseDto> updateResponse = restTemplate.exchange(
            "/api/v1/users/" + userId,
            HttpMethod.PUT,
            updateEntity,
            UpdateUserResponseDto.class
        );

        // Then - ìˆ˜ì • ì„±ê³µ
        assertThat(updateResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(updateResponse.getBody()).isNotNull();
        assertThat(updateResponse.getBody().email()).isEqualTo("updated@example.com");

        // When - ì‚¬ìš©ì ì‚­ì œ
        ResponseEntity<Void> deleteResponse = restTemplate.exchange(
            "/api/v1/users/" + userId,
            HttpMethod.DELETE,
            null,
            Void.class
        );

        // Then - ì‚­ì œ ì„±ê³µ (Soft Delete)
        assertThat(deleteResponse.getStatusCode()).isEqualTo(HttpStatus.NO_CONTENT);

        // ì‚­ì œ í›„ ì¡°íšŒ ì‹œ NOT_FOUND
        ResponseEntity<ErrorResponseDto> getAfterDeleteResponse = restTemplate.getForEntity(
            "/api/v1/users/" + userId,
            ErrorResponseDto.class
        );
        assertThat(getAfterDeleteResponse.getStatusCode()).isEqualTo(HttpStatus.NOT_FOUND);
    }

    @Test
    @DisplayName("ì¤‘ë³µëœ usernameìœ¼ë¡œ ì‚¬ìš©ì ìƒì„± ì‹¤íŒ¨")
    void createUser_DuplicateUsername_Fails() {
        // Given
        CreateUserRequestDto request = new CreateUserRequestDto(
            UUID.fromString("550e8400-e29b-41d4-a716-446655440001"),
            UUID.fromString("550e8400-e29b-41d4-a716-446655440101"),
            "testuser", // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” username
            "newemail@example.com",
            "Password123",
            "+821099998888"
        );

        // When
        ResponseEntity<ErrorResponseDto> response = restTemplate.postForEntity(
            "/api/v1/users",
            request,
            ErrorResponseDto.class
        );

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.CONFLICT);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().errorCode()).isEqualTo("U006");
    }

    @Test
    @DisplayName("ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ (í˜ì´ì§•)")
    void searchUsers_Pagination_Success() {
        // When
        ResponseEntity<PagedResponseDto<UserListItemDto>> response = restTemplate.getForEntity(
            "/api/v1/users?page=0&size=10",
            new ParameterizedTypeReference<PagedResponseDto<UserListItemDto>>() {}
        );

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().content()).isNotEmpty();
        assertThat(response.getBody().totalElements()).isGreaterThan(0);
    }
}
```

#### 2.3 Organization Integration Tests

```java
// OrganizationIntegrationTest.java
@DisplayName("Organization E2E í†µí•© í…ŒìŠ¤íŠ¸")
@Sql(scripts = "/sql/organization/organization-test-data.sql", executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD)
@Sql(scripts = "/sql/common/cleanup.sql", executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD)
public class OrganizationIntegrationTest extends IntegrationTestBase {

    @Test
    @DisplayName("ì¡°ì§ ìƒì„± â†’ ì¡°íšŒ â†’ ìˆ˜ì • â†’ ì‚­ì œ ì „ì²´ í”Œë¡œìš°")
    void organizationLifecycle_CreateReadUpdateDelete() {
        // Given - ì¡°ì§ ìƒì„± ìš”ì²­
        CreateOrganizationRequestDto createRequest = new CreateOrganizationRequestDto(
            UUID.fromString("550e8400-e29b-41d4-a716-446655440001"),
            "New Organization"
        );

        // When - ì¡°ì§ ìƒì„±
        ResponseEntity<CreateOrganizationResponseDto> createResponse = restTemplate.postForEntity(
            "/api/v1/organizations",
            createRequest,
            CreateOrganizationResponseDto.class
        );

        // Then - ìƒì„± ì„±ê³µ
        assertThat(createResponse.getStatusCode()).isEqualTo(HttpStatus.CREATED);
        UUID organizationId = createResponse.getBody().id();

        // When - ì¡°ì§ ì¡°íšŒ
        ResponseEntity<GetOrganizationResponseDto> getResponse = restTemplate.getForEntity(
            "/api/v1/organizations/" + organizationId,
            GetOrganizationResponseDto.class
        );

        // Then - ì¡°íšŒ ì„±ê³µ
        assertThat(getResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(getResponse.getBody().name()).isEqualTo("New Organization");

        // When - ì¡°ì§ ìˆ˜ì •
        UpdateOrganizationRequestDto updateRequest = new UpdateOrganizationRequestDto("Updated Organization");
        HttpEntity<UpdateOrganizationRequestDto> updateEntity = new HttpEntity<>(updateRequest);
        ResponseEntity<UpdateOrganizationResponseDto> updateResponse = restTemplate.exchange(
            "/api/v1/organizations/" + organizationId,
            HttpMethod.PUT,
            updateEntity,
            UpdateOrganizationResponseDto.class
        );

        // Then - ìˆ˜ì • ì„±ê³µ
        assertThat(updateResponse.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(updateResponse.getBody().name()).isEqualTo("Updated Organization");

        // When - ì¡°ì§ ì‚­ì œ (í•˜ìœ„ ì‚¬ìš©ì ì—†ìŒ)
        ResponseEntity<Void> deleteResponse = restTemplate.exchange(
            "/api/v1/organizations/" + organizationId,
            HttpMethod.DELETE,
            null,
            Void.class
        );

        // Then - ì‚­ì œ ì„±ê³µ
        assertThat(deleteResponse.getStatusCode()).isEqualTo(HttpStatus.NO_CONTENT);
    }

    @Test
    @DisplayName("í•˜ìœ„ ì‚¬ìš©ì ì¡´ì¬ ì‹œ ì¡°ì§ ì‚­ì œ ì‹¤íŒ¨")
    void deleteOrganization_WithUsers_Fails() {
        // Given - ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ëŠ” ì¡°ì§
        UUID organizationId = UUID.fromString("550e8400-e29b-41d4-a716-446655440101");

        // When - ì¡°ì§ ì‚­ì œ ì‹œë„
        ResponseEntity<ErrorResponseDto> response = restTemplate.exchange(
            "/api/v1/organizations/" + organizationId,
            HttpMethod.DELETE,
            null,
            ErrorResponseDto.class
        );

        // Then - ì‚­ì œ ì‹¤íŒ¨
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.CONFLICT);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().errorCode()).isEqualTo("O002");
    }
}
```

#### 2.4 Role & Permission Integration Tests

```java
// RoleIntegrationTest.java
@DisplayName("Role & Permission E2E í†µí•© í…ŒìŠ¤íŠ¸")
@Sql(scripts = "/sql/role/role-test-data.sql", executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD)
@Sql(scripts = "/sql/common/cleanup.sql", executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD)
public class RoleIntegrationTest extends IntegrationTestBase {

    @Test
    @DisplayName("ì—­í•  í• ë‹¹ â†’ ê¶Œí•œ ì¡°íšŒ â†’ Redis ìºì‹± í™•ì¸")
    void assignRole_And_GetPermissions_WithCache() {
        // Given
        UUID userId = UUID.fromString("550e8400-e29b-41d4-a716-446655440201");
        UUID roleId = UUID.fromString("550e8400-e29b-41d4-a716-446655440302"); // TENANT_ADMIN

        AssignRoleRequestDto assignRequest = new AssignRoleRequestDto(
            userId,
            roleId,
            "TENANT:550e8400-e29b-41d4-a716-446655440001"
        );

        // When - ì—­í•  í• ë‹¹
        ResponseEntity<Void> assignResponse = restTemplate.postForEntity(
            "/api/v1/roles/assign",
            assignRequest,
            Void.class
        );

        // Then - í• ë‹¹ ì„±ê³µ
        assertThat(assignResponse.getStatusCode()).isEqualTo(HttpStatus.NO_CONTENT);

        // When - ê¶Œí•œ ì¡°íšŒ (1ì°¨: DB ì¡°íšŒ)
        long startTime1 = System.currentTimeMillis();
        ResponseEntity<GetUserPermissionsResponseDto> response1 = restTemplate.getForEntity(
            "/api/v1/roles/users/" + userId + "/permissions",
            GetUserPermissionsResponseDto.class
        );
        long duration1 = System.currentTimeMillis() - startTime1;

        // Then - ì¡°íšŒ ì„±ê³µ
        assertThat(response1.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response1.getBody()).isNotNull();
        assertThat(response1.getBody().permissions()).isNotEmpty();

        // When - ê¶Œí•œ ì¡°íšŒ (2ì°¨: Redis ìºì‹œ ì¡°íšŒ)
        long startTime2 = System.currentTimeMillis();
        ResponseEntity<GetUserPermissionsResponseDto> response2 = restTemplate.getForEntity(
            "/api/v1/roles/users/" + userId + "/permissions",
            GetUserPermissionsResponseDto.class
        );
        long duration2 = System.currentTimeMillis() - startTime2;

        // Then - ìºì‹œ íˆíŠ¸ (ë” ë¹ ë¦„)
        assertThat(response2.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(duration2).isLessThan(duration1); // ìºì‹œê°€ ë” ë¹ ë¦„
    }

    @Test
    @DisplayName("ì—­í•  ì œê±° â†’ Redis ìºì‹œ ë¬´íš¨í™” â†’ DB ì¬ì¡°íšŒ")
    void revokeRole_And_InvalidateCache() {
        // Given - ì—­í•  í• ë‹¹ëœ ì‚¬ìš©ì
        UUID userId = UUID.fromString("550e8400-e29b-41d4-a716-446655440201");
        UUID roleId = UUID.fromString("550e8400-e29b-41d4-a716-446655440303"); // ORG_ADMIN

        // When - ê¶Œí•œ ì¡°íšŒ (ìºì‹±)
        restTemplate.getForEntity(
            "/api/v1/roles/users/" + userId + "/permissions",
            GetUserPermissionsResponseDto.class
        );

        // When - ì—­í•  ì œê±°
        RevokeRoleRequestDto revokeRequest = new RevokeRoleRequestDto(userId, roleId);
        ResponseEntity<Void> revokeResponse = restTemplate.postForEntity(
            "/api/v1/roles/revoke",
            revokeRequest,
            Void.class
        );

        // Then - ì œê±° ì„±ê³µ
        assertThat(revokeResponse.getStatusCode()).isEqualTo(HttpStatus.NO_CONTENT);

        // When - ê¶Œí•œ ì¬ì¡°íšŒ (ìºì‹œ ë¬´íš¨í™” í›„)
        ResponseEntity<GetUserPermissionsResponseDto> response = restTemplate.getForEntity(
            "/api/v1/roles/users/" + userId + "/permissions",
            GetUserPermissionsResponseDto.class
        );

        // Then - ì—­í•  ì œê±°ëœ ê¶Œí•œ ëª©ë¡
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody().permissions()).doesNotContain("ORG_ADMIN");
    }
}
```

---

## âœ… Zero-Tolerance Rules Checklist

### Integration Test í•„ìˆ˜ ê·œì¹™

- [ ] **Testcontainers ì‚¬ìš©**: MySQL/Redis ê²©ë¦¬ í™˜ê²½
- [ ] **@Sql ë°ì´í„° ì¤€ë¹„**: ê° í…ŒìŠ¤íŠ¸ë§ˆë‹¤ ë…ë¦½ì ì¸ ë°ì´í„°
- [ ] **Cleanup**: í…ŒìŠ¤íŠ¸ í›„ ë°ì´í„° ì •ë¦¬
- [ ] **Flyway Migration ê²€ì¦**: ì‹¤ì œ ìŠ¤í‚¤ë§ˆ ì ìš© í™•ì¸
- [ ] **E2E í”Œë¡œìš° ê²€ì¦**: ì „ì²´ ë ˆì´ì–´ í†µí•© ê²€ì¦
- [ ] **Redis ìºì‹± ê²€ì¦**: ìºì‹œ íˆíŠ¸/ë¯¸ìŠ¤ í™•ì¸
- [ ] **RTR ê²€ì¦**: Refresh Token Rotation ë™ì‘ í™•ì¸

### Test Coverage ëª©í‘œ
- **ì£¼ìš” ì‹œë‚˜ë¦¬ì˜¤**: 100% (ë¡œê·¸ì¸, CRUD, ê¶Œí•œ ê´€ë¦¬)
- **Edge Cases**: 90% ì´ìƒ (ì˜ˆì™¸ ìƒí™©, ê²½ê³„ ì¡°ê±´)

---

## ğŸ¯ Completion Criteria

### 1. êµ¬í˜„ ì™„ë£Œ ì¡°ê±´
- [ ] Auth Integration Tests ì™„ë£Œ (5ê°œ ì‹œë‚˜ë¦¬ì˜¤)
- [ ] User Integration Tests ì™„ë£Œ (7ê°œ ì‹œë‚˜ë¦¬ì˜¤)
- [ ] Organization Integration Tests ì™„ë£Œ (5ê°œ ì‹œë‚˜ë¦¬ì˜¤)
- [ ] Role & Permission Integration Tests ì™„ë£Œ (4ê°œ ì‹œë‚˜ë¦¬ì˜¤)
- [ ] Testcontainers í™˜ê²½ êµ¬ì„± ì™„ë£Œ
- [ ] @Sql í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ
- [ ] ëª¨ë“  Integration Tests í†µê³¼

### 2. Code Review Checklist
- [ ] Testcontainers ì ì ˆíˆ ì‚¬ìš© í™•ì¸
- [ ] @Sql ë°ì´í„° ë…ë¦½ì„± í™•ì¸
- [ ] E2E í”Œë¡œìš° ê²€ì¦ ì™„ì „ì„± í™•ì¸
- [ ] Redis ìºì‹± ë™ì‘ ê²€ì¦ í™•ì¸
- [ ] RTR ë™ì‘ ê²€ì¦ í™•ì¸

---

## ğŸ“š Related Documents

- [Integration Testing Guide](../../docs/coding_convention/05-testing/integration-testing/01_integration-testing-overview.md)
- [Flyway Configuration](../../docs/coding_convention/04-persistence-layer/mysql/config/flyway-testing.md)
- [PRD: B2B AuthHub](../b2b-auth-hub.md)

---

## ğŸ”„ Kent Beck TDD Commands

```bash
# Integration Test TDD ì‚¬ì´í´ ì‹¤í–‰
/kb/integration/go          # Plan íŒŒì¼ ê¸°ë°˜ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
/kb/integration/red         # Red: test: ì»¤ë°‹
/kb/integration/green       # Green: feat: ì»¤ë°‹
/kb/integration/refactor    # Refactor: struct: ì»¤ë°‹
```

# AUT-006: INTERNAL User ë“±ë¡

**Epic**: IAM Platform (AuthHub)
**Feature**: INTERNAL User ë“±ë¡ (Email + Password)
**Phase**: Phase 1 - Core Authentication
**ë¸Œëœì¹˜**: feature/AUT-006-internal-user-registration
**ì˜ì¡´ì„±**: AUT-000, AUT-001 (User Aggregate, Credential VO), AUT-005 (Organization)

---

## ğŸ“ ëª©ì 

INTERNAL ì‚¬ìš©ì ë“±ë¡ ê¸°ëŠ¥ êµ¬í˜„ (Email + Password)
- SUPER_ADMIN ë˜ëŠ” ORG_ADMINë§Œ ë“±ë¡ ê°€ëŠ¥
- Organization í•„ìˆ˜ (organizationId != null)
- ì´ë©”ì¼ ê¸°ë°˜ Credential ìƒì„±
- ì†Œì…œ ë¡œê·¸ì¸ ë¶ˆê°€ (ì´ë©”ì¼+ë¹„ë°€ë²ˆí˜¸ ì „ìš©)

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 Credential VO í™•ì¥ (AUT-001ì—ì„œ ì •ì˜ë¨)
- [ ] **Credential VOì— ì¶”ê°€**:
  - `ofEmail(Email email, String rawPassword, ClockHolder clockHolder)` â†’ Credential
  - `validateEmail()` â†’ void (ì´ë©”ì¼ í˜•ì‹ ê²€ì¦)

**ê¸°ì¡´ Credential VO êµ¬ì¡°**:
```java
public record Credential(
    Email email,                    // ì´ë©”ì¼ (INTERNAL ì‚¬ìš©ì í•„ìˆ˜, PUBLIC ì‚¬ìš©ì ì„ íƒ)
    PhoneNumber phoneNumber,        // ì „í™”ë²ˆí˜¸ (PUBLIC ì‚¬ìš©ì í•„ìˆ˜)
    String password,                // BCrypt í•´ì‹œ
    CredentialType credentialType,  // PHONE, EMAIL, SOCIAL
    boolean phoneLoginEnabled,      // ì „í™”ë²ˆí˜¸ ë¡œê·¸ì¸ ê°€ëŠ¥ ì—¬ë¶€
    boolean emailLoginEnabled,      // ì´ë©”ì¼ ë¡œê·¸ì¸ ê°€ëŠ¥ ì—¬ë¶€
    LocalDateTime createdAt,
    LocalDateTime updatedAt
) {
    // ì´ë©”ì¼ ê¸°ë°˜ Credential ìƒì„± (NEW)
    public static Credential ofEmail(Email email, String rawPassword, ClockHolder clockHolder) {
        return new Credential(
            email,
            null,  // phoneNumberëŠ” null
            BCrypt.hashpw(rawPassword, BCrypt.gensalt()),
            CredentialType.EMAIL,
            false,  // phoneLoginEnabled = false
            true,   // emailLoginEnabled = true
            clockHolder.now(),
            clockHolder.now()
        );
    }
}
```

#### 1.2 Email VO í™•ì¥ (AUT-001ì—ì„œ ì •ì˜ë¨)
- [ ] **Email VO ê²€ì¦ ê°•í™”**:
  - RFC 5322 í˜•ì‹ ê²€ì¦
  - ë„ë©”ì¸ í˜•ì‹ ê²€ì¦ (ì˜ˆ: @example.com)

#### 1.3 Domain Exception
- [ ] **EmailAlreadyInUseException** (ì´ë©”ì¼ ì¤‘ë³µ)
- [ ] **InvalidEmailFormatException** (ì´ë©”ì¼ í˜•ì‹ ì˜¤ë¥˜)
- [ ] **InsufficientPermissionException** (SUPER_ADMIN, ORG_ADMIN ì•„ë‹˜)
- [ ] **OrganizationRequiredException** (INTERNAL ì‚¬ìš©ìëŠ” Organization í•„ìˆ˜)

#### 1.4 Domain Event
- [ ] **InternalUserRegistered** Event
  - userId, tenantId, organizationId, email, registeredBy, registeredAt

---

### 2. Application Layer

#### 2.1 RegisterInternalUserUseCase (Command)
- [ ] **Input**: RegisterInternalUserCommand
  - tenantId (Long)
  - organizationId (Long, í•„ìˆ˜)
  - email (String, @Email)
  - password (String, @Size(min=8))
  - name (String)
  - registeredBy (Long, SUPER_ADMIN ë˜ëŠ” ORG_ADMIN userId)

- [ ] **Output**: UserResponse
  - userId (Long)
  - userType (String, INTERNAL)
  - email (String)
  - name (String)
  - organizationId (Long)
  - status (String, ACTIVE)
  - createdAt (LocalDateTime)

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. ê¶Œí•œ ê²€ì¦ (registeredByê°€ SUPER_ADMIN ë˜ëŠ” ORG_ADMINì¸ì§€ í™•ì¸)
  2. ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ (CheckDuplicateEmailPort)
  3. Organization ì¡´ì¬ í™•ì¸ (LoadOrganizationPort, AUT-008)
  4. User.registerInternal (Domain Layer)
     - userType = INTERNAL
     - organizationId = í•„ìˆ˜
     - Credential.ofEmail ì‚¬ìš©
  5. User ì €ì¥ (SaveUserPort)
  6. InternalUserRegistered Event ë°œí–‰

#### 2.2 Port ì •ì˜
- [ ] **CheckDuplicateEmailPort** (Out):
  - exists(Email) â†’ Boolean

- [ ] **LoadOrganizationPort** (Out):
  - load(Long organizationId) â†’ Organization

**ì¬ì‚¬ìš© Port**:
- SaveUserPort (AUT-001ì—ì„œ ì •ì˜ë¨)

---

### 3. Persistence Layer

**ê¸°ì¡´ Repository ë° Adapter ì¬ì‚¬ìš©** (AUT-001ì—ì„œ êµ¬í˜„ë¨)
- UserEntity, UserJpaRepository, UserPersistenceAdapter

#### 3.1 UserJpaRepository í™•ì¥
- [ ] **existsByEmail(String email) â†’ Boolean** ì¶”ê°€

---

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/auth/register/internal**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 201 Created
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN ë˜ëŠ” ORG_ADMIN)

#### 4.2 Request DTO
- [ ] **RegisterInternalUserRequest**:
  - organizationId (Long, @NotNull)
  - email (String, @NotBlank, @Email)
  - password (String, @NotBlank, @Size(min=8), @Pattern(ì •ê·œì‹))
  - name (String, @NotBlank, @Size(min=1, max=50))

**ë¹„ë°€ë²ˆí˜¸ ì •ê·œì‹**:
- ìµœì†Œ 8ì ì´ìƒ
- ì˜ë¬¸ ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¤‘ 2ê°€ì§€ ì´ìƒ ì¡°í•©

#### 4.3 Response DTO
- [ ] **UserResponse** (ì¬ì‚¬ìš©, AUT-001)

#### 4.4 Controller
- [ ] **AuthController**:
  - registerInternalUser(@Valid RegisterInternalUserRequest, @AuthenticationPrincipal requestedBy) â†’ ResponseEntity<UserResponse>

#### 4.5 Error Handling
- [ ] **EmailAlreadyInUseException** â†’ HTTP 409 Conflict, "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤"
- [ ] **InvalidEmailFormatException** â†’ HTTP 400 Bad Request, "ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤"
- [ ] **InsufficientPermissionException** â†’ HTTP 403 Forbidden, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"
- [ ] **OrganizationRequiredException** â†’ HTTP 400 Bad Request, "INTERNAL ì‚¬ìš©ìëŠ” Organizationì´ í•„ìˆ˜ì…ë‹ˆë‹¤"

---

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ INTERNAL ì‚¬ìš©ì ë“±ë¡ (SUPER_ADMIN)**:
  - Given: SUPER_ADMIN ë¡œê·¸ì¸, ìœ íš¨í•œ Organization
  - When: POST /api/v1/auth/register/internal
  - Then:
    - HTTP 201, UserResponse ë°˜í™˜
    - DB í™•ì¸: users.user_type = INTERNAL, organization_id != null
    - DB í™•ì¸: users.email = "admin@company.com"
    - DB í™•ì¸: credential.credential_type = EMAIL, email_login_enabled = true
    - Event í™•ì¸: InternalUserRegistered ë°œí–‰

- [ ] **ì •ìƒ INTERNAL ì‚¬ìš©ì ë“±ë¡ (ORG_ADMIN)**:
  - Given: ORG_ADMIN ë¡œê·¸ì¸ (organizationId = 1)
  - When: POST /api/v1/auth/register/internal (organizationId = 1)
  - Then:
    - HTTP 201 ì„±ê³µ
    - ìì‹ ì˜ Organizationì—ë§Œ ë“±ë¡ ê°€ëŠ¥

- [ ] **ì´ë©”ì¼ ì¤‘ë³µ ì‹œë„**:
  - Given: ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼ (admin@company.com)
  - When: POST /api/v1/auth/register/internal (ê°™ì€ ì´ë©”ì¼)
  - Then: HTTP 409, "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤"

- [ ] **Organization ì—†ì´ ë“±ë¡ ì‹œë„**:
  - Given: SUPER_ADMIN ë¡œê·¸ì¸
  - When: POST /api/v1/auth/register/internal (organizationId = null)
  - Then: HTTP 400, "INTERNAL ì‚¬ìš©ìëŠ” Organizationì´ í•„ìˆ˜ì…ë‹ˆë‹¤"

- [ ] **ê¶Œí•œ ì—†ëŠ” ë“±ë¡ ì‹œë„**:
  - Given: ì¼ë°˜ PUBLIC ì‚¬ìš©ì ë¡œê·¸ì¸
  - When: POST /api/v1/auth/register/internal
  - Then: HTTP 403, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

- [ ] **ë¹„ë°€ë²ˆí˜¸ ì •ì±… ìœ„ë°˜**:
  - Given: SUPER_ADMIN ë¡œê·¸ì¸
  - When: POST /api/v1/auth/register/internal (password = "1234") â†’ 8ì ë¯¸ë§Œ
  - Then: HTTP 400, "ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤"

- [ ] **ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹**:
  - Given: SUPER_ADMIN ë¡œê·¸ì¸
  - When: POST /api/v1/auth/register/internal (email = "invalid-email")
  - Then: HTTP 400, "ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤"

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V4 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **SUPER_ADMIN, ORG_ADMIN ì‚¬ìš©ì**: INTERNAL ì‚¬ìš©ì + ê° ê¶Œí•œ
- [ ] **Organization ë°ì´í„°**: organizationId = 1, 2

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Tell Don't Ask** - User.registerInternal, Credential.ofEmail ì‚¬ìš©
- [ ] **Long FK ì „ëµ** - UserEntityì— `private Long organizationId` (JPA ê´€ê³„ ì–´ë…¸í…Œì´ì…˜ ê¸ˆì§€)

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (ê¸°ë³¸ êµ¬ì¡°)
  - AUT-001 (User Aggregate, Credential VO, User ë“±ë¡)
  - AUT-008 (Organization ê´€ë¦¬, LoadOrganizationPort)

### ë³´ì•ˆ ê·œì¹™
- [ ] **SUPER_ADMIN, ORG_ADMIN ì „ìš©** - INTERNAL ì‚¬ìš©ì ë“±ë¡ ê¶Œí•œ ì œí•œ
- [ ] **Organization í•„ìˆ˜** - INTERNAL ì‚¬ìš©ìëŠ” ë°˜ë“œì‹œ Organization ì†Œì†
- [ ] **ì†Œì…œ ë¡œê·¸ì¸ ë¶ˆê°€** - INTERNAL ì‚¬ìš©ìëŠ” ì´ë©”ì¼+ë¹„ë°€ë²ˆí˜¸ë§Œ ì‚¬ìš©

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: Credential.ofEmail, Email VO ê²€ì¦
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (Credential.ofEmail, Email VO í™•ì¥)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (RegisterInternalUserUseCase)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (existsByEmail ì¶”ê°€)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (AuthController)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 7ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **ì´ë©”ì¼ ì¤‘ë³µ ê²€ì¦ ì™„ë£Œ**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (2.1.1 RegisterInternalUserUseCase)
- **Plan**: docs/prd/plans/AUT-001.5-internal-user-registration-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-59

# AUT-019: User ì‚­ì œ

**Epic**: IAM Platform (AuthHub)
**Feature**: User ì‚­ì œ
**Phase**: Phase 4 - User Management
**ë¸Œëœì¹˜**: feature/AUT-019-user-deletion
**ì˜ì¡´ì„±**: AUT-000, AUT-001 (User Aggregate), AUT-003 (Refresh Token)

---

## ğŸ“ ëª©ì 

ì‚¬ìš©ì ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„ (Soft Delete)
- User ì‚­ì œ (status = DELETED)
- ê´€ë ¨ ë°ì´í„° ì²˜ë¦¬ (Refresh Token íê¸°, ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹)
- ì‚­ì œ ì·¨ì†Œ ë¶ˆê°€ (ìµœì¢… ìƒíƒœ)

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 User Aggregate í™•ì¥
- [ ] **User Aggregateì— ì¶”ê°€**:
  - `delete()` â†’ void (status = DELETED)
  - `maskPersonalData()` â†’ void (ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ ë§ˆìŠ¤í‚¹)
  - `canBeDeleted()` â†’ boolean (ê²€ì¦ ë¡œì§)

#### 1.2 Domain Exception
- [ ] **UserAlreadyDeletedException** (ì´ë¯¸ ì‚­ì œëœ User)
- [ ] **UserDeletionNotAllowedException** (ì‚­ì œ ë¶ˆê°€ ì¡°ê±´)

#### 1.3 Domain Event
- [ ] **UserDeleted** Event
  - userId, deletedBy, deletedAt

### 2. Application Layer

#### 2.1 DeleteUserUseCase (Command)
- [ ] **Input**: DeleteUserCommand
  - userId (Long)
  - requestedBy (Long, SUPER_ADMIN userId)

- [ ] **Output**: void

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. SUPER_ADMIN ê¶Œí•œ ê²€ì¦ (LoadUserPort)
  2. User ì¡°íšŒ (LoadUserPort)
  3. User.canBeDeleted() ê²€ì¦
     - ì´ë¯¸ DELETED ìƒíƒœì¸ì§€ í™•ì¸
  4. ëª¨ë“  Refresh Token íê¸° (DeleteAllRefreshTokensByUserIdPort)
  5. ëª¨ë“  SocialAccount ì‚­ì œ (DeleteAllSocialAccountsByUserIdPort)
  6. ëª¨ë“  UserRole ì‚­ì œ (DeleteAllUserRolesByUserIdPort)
  7. User.delete() (status = DELETED)
  8. User.maskPersonalData() (ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹)
     - phoneNumber â†’ "***-****-****"
     - email â†’ "deleted@example.com"
     - name â†’ "Deleted User"
  9. User ì €ì¥ (SaveUserPort)
  10. UserDeleted Event ë°œí–‰

#### 2.2 Port ì •ì˜
- [ ] **DeleteAllSocialAccountsByUserIdPort** (Out):
  - deleteAll(Long userId) â†’ void

- [ ] **DeleteAllUserRolesByUserIdPort** (Out):
  - deleteAll(Long userId) â†’ void

- [ ] **DeleteAllRefreshTokensByUserIdPort** (Out, AUT-003ì—ì„œ ì •ì˜ë¨):
  - deleteAll(Long userId) â†’ void

### 3. Persistence Layer

**ê¸°ì¡´ Repository ì¬ì‚¬ìš©** (AUT-001, AUT-003, AUT-005, AUT-011ì—ì„œ êµ¬í˜„ë¨)

- [ ] **SocialAccountJpaRepository í™•ì¥**:
  - deleteAllByUserId(Long userId) â†’ void

- [ ] **UserRoleJpaRepository í™•ì¥**:
  - deleteAllByUserId(Long userId) â†’ void

#### 3.1 Adapter í™•ì¥
- [ ] **SocialAccountPersistenceAdapter** (DeleteAllSocialAccountsByUserIdPort êµ¬í˜„)

- [ ] **UserRolePersistenceAdapter** (DeleteAllUserRolesByUserIdPort êµ¬í˜„)

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **DELETE /api/v1/users/{userId}**
  - HTTP Method: DELETE
  - Response: HTTP 204 No Content
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN)

#### 4.2 Controller
- [ ] **UserController**:
  - deleteUser(@PathVariable Long userId, @AuthenticationPrincipal requestedBy) â†’ ResponseEntity<Void>

#### 4.3 Error Handling
- [ ] **UserAlreadyDeletedException** â†’ HTTP 400, "ì´ë¯¸ ì‚­ì œëœ ì‚¬ìš©ìì…ë‹ˆë‹¤"
- [ ] **UserDeletionNotAllowedException** â†’ HTTP 400, "ì‚¬ìš©ì ì‚­ì œê°€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
- [ ] **UnauthorizedException** (SUPER_ADMIN ì•„ë‹˜) â†’ HTTP 403, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ User ì‚­ì œ**:
  - Given: SUPER_ADMIN ë¡œê·¸ì¸, ACTIVE ìƒíƒœ User
  - When: DELETE /api/v1/users/{userId}
  - Then:
    - HTTP 204
    - DB í™•ì¸:
      - users.status = DELETED
      - users.phone_number = "***-****-****"
      - users.email = "deleted@example.com"
      - users.name = "Deleted User"
    - DB í™•ì¸: refresh_tokens í…Œì´ë¸”ì—ì„œ í•´ë‹¹ Userì˜ í† í° ì‚­ì œ
    - DB í™•ì¸: social_accounts í…Œì´ë¸”ì—ì„œ í•´ë‹¹ Userì˜ ê³„ì • ì‚­ì œ
    - DB í™•ì¸: user_roles í…Œì´ë¸”ì—ì„œ í•´ë‹¹ Userì˜ Role ì‚­ì œ
    - Event í™•ì¸: UserDeleted ë°œí–‰

- [ ] **ì´ë¯¸ ì‚­ì œëœ User ì‚­ì œ ì‹œë„**:
  - Given: DELETED ìƒíƒœ User
  - When: DELETE /api/v1/users/{userId}
  - Then: HTTP 400, "ì´ë¯¸ ì‚­ì œëœ ì‚¬ìš©ìì…ë‹ˆë‹¤"

- [ ] **ê¶Œí•œ ì—†ëŠ” ì‚­ì œ ì‹œë„ (ORG_ADMIN)**:
  - Given: ORG_ADMIN ë¡œê·¸ì¸ (SUPER_ADMIN ì•„ë‹˜)
  - When: DELETE /api/v1/users/{userId}
  - Then: HTTP 403, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

- [ ] **ì‚­ì œëœ User ì¡°íšŒ ì‹œë„**:
  - Given: DELETED ìƒíƒœ User
  - When: GET /api/v1/users/{userId}
  - Then: HTTP 404, "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" (ë˜ëŠ” DELETED ìƒíƒœ ì •ë³´ ë°˜í™˜)

- [ ] **ì‚­ì œëœ User ë¡œê·¸ì¸ ì‹œë„**:
  - Given: DELETED ìƒíƒœ User
  - When: POST /api/v1/auth/login/phone (ì˜¬ë°”ë¥¸ ë¹„ë°€ë²ˆí˜¸)
  - Then: HTTP 401, "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" (AUT-002 í†µí•©)

- [ ] **ì‚­ì œ í›„ ê´€ë ¨ ë°ì´í„° í™•ì¸**:
  - Given: User ì‚­ì œ ì™„ë£Œ
  - When: ê´€ë ¨ ë°ì´í„° ì¡°íšŒ
  - Then:
    - refresh_tokens: 0ê±´ (ëª¨ë‘ ì‚­ì œ)
    - social_accounts: 0ê±´ (ëª¨ë‘ ì‚­ì œ)
    - user_roles: 0ê±´ (ëª¨ë‘ ì‚­ì œ)

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V17 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **SUPER_ADMIN ì‚¬ìš©ì**: INTERNAL ì‚¬ìš©ì + SUPER_ADMIN ê¶Œí•œ

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Tell Don't Ask** - User.delete, maskPersonalData, canBeDeleted ë©”ì„œë“œ ì‚¬ìš©
- [ ] **Transaction ê²½ê³„** - ëª¨ë“  ê´€ë ¨ ë°ì´í„° ì‚­ì œëŠ” íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì›ìì  ì‹¤í–‰

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (User Aggregate)
  - AUT-001 (User ë“±ë¡)
  - AUT-003 (Refresh Token ê´€ë¦¬)
  - AUT-008, AUT-009 (SocialAccount)
  - AUT-013 (UserRole)

### ë³´ì•ˆ ê·œì¹™
- [ ] **SUPER_ADMIN ì „ìš©** - User ì‚­ì œëŠ” SUPER_ADMINë§Œ ê°€ëŠ¥
- [ ] **ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹** - ì‚­ì œ ì‹œ ì „í™”ë²ˆí˜¸, ì´ë©”ì¼, ì´ë¦„ ë§ˆìŠ¤í‚¹ í•„ìˆ˜
- [ ] **ë³µêµ¬ ë¶ˆê°€** - DELETED ìƒíƒœëŠ” ìµœì¢… ìƒíƒœ, ë³µêµ¬ ë¶ˆê°€

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: User.delete, maskPersonalData, canBeDeleted
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (User í™•ì¥, ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (DeleteUserUseCase)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (Repository í™•ì¥, Adapter)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (UserController)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 6ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹ ê²€ì¦ ì™„ë£Œ (GDPR ì¤€ìˆ˜)**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (5.3 User Deletion)
- **Plan**: docs/prd/plans/AUT-017-user-deletion-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-72

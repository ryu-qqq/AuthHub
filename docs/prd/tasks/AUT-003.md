# AUT-003: Refresh Token ê´€ë¦¬

**Epic**: IAM Platform (AuthHub)
**Feature**: Refresh Token ì¬ë°œê¸‰ ë° Rotation
**Phase**: Phase 1 - Core Authentication
**ë¸Œëœì¹˜**: feature/AUT-003-refresh-token
**ì˜ì¡´ì„±**: AUT-000, AUT-001, AUT-002 (ë¡œê·¸ì¸)

---

## ğŸ“ ëª©ì 

Refresh Tokenì„ í†µí•œ Access Token ì¬ë°œê¸‰ ê¸°ëŠ¥ êµ¬í˜„
- Refresh Token Rotation (ì¬ë°œê¸‰ ì‹œ ê¸°ì¡´ í† í° ë¬´íš¨í™”)
- Refresh Token Reuse ê°ì§€ (ë³´ì•ˆ)
- Redis ë¶„ì‚° ë½ìœ¼ë¡œ Race Condition ë°©ì§€

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 RefreshToken VO í™•ì¥
- [ ] **RefreshToken VOì— ì¶”ê°€**:
  - `isExpired()` â†’ boolean (ë§Œë£Œ ì—¬ë¶€ í™•ì¸)
  - `rotate()` â†’ RefreshToken (ìƒˆ RefreshToken ìƒì„±)

#### 1.2 Domain Exception
- [ ] **InvalidRefreshTokenException** (ìœ íš¨í•˜ì§€ ì•Šì€ í† í°)
- [ ] **RefreshTokenExpiredException** (í† í° ë§Œë£Œ)
- [ ] **RefreshTokenReuseDetectedException** (ì¬ì‚¬ìš© ê°ì§€)
- [ ] **ConcurrentRefreshException** (ë™ì‹œ ì¬ë°œê¸‰ ê°ì§€)

#### 1.3 Domain Event
- [ ] **AccessTokenRefreshed** Event
  - userId, oldRefreshToken, newRefreshToken, refreshedAt

- [ ] **RefreshTokenReuseDetected** Event
  - userId, suspiciousToken, revokedTokenCount, detectedAt

### 2. Application Layer

#### 2.1 RefreshAccessTokenUseCase (Command)
- [ ] **Input**: RefreshAccessTokenCommand
  - refreshToken (String)

- [ ] **Output**: AuthTokenResponse
  - accessToken (String)
  - refreshToken (String, ìƒˆë¡œìš´ í† í°)
  - expiresAt (LocalDateTime)

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§** (Redis ë¶„ì‚° ë½ ì ìš©):
  1. **ë¶„ì‚° ë½ íšë“** (lockKey = `token:refresh:{refreshToken}`)
     - ìµœëŒ€ 3ì´ˆ ëŒ€ê¸°, 5ì´ˆ í›„ ìë™ í•´ì œ
     - ì‹¤íŒ¨ ì‹œ ConcurrentRefreshException
  2. Refresh Token ê²€ì¦ (LoadRefreshTokenPort)
     - Redis ìºì‹œ ìš°ì„  ì¡°íšŒ â†’ ì—†ìœ¼ë©´ MySQL
     - ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ **Reuse ê°ì§€** (ì´ë¯¸ ì‚­ì œëœ í† í°)
       â†’ í•´ë‹¹ ì‚¬ìš©ìì˜ ëª¨ë“  Refresh Token íê¸°
       â†’ RefreshTokenReuseDetectedException ë°œí–‰
     - ë§Œë£Œ í™•ì¸ (isExpired)
       â†’ RefreshTokenExpiredException
  3. ì‚¬ìš©ì ì¡°íšŒ (LoadUserPort)
     - ì‚¬ìš©ì ìƒíƒœ í™•ì¸ (ACTIVEë§Œ í—ˆìš©)
  4. ìƒˆ Access Token ìƒì„± (GenerateAccessTokenPort)
  5. **Refresh Token Rotation**:
     - ìƒˆ Refresh Token ìƒì„± (GenerateRefreshTokenPort)
     - ê¸°ì¡´ Refresh Token ì‚­ì œ (DeleteRefreshTokenPort, MySQL + Redis)
     - ìƒˆ Refresh Token ì €ì¥ (SaveRefreshTokenPort)
  6. AccessTokenRefreshed Event ë°œí–‰
  7. **ë¶„ì‚° ë½ í•´ì œ**

#### 2.2 Port ì •ì˜
- [ ] **LoadRefreshTokenPort** (Out):
  - load(String token) â†’ Optional<AuthToken>

- [ ] **DeleteRefreshTokenPort** (Out):
  - delete(String token) â†’ void (MySQL + Redis ë™ì‹œ ì‚­ì œ)

- [ ] **DeleteAllRefreshTokensByUserIdPort** (Out):
  - deleteAll(Long userId) â†’ void (Reuse ê°ì§€ ì‹œ ì‚¬ìš©)

### 3. Persistence Layer

#### 3.1 Repository í™•ì¥
- [ ] **RefreshTokenJpaRepository**:
  - findByToken(String) â†’ Optional<RefreshTokenEntity>
  - deleteByToken(String) â†’ void
  - deleteAllByUserId(Long) â†’ void (Reuse ê°ì§€ ì‹œ)

#### 3.2 Redis Cache í™•ì¥
- [ ] **RedisRefreshTokenRepository**:
  - findByToken(String) â†’ Optional<RefreshToken>
  - delete(String token) â†’ void
  - deleteAllByUserId(Long userId) â†’ void

#### 3.3 Redis ë¶„ì‚° ë½
- [ ] **RedissonConfig**:
  - RedissonClient Bean ì„¤ì •

- [ ] **DistributedLockService**:
  - tryLock(String key, long waitTime, long leaseTime) â†’ boolean
  - unlock(String key) â†’ void

#### 3.4 Adapter í™•ì¥
- [ ] **RefreshTokenPersistenceAdapter**:
  - load(String token) â†’ Optional<AuthToken> (Redis ìš°ì„  â†’ MySQL Fallback)
  - delete(String token) â†’ MySQL + Redis ë™ì‹œ ì‚­ì œ
  - deleteAll(Long userId) â†’ ëª¨ë“  Refresh Token íê¸°

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/auth/refresh**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 200 OK

#### 4.2 Request DTO
- [ ] **RefreshAccessTokenRequest**:
  - refreshToken (String, @NotBlank)

#### 4.3 Response DTO
- [ ] **AuthTokenResponse** (ì¬ì‚¬ìš©)

#### 4.4 Controller
- [ ] **AuthController**:
  - refreshAccessToken(@Valid RefreshAccessTokenRequest) â†’ ResponseEntity<AuthTokenResponse>

#### 4.5 Error Handling
- [ ] **InvalidRefreshTokenException** â†’ HTTP 401, "ìœ íš¨í•˜ì§€ ì•Šì€ Refresh Tokenì…ë‹ˆë‹¤"
- [ ] **RefreshTokenExpiredException** â†’ HTTP 401, "Refresh Tokenì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¬ë¡œê·¸ì¸í•˜ì„¸ìš”"
- [ ] **RefreshTokenReuseDetectedException** â†’ HTTP 401, "ë³´ì•ˆ ìœ„í˜‘ ê°ì§€: ëª¨ë“  í† í°ì´ íê¸°ë˜ì—ˆìŠµë‹ˆë‹¤. ì¬ë¡œê·¸ì¸í•˜ì„¸ìš”"
- [ ] **ConcurrentRefreshException** â†’ HTTP 409, "ë™ì‹œ ì¬ë°œê¸‰ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. 3ì´ˆ í›„ ì¬ì‹œë„í•˜ì„¸ìš”"

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ ì¬ë°œê¸‰**:
  - Given: ë¡œê·¸ì¸ ì™„ë£Œ (refreshToken ë³´ìœ )
  - When: POST /api/v1/auth/refresh
  - Then: HTTP 200, ìƒˆ accessToken + refreshToken ë°˜í™˜
  - DB í™•ì¸: ê¸°ì¡´ refreshToken ì‚­ì œ, ìƒˆ refreshToken ì‚½ì…
  - Redis í™•ì¸: ê¸°ì¡´ ìºì‹œ ì‚­ì œ, ìƒˆ ìºì‹œ ì‚½ì…

- [ ] **Refresh Token ë§Œë£Œ**:
  - Given: ë§Œë£Œëœ refreshToken (14ì¼ ê²½ê³¼)
  - When: POST /api/v1/auth/refresh
  - Then: HTTP 401, "Refresh Tokenì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤"

- [ ] **Refresh Token Reuse ê°ì§€** (ë³´ì•ˆ ì‹œë‚˜ë¦¬ì˜¤):
  - Given: refreshTokenìœ¼ë¡œ ì¬ë°œê¸‰ ì™„ë£Œ (oldToken, newToken)
  - When: oldTokenìœ¼ë¡œ ì¬ë°œê¸‰ ì‹œë„ (ì´ë¯¸ ì‚­ì œëœ í† í°)
  - Then: HTTP 401, "ë³´ì•ˆ ìœ„í˜‘ ê°ì§€"
  - DB í™•ì¸: í•´ë‹¹ ì‚¬ìš©ìì˜ ëª¨ë“  refreshToken ì‚­ì œ
  - Event í™•ì¸: RefreshTokenReuseDetected ë°œí–‰

- [ ] **ë™ì‹œ ì¬ë°œê¸‰ (Race Condition)**:
  - Given: refreshToken ë³´ìœ 
  - When: ë™ì‹œì— 2ê°œ ìš”ì²­ (ê°™ì€ refreshToken)
  - Then: 1ê°œëŠ” ì„±ê³µ (HTTP 200), 1ê°œëŠ” ì‹¤íŒ¨ (HTTP 409)
  - Redis í™•ì¸: ë¶„ì‚° ë½ ì‘ë™ í™•ì¸

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **ë¡œê·¸ì¸**: AUT-002 API í˜¸ì¶œí•˜ì—¬ refreshToken íšë“
- [ ] **Testcontainers**: Redis (ë¶„ì‚° ë½ í…ŒìŠ¤íŠ¸)

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Transaction ê²½ê³„** - Redis ë¶„ì‚° ë½ì€ íŠ¸ëœì­ì…˜ ë°– (ë…ë¦½ ì‹¤í–‰)
- [ ] **Lombok ê¸ˆì§€** - RefreshToken VOëŠ” Record ì‚¬ìš©

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000, AUT-001, AUT-002 (ë¡œê·¸ì¸ ê¸°ëŠ¥)

### ë³´ì•ˆ ê·œì¹™
- [ ] **Refresh Token Rotation** í•„ìˆ˜ (ì¬ë°œê¸‰ ì‹œ ê¸°ì¡´ í† í° ë¬´íš¨í™”)
- [ ] **Reuse ê°ì§€** í•„ìˆ˜ (ì´ë¯¸ ì‚­ì œëœ í† í° ì‚¬ìš© ì‹œ ëª¨ë“  í† í° íê¸°)
- [ ] **Redis ë¶„ì‚° ë½** í•„ìˆ˜ (Race Condition ë°©ì§€)

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: RefreshToken.isExpired, rotate
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜ + Redisson í†µí•© í…ŒìŠ¤íŠ¸
- [ ] **Integration í…ŒìŠ¤íŠ¸**: Testcontainers Redis
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (RefreshToken VO í™•ì¥)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (RefreshAccessTokenUseCase + ë¶„ì‚° ë½)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (Redis ë¶„ì‚° ë½, Repository í™•ì¥)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (Controller, Error Handling)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 4ê°œ, Reuse ê°ì§€ í¬í•¨)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **ë³´ì•ˆ ê²€ì¦ ì™„ë£Œ** (Rotation + Reuse ê°ì§€ + Race Condition ë°©ì§€)
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (2.1.4 RefreshAccessTokenUseCase)
- **Plan**: docs/prd/plans/AUT-003-refresh-token-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-56

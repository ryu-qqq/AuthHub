# AUT-003: Persistence Layer êµ¬í˜„

**Epic**: B2B AuthHub - ë©€í‹° í…Œë„ŒíŠ¸ ì¸ì¦/ì¸ê°€ ì‹œìŠ¤í…œ
**Issue Key**: AUT-003
**Layer**: Persistence Layer (MySQL + Redis)
**Branch**: `feature/AUT-003-persistence-layer`
**Jira Epic**: [AUT-73](https://ryuqqq.atlassian.net/browse/AUT-73)
**Jira Issue**: [AUT-76](https://ryuqqq.atlassian.net/browse/AUT-76)

---

## ğŸ“‹ Purpose

B2B AuthHubì˜ ë°ì´í„° ì˜ì†ì„±ì„ ë‹´ë‹¹í•˜ëŠ” Persistence Layerë¥¼ TDDë¡œ ê°œë°œí•©ë‹ˆë‹¤.

**í•µì‹¬ ì›ì¹™**:
- Long FK ì „ëµ ì—„ê²© ì¤€ìˆ˜ (JPA ê´€ê³„ ì–´ë…¸í…Œì´ì…˜ ê¸ˆì§€)
- QueryDSL DTO Projection í•„ìˆ˜ ì‚¬ìš©
- N+1 ë¬¸ì œ ì‚¬ì „ ì°¨ë‹¨
- Redis ìºì‹± ì „ëµ êµ¬í˜„

---

## ğŸ¯ Requirements

### 1. MySQL Persistence (JPA + QueryDSL)

#### 1.1 Entity êµ¬í˜„ (7ê°œ)

```java
// entity/UserJpaEntity.java
@Entity
@Table(
    name = "users",
    indexes = {
        @Index(name = "idx_tenant_id", columnList = "tenant_id"),
        @Index(name = "idx_organization_id", columnList = "organization_id"),
        @Index(name = "idx_username", columnList = "username", unique = true),
        @Index(name = "idx_email", columnList = "email", unique = true)
    }
)
public class UserJpaEntity {

    @Id
    @Column(name = "id", columnDefinition = "BINARY(16)")
    private UUID id;

    // Long FK ì „ëµ: UUIDë§Œ ì €ì¥, ê´€ê³„ ì–´ë…¸í…Œì´ì…˜ ê¸ˆì§€
    @Column(name = "tenant_id", nullable = false, columnDefinition = "BINARY(16)")
    private UUID tenantId;

    @Column(name = "organization_id", nullable = false, columnDefinition = "BINARY(16)")
    private UUID organizationId;

    @Column(name = "username", nullable = false, length = 50, unique = true)
    private String username;

    @Column(name = "email", nullable = false, length = 255, unique = true)
    private String email;

    @Column(name = "password_hash", nullable = false, length = 255)
    private String passwordHash;

    @Enumerated(EnumType.STRING)
    @Column(name = "user_type", nullable = false, length = 20)
    private UserType userType;

    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false, length = 20)
    private UserStatus status;

    @Column(name = "phone_number", length = 20)
    private String phoneNumber;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @Column(name = "deleted_at")
    private LocalDateTime deletedAt;

    // Plain Java Constructor (Lombok ê¸ˆì§€)
    public UserJpaEntity() {}

    public UserJpaEntity(
        UUID id,
        UUID tenantId,
        UUID organizationId,
        String username,
        String email,
        String passwordHash,
        UserType userType,
        UserStatus status,
        String phoneNumber,
        LocalDateTime createdAt,
        LocalDateTime updatedAt,
        LocalDateTime deletedAt
    ) {
        this.id = id;
        this.tenantId = tenantId;
        this.organizationId = organizationId;
        this.username = username;
        this.email = email;
        this.passwordHash = passwordHash;
        this.userType = userType;
        this.status = status;
        this.phoneNumber = phoneNumber;
        this.createdAt = createdAt;
        this.updatedAt = updatedAt;
        this.deletedAt = deletedAt;
    }

    // Getters (no Lombok)
    public UUID id() { return id; }
    public UUID tenantId() { return tenantId; }
    public UUID organizationId() { return organizationId; }
    public String username() { return username; }
    public String email() { return email; }
    public String passwordHash() { return passwordHash; }
    public UserType userType() { return userType; }
    public UserStatus status() { return status; }
    public String phoneNumber() { return phoneNumber; }
    public LocalDateTime createdAt() { return createdAt; }
    public LocalDateTime updatedAt() { return updatedAt; }
    public LocalDateTime deletedAt() { return deletedAt; }
}
```

**Flyway Migration**:
```sql
-- V1__create_users_table.sql
CREATE TABLE users (
    id BINARY(16) PRIMARY KEY,
    tenant_id BINARY(16) NOT NULL,
    organization_id BINARY(16) NOT NULL,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    user_type VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL,
    phone_number VARCHAR(20),
    created_at DATETIME(6) NOT NULL,
    updated_at DATETIME(6) NOT NULL,
    deleted_at DATETIME(6),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_organization_id (organization_id),
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**ë‹¤ë¥¸ Entity**:
- `TenantJpaEntity`: í…Œë„ŒíŠ¸ ì •ë³´
- `OrganizationJpaEntity`: ì¡°ì§ ì •ë³´
- `RoleJpaEntity`: ì—­í•  ì •ë³´
- `PermissionJpaEntity`: ê¶Œí•œ ì •ë³´
- `UserRoleJpaEntity`: ì‚¬ìš©ì-ì—­í•  ë§¤í•‘
- `RefreshTokenJpaEntity`: Refresh Token ì •ë³´
- `AuditLogJpaEntity`: ê°ì‚¬ ë¡œê·¸

#### 1.2 Repository êµ¬í˜„ (JPA + QueryDSL)

```java
// repository/UserJpaRepository.java
public interface UserJpaRepository extends JpaRepository<UserJpaEntity, UUID> {

    // Spring Data JPA Query Methods
    Optional<UserJpaEntity> findByUsername(String username);
    Optional<UserJpaEntity> findByEmail(String email);
    boolean existsByUsername(String username);
    boolean existsByEmail(String email);
}

// repository/UserQueryDslRepository.java
@Repository
public class UserQueryDslRepository {

    private final JPAQueryFactory queryFactory;

    public UserQueryDslRepository(JPAQueryFactory queryFactory) {
        this.queryFactory = queryFactory;
    }

    // QueryDSL DTO Projection (N+1 ì°¨ë‹¨)
    public Optional<UserDetailDto> findUserDetailById(UUID userId) {
        QUserJpaEntity user = QUserJpaEntity.userJpaEntity;
        QTenantJpaEntity tenant = QTenantJpaEntity.tenantJpaEntity;
        QOrganizationJpaEntity organization = QOrganizationJpaEntity.organizationJpaEntity;

        return Optional.ofNullable(
            queryFactory
                .select(Projections.constructor(
                    UserDetailDto.class,
                    user.id,
                    user.username,
                    user.email,
                    user.status,
                    tenant.id,
                    tenant.name,
                    organization.id,
                    organization.name
                ))
                .from(user)
                .join(tenant).on(user.tenantId.eq(tenant.id))
                .join(organization).on(user.organizationId.eq(organization.id))
                .where(
                    user.id.eq(userId),
                    user.deletedAt.isNull()
                )
                .fetchOne()
        );
    }

    // í˜ì´ì§• ì¡°íšŒ (QueryDSL DTO Projection)
    public Page<UserListDto> searchUsers(UserSearchCondition condition, Pageable pageable) {
        QUserJpaEntity user = QUserJpaEntity.userJpaEntity;

        List<UserListDto> content = queryFactory
            .select(Projections.constructor(
                UserListDto.class,
                user.id,
                user.username,
                user.email,
                user.status,
                user.createdAt
            ))
            .from(user)
            .where(
                tenantIdEq(condition.tenantId()),
                organizationIdEq(condition.organizationId()),
                usernameContains(condition.username()),
                statusEq(condition.status()),
                user.deletedAt.isNull()
            )
            .orderBy(user.createdAt.desc())
            .offset(pageable.getOffset())
            .limit(pageable.getPageSize())
            .fetch();

        long total = queryFactory
            .select(user.count())
            .from(user)
            .where(
                tenantIdEq(condition.tenantId()),
                organizationIdEq(condition.organizationId()),
                usernameContains(condition.username()),
                statusEq(condition.status()),
                user.deletedAt.isNull()
            )
            .fetchOne();

        return new PageImpl<>(content, pageable, total);
    }

    // Dynamic Query Predicates
    private BooleanExpression tenantIdEq(UUID tenantId) {
        return tenantId != null ? QUserJpaEntity.userJpaEntity.tenantId.eq(tenantId) : null;
    }

    private BooleanExpression organizationIdEq(UUID organizationId) {
        return organizationId != null ? QUserJpaEntity.userJpaEntity.organizationId.eq(organizationId) : null;
    }

    private BooleanExpression usernameContains(String username) {
        return username != null ? QUserJpaEntity.userJpaEntity.username.contains(username) : null;
    }

    private BooleanExpression statusEq(UserStatus status) {
        return status != null ? QUserJpaEntity.userJpaEntity.status.eq(status) : null;
    }
}
```

**DTO Projection í´ë˜ìŠ¤**:
```java
// dto/UserDetailDto.java
public record UserDetailDto(
    UUID userId,
    String username,
    String email,
    UserStatus status,
    UUID tenantId,
    String tenantName,
    UUID organizationId,
    String organizationName
) {}

// dto/UserListDto.java
public record UserListDto(
    UUID id,
    String username,
    String email,
    UserStatus status,
    LocalDateTime createdAt
) {}
```

#### 1.3 Adapter êµ¬í˜„ (Port êµ¬í˜„ì²´)

```java
// adapter/command/UserCommandAdapter.java
@Component
public class UserCommandAdapter implements SaveUserPort {

    private final UserJpaRepository userJpaRepository;
    private final UserMapper userMapper;

    public UserCommandAdapter(
        UserJpaRepository userJpaRepository,
        UserMapper userMapper
    ) {
        this.userJpaRepository = userJpaRepository;
        this.userMapper = userMapper;
    }

    @Override
    public User save(User user) {
        UserJpaEntity entity = userMapper.toEntity(user);
        UserJpaEntity saved = userJpaRepository.save(entity);
        return userMapper.toDomain(saved);
    }
}

// adapter/query/UserQueryAdapter.java
@Component
public class UserQueryAdapter implements LoadUserPort {

    private final UserJpaRepository userJpaRepository;
    private final UserMapper userMapper;

    public UserQueryAdapter(
        UserJpaRepository userJpaRepository,
        UserMapper userMapper
    ) {
        this.userJpaRepository = userJpaRepository;
        this.userMapper = userMapper;
    }

    @Override
    public Optional<User> loadById(UUID userId) {
        return userJpaRepository.findById(userId)
            .filter(entity -> entity.deletedAt() == null)
            .map(userMapper::toDomain);
    }

    @Override
    public Optional<User> loadByUsername(String username) {
        return userJpaRepository.findByUsername(username)
            .filter(entity -> entity.deletedAt() == null)
            .map(userMapper::toDomain);
    }

    @Override
    public Optional<User> loadByEmail(String email) {
        return userJpaRepository.findByEmail(email)
            .filter(entity -> entity.deletedAt() == null)
            .map(userMapper::toDomain);
    }
}
```

#### 1.4 Mapper êµ¬í˜„ (Entity â†” Domain)

```java
// mapper/UserMapper.java
@Component
public class UserMapper {

    public UserJpaEntity toEntity(User user) {
        return new UserJpaEntity(
            user.id(),
            user.tenantId(),
            user.organizationId(),
            user.username().value(),
            user.email().value(),
            user.password().value(),
            user.userType(),
            user.status(),
            user.phoneNumber().value(),
            user.createdAt(),
            user.updatedAt(),
            user.deletedAt()
        );
    }

    public User toDomain(UserJpaEntity entity) {
        return User.reconstruct(
            entity.id(),
            entity.tenantId(),
            entity.organizationId(),
            Username.of(entity.username()),
            Email.of(entity.email()),
            Password.of(entity.passwordHash()),
            entity.userType(),
            entity.status(),
            PhoneNumber.of(entity.phoneNumber()),
            entity.createdAt(),
            entity.updatedAt(),
            entity.deletedAt()
        );
    }
}
```

---

### 2. Redis Persistence (Caching)

#### 2.1 Redis Config

```java
// config/RedisCacheConfig.java
@Configuration
@EnableCaching
public class RedisCacheConfig {

    @Bean
    public RedisCacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        RedisCacheConfiguration defaultConfig = RedisCacheConfiguration.defaultCacheConfig()
            .serializeKeysWith(
                RedisSerializationContext.SerializationPair.fromSerializer(
                    new StringRedisSerializer()
                )
            )
            .serializeValuesWith(
                RedisSerializationContext.SerializationPair.fromSerializer(
                    new GenericJackson2JsonRedisSerializer()
                )
            );

        Map<String, RedisCacheConfiguration> cacheConfigurations = new HashMap<>();

        // user:status:{userId} - 5ë¶„ TTL
        cacheConfigurations.put("user-status", defaultConfig.entryTtl(Duration.ofMinutes(5)));

        // user:permissions:{userId} - 10ë¶„ TTL
        cacheConfigurations.put("user-permissions", defaultConfig.entryTtl(Duration.ofMinutes(10)));

        // tenant:config:{tenantId} - 1ì‹œê°„ TTL
        cacheConfigurations.put("tenant-config", defaultConfig.entryTtl(Duration.ofHours(1)));

        return RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(defaultConfig)
            .withInitialCacheConfigurations(cacheConfigurations)
            .build();
    }
}
```

#### 2.2 Redis Adapter

```java
// adapter/UserPermissionCacheAdapter.java
@Component
public class UserPermissionCacheAdapter implements
    LoadUserPermissionsPort,
    SaveUserPermissionsPort,
    InvalidateUserPermissionCachePort {

    private final RedisTemplate<String, Object> redisTemplate;

    public UserPermissionCacheAdapter(RedisTemplate<String, Object> redisTemplate) {
        this.redisTemplate = redisTemplate;
    }

    @Override
    public Optional<List<Permission>> loadPermissions(UUID userId) {
        String key = "user:permissions:" + userId.toString();
        Object cached = redisTemplate.opsForValue().get(key);

        if (cached instanceof List<?>) {
            return Optional.of((List<Permission>) cached);
        }

        return Optional.empty();
    }

    @Override
    public void savePermissions(UUID userId, List<Permission> permissions) {
        String key = "user:permissions:" + userId.toString();
        redisTemplate.opsForValue().set(
            key,
            permissions,
            Duration.ofMinutes(10)
        );
    }

    @Override
    public void invalidate(UUID userId) {
        String key = "user:permissions:" + userId.toString();
        redisTemplate.delete(key);
    }
}
```

---

### 3. Flyway Migrations (ì „ì²´ ìŠ¤í‚¤ë§ˆ)

```sql
-- V1__create_tenants_table.sql
CREATE TABLE tenants (
    id BINARY(16) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    status VARCHAR(20) NOT NULL,
    mfa_required BOOLEAN NOT NULL DEFAULT FALSE,
    token_expiry_minutes INT NOT NULL DEFAULT 15,
    refresh_token_expiry_days INT NOT NULL DEFAULT 7,
    max_refresh_tokens_per_user INT NOT NULL DEFAULT 5,
    created_at DATETIME(6) NOT NULL,
    updated_at DATETIME(6) NOT NULL,
    deleted_at DATETIME(6),
    INDEX idx_status (status),
    INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- V2__create_organizations_table.sql
CREATE TABLE organizations (
    id BINARY(16) PRIMARY KEY,
    tenant_id BINARY(16) NOT NULL,
    name VARCHAR(200) NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at DATETIME(6) NOT NULL,
    updated_at DATETIME(6) NOT NULL,
    deleted_at DATETIME(6),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_status (status),
    INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- V3__create_users_table.sql (ìœ„ ì°¸ì¡°)

-- V4__create_roles_table.sql
CREATE TABLE roles (
    id BINARY(16) PRIMARY KEY,
    tenant_id BINARY(16),
    code VARCHAR(50) NOT NULL,
    name VARCHAR(100) NOT NULL,
    scope VARCHAR(20) NOT NULL,
    created_at DATETIME(6) NOT NULL,
    updated_at DATETIME(6) NOT NULL,
    deleted_at DATETIME(6),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_code (code),
    INDEX idx_scope (scope),
    INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- V5__create_permissions_table.sql
CREATE TABLE permissions (
    id BINARY(16) PRIMARY KEY,
    role_id BINARY(16) NOT NULL,
    resource VARCHAR(50) NOT NULL,
    action VARCHAR(50) NOT NULL,
    created_at DATETIME(6) NOT NULL,
    INDEX idx_role_id (role_id),
    INDEX idx_resource_action (resource, action)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- V6__create_user_roles_table.sql
CREATE TABLE user_roles (
    id BINARY(16) PRIMARY KEY,
    user_id BINARY(16) NOT NULL,
    role_id BINARY(16) NOT NULL,
    scope VARCHAR(255) NOT NULL,
    created_at DATETIME(6) NOT NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id),
    UNIQUE KEY uk_user_role_scope (user_id, role_id, scope)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- V7__create_refresh_tokens_table.sql
CREATE TABLE refresh_tokens (
    id BINARY(16) PRIMARY KEY,
    user_id BINARY(16) NOT NULL,
    token_hash VARCHAR(255) NOT NULL,
    issued_at DATETIME(6) NOT NULL,
    expires_at DATETIME(6) NOT NULL,
    revoked BOOLEAN NOT NULL DEFAULT FALSE,
    revoked_at DATETIME(6),
    INDEX idx_user_id (user_id),
    INDEX idx_token_hash (token_hash),
    INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- V8__create_audit_logs_table.sql
CREATE TABLE audit_logs (
    id BINARY(16) PRIMARY KEY,
    user_id BINARY(16) NOT NULL,
    tenant_id BINARY(16) NOT NULL,
    action VARCHAR(50) NOT NULL,
    resource VARCHAR(50) NOT NULL,
    resource_id BINARY(16),
    details TEXT,
    ip_address VARCHAR(45),
    user_agent VARCHAR(255),
    created_at DATETIME(6) NOT NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## âœ… Zero-Tolerance Rules Checklist

### Persistence Layer í•„ìˆ˜ ê·œì¹™

- [ ] **Long FK ì „ëµ**: JPA ê´€ê³„ ì–´ë…¸í…Œì´ì…˜ ì ˆëŒ€ ê¸ˆì§€ (`@ManyToOne`, `@OneToMany` ë“±)
- [ ] **QueryDSL DTO Projection**: N+1 ì°¨ë‹¨ í•„ìˆ˜
- [ ] **Lombok ê¸ˆì§€**: EntityëŠ” Plain Javaë§Œ ì‚¬ìš©
- [ ] **Soft Delete êµ¬í˜„**: deletedAt í•„ë“œ í•„ìˆ˜ ì²´í¬
- [ ] **Index ì „ëµ**: ì¡°íšŒ ì¡°ê±´ ì»¬ëŸ¼ì€ ëª¨ë‘ ì¸ë±ìŠ¤ ì¶”ê°€
- [ ] **UUID Binary(16)**: UUIDë¥¼ BINARY(16)ìœ¼ë¡œ ì €ì¥
- [ ] **Flyway Migration**: ëª¨ë“  ìŠ¤í‚¤ë§ˆ ë³€ê²½ì€ Flywayë¡œ ê´€ë¦¬
- [ ] **Redis TTL ì „ëµ**: ëª¨ë“  ìºì‹œëŠ” TTL ëª…ì‹œ

### ê¸ˆì§€ëœ íŒ¨í„´ ì˜ˆì‹œ

âŒ **ì˜ëª»ëœ ì˜ˆ (JPA ê´€ê³„ ì–´ë…¸í…Œì´ì…˜)**:
```java
@Entity
public class UserJpaEntity {
    @Id
    private UUID id;

    @ManyToOne(fetch = FetchType.LAZY) // âŒ ê¸ˆì§€!
    @JoinColumn(name = "tenant_id")
    private TenantJpaEntity tenant;
}
```

âœ… **ì˜¬ë°”ë¥¸ ì˜ˆ (Long FK ì „ëµ)**:
```java
@Entity
public class UserJpaEntity {
    @Id
    @Column(name = "id", columnDefinition = "BINARY(16)")
    private UUID id;

    @Column(name = "tenant_id", nullable = false, columnDefinition = "BINARY(16)")
    private UUID tenantId; // âœ… UUIDë§Œ ì €ì¥
}
```

âŒ **ì˜ëª»ëœ ì˜ˆ (N+1 ë°œìƒ)**:
```java
public List<User> findAll() {
    return userJpaRepository.findAll().stream()
        .map(entity -> {
            // N+1 ë°œìƒ: ê° Userë§ˆë‹¤ Tenant, Organization ì¡°íšŒ
            Tenant tenant = tenantRepository.findById(entity.tenantId()).get();
            Organization org = orgRepository.findById(entity.organizationId()).get();
            return toDomain(entity, tenant, org);
        })
        .toList();
}
```

âœ… **ì˜¬ë°”ë¥¸ ì˜ˆ (QueryDSL DTO Projection)**:
```java
public Page<UserListDto> searchUsers(Pageable pageable) {
    return queryFactory
        .select(Projections.constructor(
            UserListDto.class,
            user.id,
            user.username,
            user.email,
            user.status,
            tenant.name, // JOINìœ¼ë¡œ í•œ ë²ˆì— ì¡°íšŒ
            organization.name
        ))
        .from(user)
        .join(tenant).on(user.tenantId.eq(tenant.id))
        .join(organization).on(user.organizationId.eq(organization.id))
        .fetch();
}
```

---

## ğŸ§ª Test Rules

### 1. Test íŒŒì¼ ìœ„ì¹˜
```
adapter-out/persistence-mysql/src/test/java/
â”œâ”€â”€ adapter/
â”‚   â”œâ”€â”€ command/
â”‚   â”‚   â””â”€â”€ UserCommandAdapterTest.java
â”‚   â””â”€â”€ query/
â”‚       â””â”€â”€ UserQueryAdapterTest.java
â”œâ”€â”€ entity/
â”‚   â””â”€â”€ UserJpaEntityTest.java
â”œâ”€â”€ mapper/
â”‚   â””â”€â”€ UserMapperTest.java
â””â”€â”€ repository/
    â”œâ”€â”€ UserJpaRepositoryTest.java
    â””â”€â”€ UserQueryDslRepositoryTest.java
```

### 2. Test ì‘ì„± ê·œì¹™

**Repository í…ŒìŠ¤íŠ¸ (Spring Boot Test)**:
```java
@DataJpaTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
@ActiveProfiles("test")
@DisplayName("UserJpaRepository í…ŒìŠ¤íŠ¸")
class UserJpaRepositoryTest {

    @Autowired
    private UserJpaRepository userJpaRepository;

    @Test
    @DisplayName("usernameìœ¼ë¡œ ì‚¬ìš©ì ì¡°íšŒ ì„±ê³µ")
    void findByUsername_Success() {
        // Given
        UserJpaEntity user = UserJpaEntityFixture.create("testuser");
        userJpaRepository.save(user);

        // When
        Optional<UserJpaEntity> found = userJpaRepository.findByUsername("testuser");

        // Then
        assertThat(found).isPresent();
        assertThat(found.get().username()).isEqualTo("testuser");
    }

    @Test
    @DisplayName("deletedAtì´ nullì¸ ì‚¬ìš©ìë§Œ ì¡°íšŒ")
    void findByUsername_ExcludeDeleted() {
        // Given
        UserJpaEntity deletedUser = UserJpaEntityFixture.createDeleted("deleted");
        userJpaRepository.save(deletedUser);

        // When
        Optional<UserJpaEntity> found = userJpaRepository.findByUsername("deleted");

        // Then
        assertThat(found).isEmpty(); // Soft Delete ì œì™¸
    }
}
```

**QueryDSL í…ŒìŠ¤íŠ¸**:
```java
@DataJpaTest
@Import({UserQueryDslRepository.class, JPAQueryFactory.class})
@DisplayName("UserQueryDslRepository í…ŒìŠ¤íŠ¸")
class UserQueryDslRepositoryTest {

    @Autowired
    private UserQueryDslRepository userQueryDslRepository;

    @Test
    @DisplayName("QueryDSL DTO Projectionìœ¼ë¡œ ì‚¬ìš©ì ìƒì„¸ ì¡°íšŒ")
    void findUserDetailById_Success() {
        // Given
        UUID userId = UUID.randomUUID();
        // ... í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„

        // When
        Optional<UserDetailDto> result = userQueryDslRepository.findUserDetailById(userId);

        // Then
        assertThat(result).isPresent();
        assertThat(result.get().userId()).isEqualTo(userId);
        assertThat(result.get().tenantName()).isEqualTo("Test Tenant");
    }
}
```

**Adapter í…ŒìŠ¤íŠ¸**:
```java
@ExtendWith(MockitoExtension.class)
@DisplayName("UserCommandAdapter í…ŒìŠ¤íŠ¸")
class UserCommandAdapterTest {

    @Mock
    private UserJpaRepository userJpaRepository;

    @Mock
    private UserMapper userMapper;

    @InjectMocks
    private UserCommandAdapter userCommandAdapter;

    @Test
    @DisplayName("ì‚¬ìš©ì ì €ì¥ ì„±ê³µ")
    void save_Success() {
        // Given
        User user = UserFixture.active();
        UserJpaEntity entity = UserJpaEntityFixture.fromDomain(user);

        when(userMapper.toEntity(user)).thenReturn(entity);
        when(userJpaRepository.save(entity)).thenReturn(entity);
        when(userMapper.toDomain(entity)).thenReturn(user);

        // When
        User saved = userCommandAdapter.save(user);

        // Then
        assertThat(saved).isNotNull();
        verify(userJpaRepository, times(1)).save(entity);
    }
}
```

### 3. Test Coverage ëª©í‘œ
- **Repository**: 100% (ëª¨ë“  ì¿¼ë¦¬ ë©”ì„œë“œ)
- **Adapter**: 90% ì´ìƒ
- **Mapper**: 100% (ë³€í™˜ ë¡œì§)

---

## ğŸ¯ Completion Criteria

### 1. êµ¬í˜„ ì™„ë£Œ ì¡°ê±´
- [ ] 8ê°œ Entity ëª¨ë‘ êµ¬í˜„ ì™„ë£Œ
- [ ] 8ê°œ Flyway Migration ì™„ë£Œ
- [ ] Repository (JPA + QueryDSL) ëª¨ë‘ êµ¬í˜„
- [ ] Adapter (Command + Query) ëª¨ë‘ êµ¬í˜„
- [ ] Mapper ëª¨ë‘ êµ¬í˜„ ì™„ë£Œ
- [ ] Redis Caching êµ¬í˜„ ì™„ë£Œ
- [ ] ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] ArchUnit ê²€ì¦ í†µê³¼

### 2. ArchUnit ê²€ì¦ í•­ëª©
```java
@ArchTest
static final ArchRule entities_should_not_use_jpa_relationships =
    noFields()
        .that().areDeclaredInClassesThat().resideInAPackage("..entity..")
        .should().beAnnotatedWith(OneToMany.class)
        .orShould().beAnnotatedWith(ManyToOne.class)
        .orShould().beAnnotatedWith(OneToOne.class)
        .orShould().beAnnotatedWith(ManyToMany.class);

@ArchTest
static final ArchRule entities_should_not_use_lombok =
    noClasses()
        .that().resideInAPackage("..entity..")
        .should().beAnnotatedWith(Getter.class)
        .orShould().beAnnotatedWith(Setter.class);
```

### 3. Code Review Checklist
- [ ] Long FK ì „ëµ ì¤€ìˆ˜ í™•ì¸
- [ ] QueryDSL DTO Projection ì‚¬ìš© í™•ì¸
- [ ] N+1 ë¬¸ì œ ë°œìƒ ì—¬ë¶€ í™•ì¸
- [ ] Soft Delete ë¡œì§ í™•ì¸
- [ ] Index ì „ëµ ì ì ˆì„± í™•ì¸
- [ ] Redis TTL ì„¤ì • í™•ì¸

---

## ğŸ“š Related Documents

- [Persistence MySQL Guide](../../docs/coding_convention/04-persistence-layer/mysql/persistence-mysql-guide.md)
- [Entity Guide](../../docs/coding_convention/04-persistence-layer/mysql/entity/entity-guide.md)
- [QueryDSL Repository Guide](../../docs/coding_convention/04-persistence-layer/mysql/repository/querydsl-repository-guide.md)
- [Adapter Guide](../../docs/coding_convention/04-persistence-layer/mysql/adapter/command/command-adapter-guide.md)
- [PRD: B2B AuthHub](../b2b-auth-hub.md)

---

## ğŸ”„ Kent Beck TDD Commands

```bash
# Persistence Layer TDD ì‚¬ì´í´ ì‹¤í–‰
/kb/persistence/go          # Plan íŒŒì¼ ê¸°ë°˜ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
/kb/persistence/red         # Red: test: ì»¤ë°‹
/kb/persistence/green       # Green: feat: ì»¤ë°‹
/kb/persistence/refactor    # Refactor: struct: ì»¤ë°‹
```

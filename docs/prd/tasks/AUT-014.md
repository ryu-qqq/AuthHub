# AUT-014: Rate Limiting

**Epic**: IAM Platform (AuthHub)
**Feature**: Rate Limiting
**Phase**: Phase 3 - Security & Monitoring
**ë¸Œëœì¹˜**: feature/AUT-014-rate-limiting
**ì˜ì¡´ì„±**: AUT-000, AUT-002 (ë¡œê·¸ì¸)

---

## ğŸ“ ëª©ì 

API ìš”ì²­ ì†ë„ ì œí•œ ê¸°ëŠ¥ êµ¬í˜„
- IP ê¸°ë°˜ Rate Limiting (Redis Sliding Window)
- ì‚¬ìš©ì ê¸°ë°˜ Rate Limiting (ë¡œê·¸ì¸ í›„)
- Endpointë³„ Rate Limit ì„¤ì •
- Rate Limit ì´ˆê³¼ ì‹œ 429 Too Many Requests ì‘ë‹µ

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 RateLimitPolicy VO
- [ ] **RateLimitPolicy VO** ìƒì„±
  - endpoint (String, "/api/v1/auth/login/phone")
  - maxRequests (int, ì˜ˆ: 5)
  - windowSeconds (int, ì˜ˆ: 60)
  - scope (RateLimitScope Enum: IP, USER)

#### 1.2 RateLimitScope Enum
- [ ] **RateLimitScope Enum**:
  - IP (IP ì£¼ì†Œ ê¸°ë°˜)
  - USER (ì‚¬ìš©ì ID ê¸°ë°˜)

#### 1.3 Domain Exception
- [ ] **RateLimitExceededException** (Rate Limit ì´ˆê³¼)
  - remainingTime (int, ì¬ì‹œë„ ê°€ëŠ¥ ì‹œê°„)

### 2. Application Layer

**ì´ TaskëŠ” Infrastructure Layer ì¤‘ì‹¬**ì´ë¯€ë¡œ UseCase êµ¬í˜„ ì—†ìŒ.

### 3. Persistence Layer

#### 3.1 Redis Rate Limiting
- [ ] **RedisRateLimiter** êµ¬í˜„
  - `checkRateLimit(String key, RateLimitPolicy)` â†’ boolean
  - Lua Script ì‚¬ìš© (Atomic Operation)
  - Sliding Window Algorithm êµ¬í˜„

#### 3.2 Redis Key êµ¬ì¡°
- [ ] **Key Format**:
  - IP ê¸°ë°˜: `rate_limit:ip:{IP_ADDRESS}:{ENDPOINT}`
  - USER ê¸°ë°˜: `rate_limit:user:{USER_ID}:{ENDPOINT}`

#### 3.3 Lua Script (Sliding Window)
- [ ] **Sliding Window Lua Script**:
  ```lua
  local key = KEYS[1]
  local max_requests = tonumber(ARGV[1])
  local window_seconds = tonumber(ARGV[2])
  local now = tonumber(ARGV[3])

  -- ìœˆë„ìš° ì‹œì‘ ì‹œê°
  local window_start = now - window_seconds

  -- ì˜¤ë˜ëœ ìš”ì²­ ì œê±°
  redis.call('ZREMRANGEBYSCORE', key, 0, window_start)

  -- í˜„ì¬ ìœˆë„ìš° ë‚´ ìš”ì²­ ìˆ˜
  local current_requests = redis.call('ZCARD', key)

  if current_requests < max_requests then
    -- ìš”ì²­ í—ˆìš©
    redis.call('ZADD', key, now, now)
    redis.call('EXPIRE', key, window_seconds)
    return 1
  else
    -- ìš”ì²­ ê±°ë¶€
    return 0
  end
  ```

### 4. REST API Layer

#### 4.1 Interceptor
- [ ] **RateLimitInterceptor** êµ¬í˜„
  - `preHandle()` â†’ Rate Limit ê²€ì¦
  - IP ì£¼ì†Œ ì¶”ì¶œ (X-Forwarded-For ë˜ëŠ” RemoteAddr)
  - ì‚¬ìš©ì ID ì¶”ì¶œ (Authentication)
  - RateLimitPolicy ì¡°íšŒ (Endpoint ë§¤ì¹­)
  - RedisRateLimiter.checkRateLimit() í˜¸ì¶œ
  - ì´ˆê³¼ ì‹œ RateLimitExceededException ë°œìƒ

#### 4.2 WebMvcConfigurer
- [ ] **WebMvcConfig**:
  - RateLimitInterceptor ë“±ë¡
  - Endpointë³„ Rate Limit ì„¤ì •

#### 4.3 Rate Limit ì„¤ì •
- [ ] **application.yml**:
  ```yaml
  rate-limit:
    policies:
      - endpoint: /api/v1/auth/login/phone
        max-requests: 5
        window-seconds: 60
        scope: IP
      - endpoint: /api/v1/auth/register
        max-requests: 3
        window-seconds: 60
        scope: IP
      - endpoint: /api/v1/auth/refresh
        max-requests: 10
        window-seconds: 60
        scope: USER
  ```

#### 4.4 Error Handling
- [ ] **GlobalExceptionHandler**:
  - RateLimitExceededException â†’ HTTP 429 Too Many Requests
  - Response Headers:
    - `X-RateLimit-Limit`: ìµœëŒ€ ìš”ì²­ ìˆ˜
    - `X-RateLimit-Remaining`: ë‚¨ì€ ìš”ì²­ ìˆ˜
    - `X-RateLimit-Reset`: ì¬ì„¤ì • ì‹œê° (Unix Timestamp)
    - `Retry-After`: ì¬ì‹œë„ ê°€ëŠ¥ ì‹œê°„ (ì´ˆ)

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ ìš”ì²­ (Rate Limit ë‚´)**:
  - Given: ë¡œê·¸ì¸ API Rate Limit (5 requests / 60 seconds)
  - When: 3ë²ˆ ë¡œê·¸ì¸ ìš”ì²­
  - Then: ëª¨ë‘ HTTP 200 ì„±ê³µ

- [ ] **Rate Limit ì´ˆê³¼**:
  - Given: ë¡œê·¸ì¸ API Rate Limit (5 requests / 60 seconds)
  - When: 6ë²ˆ ë¡œê·¸ì¸ ìš”ì²­
  - Then:
    - 1~5ë²ˆ: HTTP 200 ì„±ê³µ
    - 6ë²ˆ: HTTP 429 Too Many Requests
    - Headers:
      - X-RateLimit-Limit: 5
      - X-RateLimit-Remaining: 0
      - X-RateLimit-Reset: {timestamp}
      - Retry-After: {seconds}

- [ ] **ë‹¤ë¥¸ IPëŠ” ë…ë¦½ì ìœ¼ë¡œ Rate Limit ì ìš©**:
  - Given: IP1ì—ì„œ 5ë²ˆ ìš”ì²­ (Rate Limit ë„ë‹¬)
  - When: IP2ì—ì„œ 1ë²ˆ ìš”ì²­
  - Then: HTTP 200 ì„±ê³µ (ë…ë¦½ ì¹´ìš´íŒ…)

- [ ] **Sliding Window ë™ì‘ í™•ì¸**:
  - Given: Rate Limit (5 requests / 60 seconds)
  - When:
    - T=0s: 5ë²ˆ ìš”ì²­ (Rate Limit ë„ë‹¬)
    - T=30s: 1ë²ˆ ìš”ì²­ â†’ 429
    - T=61s: 1ë²ˆ ìš”ì²­ â†’ 200 (ì²« ìš”ì²­ì´ ìœˆë„ìš° ë°–)

- [ ] **USER ê¸°ë°˜ Rate Limit**:
  - Given: Refresh API (10 requests / 60 seconds, USER ê¸°ë°˜)
  - When: User1ì´ 10ë²ˆ ìš”ì²­
  - Then: 10ë²ˆì€ ì„±ê³µ, 11ë²ˆì€ 429

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **Testcontainers**: Redis (Rate Limiting)
- [ ] **MockMvc**: HTTP ìš”ì²­ ì‹œë®¬ë ˆì´ì…˜

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Lua Script Atomic Operation** - Sliding WindowëŠ” Lua Scriptë¡œ ì›ìì  ì‹¤í–‰

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (Redis ì„¤ì •)
  - AUT-002 (ë¡œê·¸ì¸ Endpoint)

### ë³´ì•ˆ ê·œì¹™
- [ ] **IP Spoofing ë°©ì§€** - X-Forwarded-For ê²€ì¦
- [ ] **DDoS ë°©ì–´** - Rate Limit ì—„ê²© ì ìš©

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: Testcontainers Redis
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (RateLimitPolicy VO)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (RedisRateLimiter, Lua Script)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (RateLimitInterceptor)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 5ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **Sliding Window ì•Œê³ ë¦¬ì¦˜ ê²€ì¦ ì™„ë£Œ**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (4.1 Rate Limiting)
- **Plan**: docs/prd/plans/AUT-012-rate-limiting-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-67

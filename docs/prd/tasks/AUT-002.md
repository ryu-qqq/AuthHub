# AUT-002: ì „í™”ë²ˆí˜¸ ë¡œê·¸ì¸

**Epic**: IAM Platform (AuthHub)
**Feature**: ì „í™”ë²ˆí˜¸ ë¡œê·¸ì¸
**Phase**: Phase 1 - Core Authentication
**ë¸Œëœì¹˜**: feature/AUT-002-phone-login
**ì˜ì¡´ì„±**: AUT-000 (Domain Skeleton), AUT-001 (ì‚¬ìš©ì ë“±ë¡)

---

## ğŸ“ ëª©ì 

PUBLIC ì‚¬ìš©ìì˜ ì „í™”ë²ˆí˜¸ ê¸°ë°˜ ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„
- ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (BCrypt)
- Access Token ë°œê¸‰ (JWT, 30ë¶„)
- Refresh Token ë°œê¸‰ ë° ì €ì¥ (14ì¼)
- ì‚¬ìš©ì ìƒíƒœ í™•ì¸ (ACTIVEë§Œ í—ˆìš©)

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 AuthToken Aggregate
- [ ] **AuthToken Aggregate Root** ìƒì„±
  - accessToken (AccessToken VO, JWT)
  - refreshToken (RefreshToken VO, UUID)
  - userId (Long FK)
  - tenantId (Long FK)
  - expiresAt (LocalDateTime, Refresh Token ë§Œë£Œ ì‹œê°)
  - createdAt (LocalDateTime)

#### 1.2 AccessToken VO
- [ ] **AccessToken VO** ìƒì„±
  - value (String, JWT)
  - expiresAt (LocalDateTime, 30ë¶„ í›„)
  - issuedAt (LocalDateTime)

- [ ] **JWT Payload**:
  - sub (userId)
  - tenant_id (tenantId)
  - user_type (PUBLIC/INTERNAL)
  - roles (List<String>)
  - permissions (List<String>)
  - iat (Issued At)
  - exp (Expires At, 30ë¶„)

#### 1.3 RefreshToken VO
- [ ] **RefreshToken VO** ìƒì„±
  - value (String, UUID)
  - expiresAt (LocalDateTime, 14ì¼ í›„)
  - createdAt (LocalDateTime)

#### 1.4 Credential VO í™•ì¥
- [ ] **Credential VOì— ì¶”ê°€**:
  - `verifyPassword(String rawPassword)` â†’ boolean (BCrypt.matches)

#### 1.5 User Aggregate í™•ì¥
- [ ] **User Aggregateì— ì¶”ê°€**:
  - `canLogin()` â†’ boolean (status == ACTIVE í™•ì¸)

#### 1.6 Domain Exception
- [ ] **UserNotFoundException** (ì‚¬ìš©ì ì—†ìŒ)
- [ ] **InvalidPasswordException** (ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜)
- [ ] **UserInactiveException** (ì‚¬ìš©ì ë¹„í™œì„±)
- [ ] **UserSuspendedException** (ì‚¬ìš©ì ì •ì§€)

#### 1.7 Domain Event
- [ ] **UserLoggedIn** Event
  - userId, tenantId, loginMethod (PHONE), loginAt

### 2. Application Layer

#### 2.1 LoginWithPhoneUseCase (Command)
- [ ] **Input**: LoginWithPhoneCommand
  - phoneNumber (String)
  - password (String)

- [ ] **Output**: AuthTokenResponse
  - accessToken (String)
  - refreshToken (String)
  - expiresAt (LocalDateTime)

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. ì „í™”ë²ˆí˜¸ë¡œ ì‚¬ìš©ì ì¡°íšŒ (LoadUserByPhonePort)
     - ì—†ìœ¼ë©´ UserNotFoundException
  2. ì‚¬ìš©ì ìƒíƒœ í™•ì¸ (canLogin())
     - INACTIVE â†’ UserInactiveException
     - SUSPENDED â†’ UserSuspendedException
     - DELETED â†’ UserNotFoundException
  3. ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (credential.verifyPassword)
     - ì‹¤íŒ¨ ì‹œ InvalidPasswordException
  4. Access Token ìƒì„± (GenerateAccessTokenPort)
  5. Refresh Token ìƒì„± (GenerateRefreshTokenPort)
  6. Refresh Token ì €ì¥ (SaveRefreshTokenPort, MySQL + Redis)
  7. UserLoggedIn Event ë°œí–‰

#### 2.2 Port ì •ì˜
- [ ] **LoadUserByPhonePort** (Out):
  - load(Long tenantId, String phoneNumber) â†’ Optional<User>

- [ ] **GenerateAccessTokenPort** (Out):
  - generate(User) â†’ AccessToken (JWT ìƒì„±)

- [ ] **GenerateRefreshTokenPort** (Out):
  - generate(User) â†’ RefreshToken (UUID ìƒì„±)

- [ ] **SaveRefreshTokenPort** (Out):
  - save(AuthToken) â†’ void (MySQL + Redis ë™ì‹œ ì €ì¥)

### 3. Persistence Layer

#### 3.1 RefreshTokenEntity
- [ ] **RefreshTokenEntity** ìƒì„±
  - id (Long, PK)
  - user_id (Long, FK)
  - tenant_id (Long, FK)
  - token (String, Unique, UUID)
  - expires_at (LocalDateTime)
  - created_at (LocalDateTime)

#### 3.2 Flyway ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] **V4__create_refresh_tokens.sql**:
  - refresh_tokens í…Œì´ë¸” ìƒì„±
  - Unique Constraint: token
  - Index: (user_id, created_at)

#### 3.3 Repository
- [ ] **RefreshTokenJpaRepository**:
  - save(RefreshTokenEntity) â†’ RefreshTokenEntity
  - findByToken(String) â†’ Optional<RefreshTokenEntity>

#### 3.4 Redis Cache
- [ ] **RedisRefreshTokenRepository**:
  - save(String token, RefreshToken, Duration ttl)
  - findByToken(String token) â†’ Optional<RefreshToken>
  - Key: `refresh_token:{token}`
  - TTL: 14ì¼

#### 3.5 Adapter
- [ ] **UserQueryAdapter** (LoadUserByPhonePort êµ¬í˜„):
  - load(Long tenantId, String phoneNumber) â†’ Optional<User>

- [ ] **RefreshTokenPersistenceAdapter** (SaveRefreshTokenPort êµ¬í˜„):
  - save(AuthToken) â†’ MySQL + Redis ë™ì‹œ ì €ì¥

- [ ] **JwtTokenAdapter** (GenerateAccessTokenPort êµ¬í˜„):
  - generate(User) â†’ AccessToken (RS256 ì„œëª…)
  - Private Key ì‚¬ìš© (application.ymlì—ì„œ ë¡œë“œ)

- [ ] **RefreshTokenGeneratorAdapter** (GenerateRefreshTokenPort êµ¬í˜„):
  - generate(User) â†’ RefreshToken (UUID ìƒì„±)

#### 3.6 Mapper
- [ ] **RefreshTokenMapper**:
  - toEntity(AuthToken) â†’ RefreshTokenEntity
  - toDomain(RefreshTokenEntity) â†’ AuthToken

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/auth/login/phone**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 200 OK

#### 4.2 Request DTO
- [ ] **LoginWithPhoneRequest**:
  - phoneNumber (String, @NotBlank, @Pattern)
  - password (String, @NotBlank)

#### 4.3 Response DTO
- [ ] **AuthTokenResponse**:
  - accessToken (String)
  - refreshToken (String)
  - expiresAt (LocalDateTime)

#### 4.4 Controller
- [ ] **AuthController**:
  - loginWithPhone(@Valid LoginWithPhoneRequest) â†’ ResponseEntity<AuthTokenResponse>

#### 4.5 Error Handling
- [ ] **UserNotFoundException** â†’ HTTP 401 Unauthorized, "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
- [ ] **InvalidPasswordException** â†’ HTTP 401 Unauthorized, "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
- [ ] **UserInactiveException** â†’ HTTP 403 Forbidden, "ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤"
- [ ] **UserSuspendedException** â†’ HTTP 403 Forbidden, "ì •ì§€ëœ ê³„ì •ì…ë‹ˆë‹¤"

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ ë¡œê·¸ì¸**:
  - Given: ë“±ë¡ëœ ì‚¬ìš©ì (010-1234-5678, password: "test1234")
  - When: POST /api/v1/auth/login/phone
  - Then: HTTP 200, AuthTokenResponse ë°˜í™˜
  - DB í™•ì¸: refresh_tokens í…Œì´ë¸”ì— ë°ì´í„° ì‚½ì…
  - Redis í™•ì¸: refresh_token:{token} ìºì‹œ ì¡´ì¬

- [ ] **ì‚¬ìš©ì ì—†ìŒ**:
  - Given: ë¯¸ë“±ë¡ ì „í™”ë²ˆí˜¸
  - When: POST /api/v1/auth/login/phone
  - Then: HTTP 401, "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

- [ ] **ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜**:
  - Given: ë“±ë¡ëœ ì‚¬ìš©ì
  - When: POST /api/v1/auth/login/phone (ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸)
  - Then: HTTP 401, "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"

- [ ] **ë¹„í™œì„±í™”ëœ ê³„ì •**:
  - Given: status = INACTIVEì¸ ì‚¬ìš©ì
  - When: POST /api/v1/auth/login/phone
  - Then: HTTP 403, "ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤"

- [ ] **Access Token ìœ íš¨ì„± ê²€ì¦**:
  - Given: ë¡œê·¸ì¸ ì™„ë£Œ (accessToken ë³´ìœ )
  - When: JWT íŒŒì‹± ë° ê²€ì¦
  - Then: Payloadì— userId, tenantId, userType í¬í•¨

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V4 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **ì‚¬ìš©ì ìƒì„±**: AUT-001 API í˜¸ì¶œ ë˜ëŠ” ì§ì ‘ ì‚½ì…

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Lombok ê¸ˆì§€** - AccessToken, RefreshToken VOëŠ” Record ì‚¬ìš©
- [ ] **Transaction ê²½ê³„** - ì™¸ë¶€ API í˜¸ì¶œ ì—†ìŒ (JWT ìƒì„±ì€ íŠ¸ëœì­ì…˜ ë‚´)
- [ ] **Long FK ì „ëµ** - RefreshTokenEntityì— `private Long userId`

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (User, Tenant ê¸°ë³¸ êµ¬ì¡°)
  - AUT-001 (Credential VO, ì‚¬ìš©ì ë“±ë¡)

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: Credential.verifyPassword, User.canLogin
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate + JWT ê²€ì¦
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (AuthToken, AccessToken, RefreshToken)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (LoginWithPhoneUseCase)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (RefreshTokenEntity, Repository, JWT ìƒì„±)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (Controller, DTO)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 5ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **ë…ë¦½ ë°°í¬ ê°€ëŠ¥ í™•ì¸** (ë¡œê·¸ì¸ ê¸°ëŠ¥ë§Œ ë™ì‘)
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (2.1.2 LoginWithPhoneUseCase)
- **Plan**: docs/prd/plans/AUT-002-phone-login-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-55

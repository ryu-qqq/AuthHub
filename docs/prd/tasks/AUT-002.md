# AUT-002: Application Layer êµ¬í˜„

**Epic**: B2B AuthHub - ë©€í‹° í…Œë„ŒíŠ¸ ì¸ì¦/ì¸ê°€ ì‹œìŠ¤í…œ
**Issue Key**: AUT-002
**Layer**: Application Layer
**Branch**: `feature/AUT-002-application-layer`
**Jira Epic**: [AUT-73](https://ryuqqq.atlassian.net/browse/AUT-73)
**Jira Issue**: [AUT-75](https://ryuqqq.atlassian.net/browse/AUT-75)
**ìƒíƒœ**: In Progress
**ì‹œì‘ì¼**: 2025-12-02
**ë‹´ë‹¹ì**: sangwon-ryu

---

## ğŸ“‹ Purpose

B2B AuthHubì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ìœ ìŠ¤ì¼€ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ëŠ” Application Layerë¥¼ TDDë¡œ ê°œë°œí•©ë‹ˆë‹¤.

**í•µì‹¬ ì›ì¹™**:
- UseCase ë‹¨ìœ„ íŠ¸ëœì­ì…˜ ê²½ê³„ ëª…í™•í™”
- CQRS íŒ¨í„´ ì—„ê²© ì¤€ìˆ˜ (Command/Query ë¶„ë¦¬)
- Assemblerë¥¼ í†µí•œ Domain â†” DTO ë³€í™˜
- `@Transactional` ë‚´ ì™¸ë¶€ API í˜¸ì¶œ ì ˆëŒ€ ê¸ˆì§€

---

## ğŸ¯ Requirements

### 1. UseCases êµ¬í˜„ (24ê°œ)

#### 1.1 Auth UseCases (5ê°œ)

```java
// usecase/auth/LoginUseCase.java (Command)
public interface LoginUseCase {
    LoginResponse execute(LoginCommand command);
}

@Service
public class LoginUseCaseImpl implements LoginUseCase {

    private final LoadUserPort loadUserPort;
    private final LoadTenantPort loadTenantPort;
    private final LoadOrganizationPort loadOrganizationPort;
    private final LoadUserRolesPort loadUserRolesPort;
    private final SaveRefreshTokenPort saveRefreshTokenPort;
    private final SaveAuditLogPort saveAuditLogPort;
    private final PasswordEncoder passwordEncoder;
    private final JwtTokenProvider jwtTokenProvider;

    @Override
    @Transactional(readOnly = true) // ì™¸ë¶€ API í˜¸ì¶œ ì—†ìŒ
    public LoginResponse execute(LoginCommand command) {
        // 1. ì‚¬ìš©ì ì¡°íšŒ
        User user = loadUserPort.loadByUsername(command.username())
            .orElseThrow(() -> new UserNotFoundException(command.username()));

        // 2. ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
        if (!passwordEncoder.matches(command.password(), user.password().value())) {
            throw new InvalidPasswordException();
        }

        // 3. ì‚¬ìš©ì ë¡œê·¸ì¸ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        if (!user.canLogin()) {
            throw new UserCannotLoginException(user.id(), user.status());
        }

        // 4. Tenant ì¡°íšŒ ë° ë¡œê·¸ì¸ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        Tenant tenant = loadTenantPort.loadById(user.tenantId())
            .orElseThrow(() -> new TenantNotFoundException(user.tenantId()));

        if (!tenant.canLogin()) {
            throw new TenantCannotLoginException(tenant.id(), tenant.status());
        }

        // 5. Organization ì¡°íšŒ ë° í™œì„±í™” ì—¬ë¶€ í™•ì¸
        Organization organization = loadOrganizationPort.loadById(user.organizationId())
            .orElseThrow(() -> new OrganizationNotFoundException(user.organizationId()));

        if (!organization.isActive()) {
            throw new OrganizationInactiveException(organization.id());
        }

        // 6. ì‚¬ìš©ì ì—­í•  ë° ê¶Œí•œ ì¡°íšŒ
        List<UserRole> userRoles = loadUserRolesPort.loadByUserId(user.id());
        List<Permission> permissions = loadPermissionsForRoles(userRoles);

        // 7. JWT í† í° ìƒì„±
        String accessToken = jwtTokenProvider.createAccessToken(
            user.id(),
            user.tenantId(),
            user.organizationId(),
            extractRoleCodes(userRoles),
            extractPermissions(permissions)
        );

        String refreshToken = jwtTokenProvider.createRefreshToken(user.id());

        // 8. RefreshToken ì €ì¥
        RefreshToken refreshTokenEntity = RefreshToken.create(
            user.id(),
            hashToken(refreshToken),
            tenant.config().refreshTokenExpiryDays()
        );
        saveRefreshTokenPort.save(refreshTokenEntity);

        // 9. AuditLog ì €ì¥
        saveAuditLogPort.save(AuditLog.loginSuccess(
            user.id(),
            user.tenantId(),
            command.ipAddress(),
            command.userAgent()
        ));

        return LoginResponse.of(accessToken, refreshToken);
    }
}
```

**LoginCommand**:
```java
public record LoginCommand(
    String username,
    String password,
    String ipAddress,
    String userAgent
) {
    public LoginCommand {
        requireNonNull(username, "usernameì€ í•„ìˆ˜ì…ë‹ˆë‹¤");
        requireNonNull(password, "passwordëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
    }
}
```

**LoginResponse**:
```java
public record LoginResponse(
    String accessToken,
    String refreshToken,
    long expiresIn
) {
    public static LoginResponse of(String accessToken, String refreshToken) {
        return new LoginResponse(accessToken, refreshToken, 900L); // 15ë¶„
    }
}
```

**ë‹¤ë¥¸ Auth UseCases**:
- `RefreshTokenUseCase`: Refresh Tokenìœ¼ë¡œ Access Token ì¬ë°œê¸‰ (RTR ì ìš©)
- `LogoutUseCase`: Refresh Token ë¬´íš¨í™”
- `ValidateTokenUseCase`: Gatewayìš© JWT ê²€ì¦
- `RevokeAllTokensUseCase`: íŠ¹ì • ì‚¬ìš©ìì˜ ëª¨ë“  Refresh Token ë¬´íš¨í™”

#### 1.2 User UseCases (7ê°œ)

```java
// usecase/user/CreateUserUseCase.java (Command)
public interface CreateUserUseCase {
    CreateUserResponse execute(CreateUserCommand command);
}

@Service
public class CreateUserUseCaseImpl implements CreateUserUseCase {

    private final LoadTenantPort loadTenantPort;
    private final LoadOrganizationPort loadOrganizationPort;
    private final CheckDuplicateUsernamePort checkDuplicateUsernamePort;
    private final CheckDuplicateEmailPort checkDuplicateEmailPort;
    private final SaveUserPort saveUserPort;
    private final SaveAuditLogPort saveAuditLogPort;
    private final PasswordEncoder passwordEncoder;

    @Override
    @Transactional // Command UseCaseëŠ” ê¸°ë³¸ íŠ¸ëœì­ì…˜
    public CreateUserResponse execute(CreateUserCommand command) {
        // 1. Tenant ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        Tenant tenant = loadTenantPort.loadById(command.tenantId())
            .orElseThrow(() -> new TenantNotFoundException(command.tenantId()));

        // 2. Organization ì¡´ì¬ ì—¬ë¶€ ë° í™œì„±í™” í™•ì¸
        Organization organization = loadOrganizationPort.loadById(command.organizationId())
            .orElseThrow(() -> new OrganizationNotFoundException(command.organizationId()));

        if (!organization.isActive()) {
            throw new OrganizationInactiveException(organization.id());
        }

        // 3. ì¤‘ë³µ ì²´í¬
        if (checkDuplicateUsernamePort.exists(command.username())) {
            throw new DuplicateUsernameException(command.username());
        }
        if (checkDuplicateEmailPort.exists(command.email())) {
            throw new DuplicateEmailException(command.email());
        }

        // 4. ì‚¬ìš©ì ìƒì„±
        User user = User.create(
            UUID.randomUUID(),
            command.tenantId(),
            command.organizationId(),
            Username.of(command.username()),
            Email.of(command.email()),
            Password.of(passwordEncoder.encode(command.password())),
            PhoneNumber.of(command.phoneNumber())
        );

        saveUserPort.save(user);

        // 5. AuditLog ì €ì¥
        saveAuditLogPort.save(AuditLog.createUser(
            command.creatorUserId(),
            command.tenantId(),
            user.id()
        ));

        return CreateUserResponse.from(user);
    }
}
```

**ë‹¤ë¥¸ User UseCases**:
- `UpdateUserUseCase`: ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •
- `DeleteUserUseCase`: ì‚¬ìš©ì ì‚­ì œ (Soft Delete)
- `SuspendUserUseCase`: ì‚¬ìš©ì ì •ì§€
- `ChangePasswordUseCase`: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
- `GetUserUseCase` (Query): ì‚¬ìš©ì ì¡°íšŒ
- `SearchUsersUseCase` (Query): ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ (í˜ì´ì§•)

#### 1.3 Organization UseCases (5ê°œ)

```java
// usecase/organization/DeleteOrganizationUseCase.java (Command)
public interface DeleteOrganizationUseCase {
    void execute(DeleteOrganizationCommand command);
}

@Service
public class DeleteOrganizationUseCaseImpl implements DeleteOrganizationUseCase {

    private final LoadOrganizationPort loadOrganizationPort;
    private final CountUsersInOrganizationPort countUsersInOrganizationPort;
    private final SaveOrganizationPort saveOrganizationPort;
    private final SaveAuditLogPort saveAuditLogPort;

    @Override
    @Transactional
    public void execute(DeleteOrganizationCommand command) {
        // 1. ì¡°ì§ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        Organization organization = loadOrganizationPort.loadById(command.organizationId())
            .orElseThrow(() -> new OrganizationNotFoundException(command.organizationId()));

        // 2. í•˜ìœ„ ì‚¬ìš©ì ì¡´ì¬ í™•ì¸
        long userCount = countUsersInOrganizationPort.count(command.organizationId());
        if (userCount > 0) {
            throw new OrganizationHasUsersException(
                command.organizationId(),
                userCount
            );
        }

        // 3. ì¡°ì§ ì‚­ì œ (Soft Delete)
        organization.markAsDeleted();
        saveOrganizationPort.save(organization);

        // 4. AuditLog ì €ì¥
        saveAuditLogPort.save(AuditLog.deleteOrganization(
            command.executorUserId(),
            organization.tenantId(),
            organization.id()
        ));
    }
}
```

**ë‹¤ë¥¸ Organization UseCases**:
- `CreateOrganizationUseCase`: ì¡°ì§ ìƒì„±
- `UpdateOrganizationUseCase`: ì¡°ì§ ì •ë³´ ìˆ˜ì •
- `DeactivateOrganizationUseCase`: ì¡°ì§ ë¹„í™œì„±í™”
- `GetOrganizationUseCase` (Query): ì¡°ì§ ì¡°íšŒ

#### 1.4 Role & Permission UseCases (4ê°œ)

```java
// usecase/role/AssignRoleToUserUseCase.java (Command)
public interface AssignRoleToUserUseCase {
    void execute(AssignRoleCommand command);
}

@Service
public class AssignRoleToUserUseCaseImpl implements AssignRoleToUserUseCase {

    private final LoadUserPort loadUserPort;
    private final LoadRolePort loadRolePort;
    private final SaveUserRolePort saveUserRolePort;
    private final InvalidateUserPermissionCachePort invalidateUserPermissionCachePort;
    private final SaveAuditLogPort saveAuditLogPort;

    @Override
    @Transactional
    public void execute(AssignRoleCommand command) {
        // 1. ì‚¬ìš©ì ì¡´ì¬ í™•ì¸
        User user = loadUserPort.loadById(command.userId())
            .orElseThrow(() -> new UserNotFoundException(command.userId()));

        // 2. ì—­í•  ì¡´ì¬ í™•ì¸
        Role role = loadRolePort.loadById(command.roleId())
            .orElseThrow(() -> new RoleNotFoundException(command.roleId()));

        // 3. UserRole ìƒì„± ë° ì €ì¥
        UserRole userRole = UserRole.create(
            command.userId(),
            command.roleId(),
            command.scope() // "SYSTEM", "TENANT:{tenantId}", "ORG:{orgId}"
        );
        saveUserRolePort.save(userRole);

        // 4. Redis ìºì‹œ ë¬´íš¨í™” (íŠ¸ëœì­ì…˜ ì™„ë£Œ í›„)
        invalidateUserPermissionCachePort.invalidate(command.userId());

        // 5. AuditLog ì €ì¥
        saveAuditLogPort.save(AuditLog.assignRole(
            command.executorUserId(),
            user.tenantId(),
            command.userId(),
            command.roleId(),
            command.scope()
        ));
    }
}
```

**ë‹¤ë¥¸ Role & Permission UseCases**:
- `RevokeRoleFromUserUseCase`: ì—­í•  ì œê±°
- `GetUserPermissionsUseCase` (Query): ì‚¬ìš©ì ê¶Œí•œ ì¡°íšŒ (ìºì‹œ í™œìš©)
- `GetRolePermissionsUseCase` (Query): ì—­í• ë³„ ê¶Œí•œ ì¡°íšŒ

#### 1.5 Tenant UseCases (3ê°œ)

```java
// usecase/tenant/CreateTenantUseCase.java (Command)
public interface CreateTenantUseCase {
    CreateTenantResponse execute(CreateTenantCommand command);
}

@Service
public class CreateTenantUseCaseImpl implements CreateTenantUseCase {

    private final SaveTenantPort saveTenantPort;
    private final SaveAuditLogPort saveAuditLogPort;

    @Override
    @Transactional
    public CreateTenantResponse execute(CreateTenantCommand command) {
        // 1. Tenant ìƒì„±
        Tenant tenant = Tenant.create(
            UUID.randomUUID(),
            TenantName.of(command.name()),
            TenantConfig.defaultConfig()
        );

        saveTenantPort.save(tenant);

        // 2. AuditLog ì €ì¥
        saveAuditLogPort.save(AuditLog.createTenant(
            command.creatorUserId(),
            tenant.id()
        ));

        return CreateTenantResponse.from(tenant);
    }
}
```

**ë‹¤ë¥¸ Tenant UseCases**:
- `UpdateTenantUseCase`: í…Œë„ŒíŠ¸ ì •ë³´ ìˆ˜ì •
- `SuspendTenantUseCase`: í…Œë„ŒíŠ¸ ì •ì§€

---

### 2. Ports ì •ì˜ (Command/Query ë¶„ë¦¬)

#### 2.1 Command Ports (Out)

```java
// port/out/command/SaveUserPort.java
public interface SaveUserPort {
    User save(User user);
}

// port/out/command/SaveOrganizationPort.java
public interface SaveOrganizationPort {
    Organization save(Organization organization);
}

// port/out/command/SaveRefreshTokenPort.java
public interface SaveRefreshTokenPort {
    RefreshToken save(RefreshToken refreshToken);
}

// port/out/command/SaveAuditLogPort.java
public interface SaveAuditLogPort {
    void save(AuditLog auditLog);
}

// port/out/command/InvalidateUserPermissionCachePort.java
public interface InvalidateUserPermissionCachePort {
    void invalidate(UUID userId);
}
```

#### 2.2 Query Ports (Out)

```java
// port/out/query/LoadUserPort.java
public interface LoadUserPort {
    Optional<User> loadById(UUID userId);
    Optional<User> loadByUsername(String username);
    Optional<User> loadByEmail(String email);
}

// port/out/query/LoadTenantPort.java
public interface LoadTenantPort {
    Optional<Tenant> loadById(UUID tenantId);
}

// port/out/query/LoadOrganizationPort.java
public interface LoadOrganizationPort {
    Optional<Organization> loadById(UUID organizationId);
}

// port/out/query/LoadUserRolesPort.java
public interface LoadUserRolesPort {
    List<UserRole> loadByUserId(UUID userId);
}

// port/out/query/CheckDuplicateUsernamePort.java
public interface CheckDuplicateUsernamePort {
    boolean exists(String username);
}

// port/out/query/CountUsersInOrganizationPort.java
public interface CountUsersInOrganizationPort {
    long count(UUID organizationId);
}
```

---

### 3. Assembler êµ¬í˜„ (Domain â†” DTO)

```java
// assembler/UserAssembler.java
@Component
public class UserAssembler {

    public User toDomain(CreateUserCommand command) {
        return User.create(
            UUID.randomUUID(),
            command.tenantId(),
            command.organizationId(),
            Username.of(command.username()),
            Email.of(command.email()),
            Password.of(command.password()), // ì´ë¯¸ ì¸ì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸
            PhoneNumber.of(command.phoneNumber())
        );
    }

    public UserResponse toResponse(User user) {
        return new UserResponse(
            user.id(),
            user.tenantId(),
            user.organizationId(),
            user.username().value(),
            user.email().value(),
            user.phoneNumber().value(),
            user.status(),
            user.createdAt(),
            user.updatedAt()
        );
    }

    public List<UserResponse> toResponses(List<User> users) {
        return users.stream()
            .map(this::toResponse)
            .toList();
    }
}
```

**Assembler ê·œì¹™**:
- Domain â†’ Response: ëª¨ë“  í•„ë“œ ë§¤í•‘
- Command â†’ Domain: VO ë³€í™˜ ë° ê²€ì¦
- VOì˜ value() ë©”ì„œë“œ í˜¸ì¶œí•˜ì—¬ ì›ì‹œ íƒ€ì… ì¶”ì¶œ

---

## âœ… Zero-Tolerance Rules Checklist

### Application Layer í•„ìˆ˜ ê·œì¹™

- [ ] **Transaction ê²½ê³„**: `@Transactional` ë‚´ ì™¸ë¶€ API í˜¸ì¶œ ì ˆëŒ€ ê¸ˆì§€
- [ ] **CQRS ë¶„ë¦¬**: Command/Query UseCase ëª…í™•íˆ ë¶„ë¦¬
- [ ] **Assembler ì‚¬ìš©**: Domain â†” DTO ë³€í™˜ì€ Assemblerì—ì„œë§Œ
- [ ] **Port ì¸í„°í˜ì´ìŠ¤**: ëª¨ë“  ì™¸ë¶€ ì˜ì¡´ì„±ì€ Portë¡œ ì¶”ìƒí™”
- [ ] **CommandëŠ” Transactional**: ê¸°ë³¸ì ìœ¼ë¡œ `@Transactional` ì ìš©
- [ ] **QueryëŠ” readOnly**: ì¡°íšŒëŠ” `@Transactional(readOnly = true)`
- [ ] **UseCase ë‹¨ì¼ ì±…ì„**: í•˜ë‚˜ì˜ UseCaseëŠ” í•˜ë‚˜ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ
- [ ] **Domain ê°ì²´ ì§ì ‘ ë°˜í™˜ ê¸ˆì§€**: í•­ìƒ Response DTOë¡œ ë³€í™˜

### ê¸ˆì§€ëœ íŒ¨í„´ ì˜ˆì‹œ

âŒ **ì˜ëª»ëœ ì˜ˆ (Transaction ë‚´ ì™¸ë¶€ API í˜¸ì¶œ)**:
```java
@Transactional
public void execute(CreateUserCommand command) {
    User user = createUser(command);
    saveUserPort.save(user);

    // âŒ Transaction ë‚´ ì™¸ë¶€ API í˜¸ì¶œ ê¸ˆì§€!
    emailService.sendWelcomeEmail(user.email());
}
```

âœ… **ì˜¬ë°”ë¥¸ ì˜ˆ (Event ë°œí–‰ìœ¼ë¡œ ë¶„ë¦¬)**:
```java
@Transactional
public void execute(CreateUserCommand command) {
    User user = createUser(command);
    saveUserPort.save(user);

    // âœ… Event ë°œí–‰ (íŠ¸ëœì­ì…˜ ì™„ë£Œ í›„ Listenerê°€ ì²˜ë¦¬)
    eventPublisher.publish(new UserCreatedEvent(user.id()));
}

@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void handleUserCreated(UserCreatedEvent event) {
    emailService.sendWelcomeEmail(event.userId());
}
```

âŒ **ì˜ëª»ëœ ì˜ˆ (Domain ê°ì²´ ì§ì ‘ ë°˜í™˜)**:
```java
public User execute(GetUserQuery query) {
    return loadUserPort.loadById(query.userId())
        .orElseThrow(() -> new UserNotFoundException(query.userId()));
}
```

âœ… **ì˜¬ë°”ë¥¸ ì˜ˆ (Response DTO ë°˜í™˜)**:
```java
public UserResponse execute(GetUserQuery query) {
    User user = loadUserPort.loadById(query.userId())
        .orElseThrow(() -> new UserNotFoundException(query.userId()));

    return userAssembler.toResponse(user);
}
```

---

## ğŸ§ª Test Rules

### 1. Test íŒŒì¼ ìœ„ì¹˜
```
application/src/test/java/com/ryuqq/authhub/application/
â”œâ”€â”€ usecase/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ LoginUseCaseTest.java
â”‚   â”‚   â”œâ”€â”€ RefreshTokenUseCaseTest.java
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ CreateUserUseCaseTest.java
â”‚   â”‚   â”œâ”€â”€ UpdateUserUseCaseTest.java
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ organization/
â”‚       â””â”€â”€ DeleteOrganizationUseCaseTest.java
â””â”€â”€ assembler/
    â””â”€â”€ UserAssemblerTest.java
```

### 2. Test ì‘ì„± ê·œì¹™

**UseCase í…ŒìŠ¤íŠ¸ (Mock ê¸°ë°˜)**:
```java
@ExtendWith(MockitoExtension.class)
@DisplayName("CreateUserUseCase í…ŒìŠ¤íŠ¸")
class CreateUserUseCaseTest {

    @Mock
    private LoadTenantPort loadTenantPort;

    @Mock
    private LoadOrganizationPort loadOrganizationPort;

    @Mock
    private CheckDuplicateUsernamePort checkDuplicateUsernamePort;

    @Mock
    private CheckDuplicateEmailPort checkDuplicateEmailPort;

    @Mock
    private SaveUserPort saveUserPort;

    @Mock
    private SaveAuditLogPort saveAuditLogPort;

    @Mock
    private PasswordEncoder passwordEncoder;

    @InjectMocks
    private CreateUserUseCaseImpl createUserUseCase;

    @Test
    @DisplayName("ì‚¬ìš©ì ìƒì„± ì„±ê³µ")
    void execute_Success() {
        // Given
        UUID tenantId = UUID.randomUUID();
        UUID orgId = UUID.randomUUID();
        CreateUserCommand command = new CreateUserCommand(
            tenantId,
            orgId,
            "testuser",
            "test@example.com",
            "Password123",
            "+821012345678",
            UUID.randomUUID() // creatorUserId
        );

        Tenant tenant = TenantFixture.active();
        Organization organization = OrganizationFixture.active(tenantId, orgId);

        when(loadTenantPort.loadById(tenantId)).thenReturn(Optional.of(tenant));
        when(loadOrganizationPort.loadById(orgId)).thenReturn(Optional.of(organization));
        when(checkDuplicateUsernamePort.exists("testuser")).thenReturn(false);
        when(checkDuplicateEmailPort.exists("test@example.com")).thenReturn(false);
        when(passwordEncoder.encode("Password123")).thenReturn("$2a$10$hashedPassword");
        when(saveUserPort.save(any(User.class))).thenAnswer(invocation -> invocation.getArgument(0));

        // When
        CreateUserResponse response = createUserUseCase.execute(command);

        // Then
        assertThat(response).isNotNull();
        assertThat(response.username()).isEqualTo("testuser");

        verify(saveUserPort, times(1)).save(any(User.class));
        verify(saveAuditLogPort, times(1)).save(any(AuditLog.class));
    }

    @Test
    @DisplayName("ì¤‘ë³µëœ usernameìœ¼ë¡œ ìƒì„± ì‹¤íŒ¨")
    void execute_DuplicateUsername_ThrowsException() {
        // Given
        CreateUserCommand command = CreateUserCommandFixture.create();

        when(loadTenantPort.loadById(any())).thenReturn(Optional.of(TenantFixture.active()));
        when(loadOrganizationPort.loadById(any())).thenReturn(Optional.of(OrganizationFixture.active()));
        when(checkDuplicateUsernamePort.exists(command.username())).thenReturn(true);

        // When & Then
        assertThatThrownBy(() -> createUserUseCase.execute(command))
            .isInstanceOf(DuplicateUsernameException.class)
            .hasMessageContaining("U006");

        verify(saveUserPort, never()).save(any());
    }

    @Test
    @DisplayName("Organizationì´ ë¹„í™œì„±í™” ìƒíƒœì¼ ë•Œ ìƒì„± ì‹¤íŒ¨")
    void execute_InactiveOrganization_ThrowsException() {
        // Given
        CreateUserCommand command = CreateUserCommandFixture.create();
        Organization inactiveOrg = OrganizationFixture.inactive();

        when(loadTenantPort.loadById(any())).thenReturn(Optional.of(TenantFixture.active()));
        when(loadOrganizationPort.loadById(any())).thenReturn(Optional.of(inactiveOrg));

        // When & Then
        assertThatThrownBy(() -> createUserUseCase.execute(command))
            .isInstanceOf(OrganizationInactiveException.class);
    }
}
```

**Assembler í…ŒìŠ¤íŠ¸**:
```java
@DisplayName("UserAssembler í…ŒìŠ¤íŠ¸")
class UserAssemblerTest {

    private UserAssembler userAssembler;

    @BeforeEach
    void setUp() {
        userAssembler = new UserAssembler();
    }

    @Test
    @DisplayName("Userë¥¼ UserResponseë¡œ ë³€í™˜ ì„±ê³µ")
    void toResponse_Success() {
        // Given
        User user = UserFixture.active();

        // When
        UserResponse response = userAssembler.toResponse(user);

        // Then
        assertThat(response.id()).isEqualTo(user.id());
        assertThat(response.username()).isEqualTo(user.username().value());
        assertThat(response.email()).isEqualTo(user.email().value());
    }
}
```

### 3. Test Coverage ëª©í‘œ
- **UseCase**: 90% ì´ìƒ (ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ ì‹œë‚˜ë¦¬ì˜¤)
- **Assembler**: 100% (ë³€í™˜ ë¡œì§)

---

## ğŸ¯ Completion Criteria

### 1. êµ¬í˜„ ì™„ë£Œ ì¡°ê±´
- [ ] 24ê°œ UseCase ëª¨ë‘ êµ¬í˜„ ì™„ë£Œ (18 Command + 6 Query)
- [ ] Port ì¸í„°í˜ì´ìŠ¤ ëª¨ë‘ ì •ì˜ ì™„ë£Œ
- [ ] Assembler ëª¨ë‘ êµ¬í˜„ ì™„ë£Œ
- [ ] ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ (Unit Test 90% ì´ìƒ)
- [ ] ArchUnit ê²€ì¦ í†µê³¼

### 2. ArchUnit ê²€ì¦ í•­ëª©
```java
@ArchTest
static final ArchRule usecases_should_not_depend_on_adapters =
    noClasses()
        .that().resideInAPackage("..application.usecase..")
        .should().dependOnClassesThat()
        .resideInAnyPackage("..adapter..");

@ArchTest
static final ArchRule command_usecases_should_be_transactional =
    classes()
        .that().resideInAPackage("..application.usecase..")
        .and().haveSimpleNameEndingWith("UseCaseImpl")
        .and().haveSimpleNameContaining("Create", "Update", "Delete", "Assign", "Revoke")
        .should().beAnnotatedWith(Transactional.class);

@ArchTest
static final ArchRule ports_should_be_interfaces =
    classes()
        .that().resideInAPackage("..application.port..")
        .should().beInterfaces();
```

### 3. Code Review Checklist
- [ ] Transaction ê²½ê³„ ì ì ˆì„± í™•ì¸
- [ ] CQRS ë¶„ë¦¬ í™•ì¸
- [ ] Port ì¸í„°í˜ì´ìŠ¤ ëª…ëª… ê·œì¹™ í™•ì¸
- [ ] Assembler ì‚¬ìš© í™•ì¸
- [ ] Domain ê°ì²´ ì§ì ‘ ë…¸ì¶œ ì—¬ë¶€ í™•ì¸

---

## ğŸ“š Related Documents

- [Application Layer Guide](../../docs/coding_convention/03-application-layer/application-guide.md)
- [UseCase Transaction Guide](../../docs/coding_convention/03-application-layer/manager/transaction-manager-guide.md)
- [Assembler Guide](../../docs/coding_convention/03-application-layer/assembler/assembler-guide.md)
- [Port Guide (In)](../../docs/coding_convention/03-application-layer/port/in/command/command-port-guide.md)
- [Port Guide (Out)](../../docs/coding_convention/03-application-layer/port/out/command/command-port-guide.md)
- [PRD: B2B AuthHub](../b2b-auth-hub.md)

---

## ğŸ”„ Kent Beck TDD Commands

```bash
# Application Layer TDD ì‚¬ì´í´ ì‹¤í–‰
/kb/application/go          # Plan íŒŒì¼ ê¸°ë°˜ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
/kb/application/red         # Red: test: ì»¤ë°‹
/kb/application/green       # Green: feat: ì»¤ë°‹
/kb/application/refactor    # Refactor: struct: ì»¤ë°‹
```

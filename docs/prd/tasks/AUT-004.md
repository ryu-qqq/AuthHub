# AUT-004: REST API Layer êµ¬í˜„

**Epic**: B2B AuthHub - ë©€í‹° í…Œë„ŒíŠ¸ ì¸ì¦/ì¸ê°€ ì‹œìŠ¤í…œ
**Issue Key**: AUT-004
**Layer**: REST API Layer
**Branch**: `feature/AUT-004-rest-api-layer`
**Jira Epic**: [AUT-73](https://ryuqqq.atlassian.net/browse/AUT-73)
**Jira Issue**: [AUT-77](https://ryuqqq.atlassian.net/browse/AUT-77)

---

## ğŸ“‹ Purpose

B2B AuthHubì˜ HTTP APIë¥¼ ì œê³µí•˜ëŠ” REST API Layerë¥¼ TDDë¡œ ê°œë°œí•©ë‹ˆë‹¤.

**í•µì‹¬ ì›ì¹™**:
- RESTful API ì„¤ê³„ ì›ì¹™ ì¤€ìˆ˜
- Request/Response DTO íŒ¨í„´ ì—„ê²© ì ìš©
- `@Valid` ê²€ì¦ í•„ìˆ˜
- MockMvc ê¸ˆì§€, TestRestTemplate í•„ìˆ˜ ì‚¬ìš©
- Spring REST Docsë¡œ API ë¬¸ì„œ ìë™ ìƒì„±

---

## ğŸ¯ Requirements

### 1. API Endpoints êµ¬í˜„ (27ê°œ)

#### 1.1 Auth Endpoints (5ê°œ)

```java
// controller/AuthController.java
@RestController
@RequestMapping("/api/v1/auth")
public class AuthController {

    private final LoginUseCase loginUseCase;
    private final RefreshTokenUseCase refreshTokenUseCase;
    private final LogoutUseCase logoutUseCase;
    private final ValidateTokenUseCase validateTokenUseCase;
    private final RevokeAllTokensUseCase revokeAllTokensUseCase;

    public AuthController(
        LoginUseCase loginUseCase,
        RefreshTokenUseCase refreshTokenUseCase,
        LogoutUseCase logoutUseCase,
        ValidateTokenUseCase validateTokenUseCase,
        RevokeAllTokensUseCase revokeAllTokensUseCase
    ) {
        this.loginUseCase = loginUseCase;
        this.refreshTokenUseCase = refreshTokenUseCase;
        this.logoutUseCase = logoutUseCase;
        this.validateTokenUseCase = validateTokenUseCase;
        this.revokeAllTokensUseCase = revokeAllTokensUseCase;
    }

    @PostMapping("/login")
    public ResponseEntity<LoginResponseDto> login(
        @Valid @RequestBody LoginRequestDto request,
        HttpServletRequest httpRequest
    ) {
        LoginCommand command = new LoginCommand(
            request.username(),
            request.password(),
            httpRequest.getRemoteAddr(),
            httpRequest.getHeader("User-Agent")
        );

        LoginResponse response = loginUseCase.execute(command);

        return ResponseEntity.ok(LoginResponseDto.from(response));
    }

    @PostMapping("/refresh")
    public ResponseEntity<RefreshTokenResponseDto> refresh(
        @Valid @RequestBody RefreshTokenRequestDto request
    ) {
        RefreshTokenCommand command = new RefreshTokenCommand(request.refreshToken());
        RefreshTokenResponse response = refreshTokenUseCase.execute(command);

        return ResponseEntity.ok(RefreshTokenResponseDto.from(response));
    }

    @PostMapping("/logout")
    public ResponseEntity<Void> logout(
        @Valid @RequestBody LogoutRequestDto request
    ) {
        LogoutCommand command = new LogoutCommand(request.refreshToken());
        logoutUseCase.execute(command);

        return ResponseEntity.noContent().build();
    }

    @PostMapping("/validate")
    public ResponseEntity<ValidateTokenResponseDto> validate(
        @Valid @RequestBody ValidateTokenRequestDto request
    ) {
        ValidateTokenCommand command = new ValidateTokenCommand(request.accessToken());
        ValidateTokenResponse response = validateTokenUseCase.execute(command);

        return ResponseEntity.ok(ValidateTokenResponseDto.from(response));
    }

    @PostMapping("/revoke-all")
    public ResponseEntity<Void> revokeAll(
        @Valid @RequestBody RevokeAllTokensRequestDto request
    ) {
        RevokeAllTokensCommand command = new RevokeAllTokensCommand(request.userId());
        revokeAllTokensUseCase.execute(command);

        return ResponseEntity.noContent().build();
    }
}
```

**Request/Response DTOs**:
```java
// dto/request/LoginRequestDto.java
public record LoginRequestDto(
    @NotBlank(message = "usernameì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(min = 3, max = 50, message = "usernameì€ 3-50ìì—¬ì•¼ í•©ë‹ˆë‹¤")
    String username,

    @NotBlank(message = "passwordëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(min = 8, message = "passwordëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤")
    String password
) {}

// dto/response/LoginResponseDto.java
public record LoginResponseDto(
    String accessToken,
    String refreshToken,
    long expiresIn
) {
    public static LoginResponseDto from(LoginResponse response) {
        return new LoginResponseDto(
            response.accessToken(),
            response.refreshToken(),
            response.expiresIn()
        );
    }
}

// dto/request/RefreshTokenRequestDto.java
public record RefreshTokenRequestDto(
    @NotBlank(message = "refreshTokenì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    String refreshToken
) {}

// dto/response/RefreshTokenResponseDto.java
public record RefreshTokenResponseDto(
    String accessToken,
    String refreshToken,
    long expiresIn
) {
    public static RefreshTokenResponseDto from(RefreshTokenResponse response) {
        return new RefreshTokenResponseDto(
            response.accessToken(),
            response.refreshToken(),
            response.expiresIn()
        );
    }
}

// dto/request/ValidateTokenRequestDto.java
public record ValidateTokenRequestDto(
    @NotBlank(message = "accessTokenì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    String accessToken
) {}

// dto/response/ValidateTokenResponseDto.java
public record ValidateTokenResponseDto(
    UUID userId,
    UUID tenantId,
    UUID organizationId,
    List<String> roles,
    List<String> permissions
) {
    public static ValidateTokenResponseDto from(ValidateTokenResponse response) {
        return new ValidateTokenResponseDto(
            response.userId(),
            response.tenantId(),
            response.organizationId(),
            response.roles(),
            response.permissions()
        );
    }
}
```

#### 1.2 User Endpoints (7ê°œ)

```java
// controller/UserController.java
@RestController
@RequestMapping("/api/v1/users")
public class UserController {

    private final CreateUserUseCase createUserUseCase;
    private final UpdateUserUseCase updateUserUseCase;
    private final DeleteUserUseCase deleteUserUseCase;
    private final SuspendUserUseCase suspendUserUseCase;
    private final ChangePasswordUseCase changePasswordUseCase;
    private final GetUserUseCase getUserUseCase;
    private final SearchUsersUseCase searchUsersUseCase;

    public UserController(
        CreateUserUseCase createUserUseCase,
        UpdateUserUseCase updateUserUseCase,
        DeleteUserUseCase deleteUserUseCase,
        SuspendUserUseCase suspendUserUseCase,
        ChangePasswordUseCase changePasswordUseCase,
        GetUserUseCase getUserUseCase,
        SearchUsersUseCase searchUsersUseCase
    ) {
        this.createUserUseCase = createUserUseCase;
        this.updateUserUseCase = updateUserUseCase;
        this.deleteUserUseCase = deleteUserUseCase;
        this.suspendUserUseCase = suspendUserUseCase;
        this.changePasswordUseCase = changePasswordUseCase;
        this.getUserUseCase = getUserUseCase;
        this.searchUsersUseCase = searchUsersUseCase;
    }

    @PostMapping
    public ResponseEntity<CreateUserResponseDto> create(
        @Valid @RequestBody CreateUserRequestDto request
    ) {
        CreateUserCommand command = new CreateUserCommand(
            request.tenantId(),
            request.organizationId(),
            request.username(),
            request.email(),
            request.password(),
            request.phoneNumber(),
            extractUserIdFromSecurityContext() // Spring Securityì—ì„œ ì¶”ì¶œ
        );

        CreateUserResponse response = createUserUseCase.execute(command);

        return ResponseEntity
            .status(HttpStatus.CREATED)
            .body(CreateUserResponseDto.from(response));
    }

    @GetMapping("/{userId}")
    public ResponseEntity<GetUserResponseDto> get(@PathVariable UUID userId) {
        GetUserQuery query = new GetUserQuery(userId);
        GetUserResponse response = getUserUseCase.execute(query);

        return ResponseEntity.ok(GetUserResponseDto.from(response));
    }

    @GetMapping
    public ResponseEntity<PagedResponseDto<UserListItemDto>> search(
        @RequestParam(required = false) UUID tenantId,
        @RequestParam(required = false) UUID organizationId,
        @RequestParam(required = false) String username,
        @RequestParam(required = false) UserStatus status,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "20") int size
    ) {
        SearchUsersQuery query = new SearchUsersQuery(
            tenantId,
            organizationId,
            username,
            status,
            page,
            size
        );

        SearchUsersResponse response = searchUsersUseCase.execute(query);

        return ResponseEntity.ok(PagedResponseDto.from(
            response.users(),
            response.totalElements(),
            response.totalPages(),
            response.currentPage()
        ));
    }

    @PutMapping("/{userId}")
    public ResponseEntity<UpdateUserResponseDto> update(
        @PathVariable UUID userId,
        @Valid @RequestBody UpdateUserRequestDto request
    ) {
        UpdateUserCommand command = new UpdateUserCommand(
            userId,
            request.email(),
            request.phoneNumber(),
            extractUserIdFromSecurityContext()
        );

        UpdateUserResponse response = updateUserUseCase.execute(command);

        return ResponseEntity.ok(UpdateUserResponseDto.from(response));
    }

    @DeleteMapping("/{userId}")
    public ResponseEntity<Void> delete(@PathVariable UUID userId) {
        DeleteUserCommand command = new DeleteUserCommand(
            userId,
            extractUserIdFromSecurityContext()
        );

        deleteUserUseCase.execute(command);

        return ResponseEntity.noContent().build();
    }

    @PostMapping("/{userId}/suspend")
    public ResponseEntity<Void> suspend(
        @PathVariable UUID userId,
        @Valid @RequestBody SuspendUserRequestDto request
    ) {
        SuspendUserCommand command = new SuspendUserCommand(
            userId,
            request.reason(),
            extractUserIdFromSecurityContext()
        );

        suspendUserUseCase.execute(command);

        return ResponseEntity.noContent().build();
    }

    @PostMapping("/{userId}/change-password")
    public ResponseEntity<Void> changePassword(
        @PathVariable UUID userId,
        @Valid @RequestBody ChangePasswordRequestDto request
    ) {
        ChangePasswordCommand command = new ChangePasswordCommand(
            userId,
            request.oldPassword(),
            request.newPassword()
        );

        changePasswordUseCase.execute(command);

        return ResponseEntity.noContent().build();
    }

    private UUID extractUserIdFromSecurityContext() {
        // Spring Securityì—ì„œ í˜„ì¬ ì‚¬ìš©ì ID ì¶”ì¶œ
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        return UUID.fromString(authentication.getName());
    }
}
```

**Request DTOs**:
```java
// dto/request/CreateUserRequestDto.java
public record CreateUserRequestDto(
    @NotNull(message = "tenantIdëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    UUID tenantId,

    @NotNull(message = "organizationIdëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    UUID organizationId,

    @NotBlank(message = "usernameì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(min = 3, max = 50, message = "usernameì€ 3-50ìì—¬ì•¼ í•©ë‹ˆë‹¤")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "usernameì€ ì˜ë¬¸, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤")
    String username,

    @NotBlank(message = "emailì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Email(message = "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤")
    String email,

    @NotBlank(message = "passwordëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(min = 8, message = "passwordëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤")
    @Pattern(
        regexp = "^(?=.*[A-Za-z])(?=.*\\d).+$",
        message = "passwordëŠ” ì˜ë¬¸ê³¼ ìˆ«ìë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤"
    )
    String password,

    @NotBlank(message = "phoneNumberëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Pattern(regexp = "^\\+[1-9]\\d{1,14}$", message = "E.164 í¬ë§·ì´ ì•„ë‹™ë‹ˆë‹¤ (ì˜ˆ: +821012345678)")
    String phoneNumber
) {}

// dto/request/UpdateUserRequestDto.java
public record UpdateUserRequestDto(
    @Email(message = "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤")
    String email,

    @Pattern(regexp = "^\\+[1-9]\\d{1,14}$", message = "E.164 í¬ë§·ì´ ì•„ë‹™ë‹ˆë‹¤")
    String phoneNumber
) {}

// dto/request/ChangePasswordRequestDto.java
public record ChangePasswordRequestDto(
    @NotBlank(message = "oldPasswordëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    String oldPassword,

    @NotBlank(message = "newPasswordëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(min = 8, message = "newPasswordëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤")
    @Pattern(
        regexp = "^(?=.*[A-Za-z])(?=.*\\d).+$",
        message = "newPasswordëŠ” ì˜ë¬¸ê³¼ ìˆ«ìë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤"
    )
    String newPassword
) {}
```

**Response DTOs**:
```java
// dto/response/CreateUserResponseDto.java
public record CreateUserResponseDto(
    UUID id,
    String username,
    String email,
    UserStatus status,
    LocalDateTime createdAt
) {
    public static CreateUserResponseDto from(CreateUserResponse response) {
        return new CreateUserResponseDto(
            response.id(),
            response.username(),
            response.email(),
            response.status(),
            response.createdAt()
        );
    }
}

// dto/response/GetUserResponseDto.java
public record GetUserResponseDto(
    UUID id,
    UUID tenantId,
    UUID organizationId,
    String username,
    String email,
    String phoneNumber,
    UserStatus status,
    LocalDateTime createdAt,
    LocalDateTime updatedAt
) {
    public static GetUserResponseDto from(GetUserResponse response) {
        return new GetUserResponseDto(
            response.id(),
            response.tenantId(),
            response.organizationId(),
            response.username(),
            response.email(),
            response.phoneNumber(),
            response.status(),
            response.createdAt(),
            response.updatedAt()
        );
    }
}

// dto/response/PagedResponseDto.java
public record PagedResponseDto<T>(
    List<T> content,
    long totalElements,
    int totalPages,
    int currentPage,
    int pageSize
) {
    public static <T> PagedResponseDto<T> from(
        List<T> content,
        long totalElements,
        int totalPages,
        int currentPage
    ) {
        return new PagedResponseDto<>(
            content,
            totalElements,
            totalPages,
            currentPage,
            content.size()
        );
    }
}
```

#### 1.3 Organization Endpoints (5ê°œ)

```java
// controller/OrganizationController.java
@RestController
@RequestMapping("/api/v1/organizations")
public class OrganizationController {

    private final CreateOrganizationUseCase createOrganizationUseCase;
    private final UpdateOrganizationUseCase updateOrganizationUseCase;
    private final DeleteOrganizationUseCase deleteOrganizationUseCase;
    private final DeactivateOrganizationUseCase deactivateOrganizationUseCase;
    private final GetOrganizationUseCase getOrganizationUseCase;

    @PostMapping
    public ResponseEntity<CreateOrganizationResponseDto> create(
        @Valid @RequestBody CreateOrganizationRequestDto request
    ) {
        CreateOrganizationCommand command = new CreateOrganizationCommand(
            request.tenantId(),
            request.name(),
            extractUserIdFromSecurityContext()
        );

        CreateOrganizationResponse response = createOrganizationUseCase.execute(command);

        return ResponseEntity
            .status(HttpStatus.CREATED)
            .body(CreateOrganizationResponseDto.from(response));
    }

    @GetMapping("/{organizationId}")
    public ResponseEntity<GetOrganizationResponseDto> get(@PathVariable UUID organizationId) {
        GetOrganizationQuery query = new GetOrganizationQuery(organizationId);
        GetOrganizationResponse response = getOrganizationUseCase.execute(query);

        return ResponseEntity.ok(GetOrganizationResponseDto.from(response));
    }

    @PutMapping("/{organizationId}")
    public ResponseEntity<UpdateOrganizationResponseDto> update(
        @PathVariable UUID organizationId,
        @Valid @RequestBody UpdateOrganizationRequestDto request
    ) {
        UpdateOrganizationCommand command = new UpdateOrganizationCommand(
            organizationId,
            request.name(),
            extractUserIdFromSecurityContext()
        );

        UpdateOrganizationResponse response = updateOrganizationUseCase.execute(command);

        return ResponseEntity.ok(UpdateOrganizationResponseDto.from(response));
    }

    @DeleteMapping("/{organizationId}")
    public ResponseEntity<Void> delete(@PathVariable UUID organizationId) {
        DeleteOrganizationCommand command = new DeleteOrganizationCommand(
            organizationId,
            extractUserIdFromSecurityContext()
        );

        deleteOrganizationUseCase.execute(command);

        return ResponseEntity.noContent().build();
    }

    @PostMapping("/{organizationId}/deactivate")
    public ResponseEntity<Void> deactivate(
        @PathVariable UUID organizationId,
        @Valid @RequestBody DeactivateOrganizationRequestDto request
    ) {
        DeactivateOrganizationCommand command = new DeactivateOrganizationCommand(
            organizationId,
            request.reason(),
            extractUserIdFromSecurityContext()
        );

        deactivateOrganizationUseCase.execute(command);

        return ResponseEntity.noContent().build();
    }
}
```

#### 1.4 Role & Permission Endpoints (4ê°œ)

```java
// controller/RoleController.java
@RestController
@RequestMapping("/api/v1/roles")
public class RoleController {

    private final AssignRoleToUserUseCase assignRoleToUserUseCase;
    private final RevokeRoleFromUserUseCase revokeRoleFromUserUseCase;
    private final GetUserPermissionsUseCase getUserPermissionsUseCase;
    private final GetRolePermissionsUseCase getRolePermissionsUseCase;

    @PostMapping("/assign")
    public ResponseEntity<Void> assignRole(
        @Valid @RequestBody AssignRoleRequestDto request
    ) {
        AssignRoleCommand command = new AssignRoleCommand(
            request.userId(),
            request.roleId(),
            request.scope(),
            extractUserIdFromSecurityContext()
        );

        assignRoleToUserUseCase.execute(command);

        return ResponseEntity.noContent().build();
    }

    @PostMapping("/revoke")
    public ResponseEntity<Void> revokeRole(
        @Valid @RequestBody RevokeRoleRequestDto request
    ) {
        RevokeRoleCommand command = new RevokeRoleCommand(
            request.userId(),
            request.roleId(),
            extractUserIdFromSecurityContext()
        );

        revokeRoleFromUserUseCase.execute(command);

        return ResponseEntity.noContent().build();
    }

    @GetMapping("/users/{userId}/permissions")
    public ResponseEntity<GetUserPermissionsResponseDto> getUserPermissions(
        @PathVariable UUID userId
    ) {
        GetUserPermissionsQuery query = new GetUserPermissionsQuery(userId);
        GetUserPermissionsResponse response = getUserPermissionsUseCase.execute(query);

        return ResponseEntity.ok(GetUserPermissionsResponseDto.from(response));
    }

    @GetMapping("/{roleId}/permissions")
    public ResponseEntity<GetRolePermissionsResponseDto> getRolePermissions(
        @PathVariable UUID roleId
    ) {
        GetRolePermissionsQuery query = new GetRolePermissionsQuery(roleId);
        GetRolePermissionsResponse response = getRolePermissionsUseCase.execute(query);

        return ResponseEntity.ok(GetRolePermissionsResponseDto.from(response));
    }
}
```

#### 1.5 Tenant Endpoints (2ê°œ)

```java
// controller/TenantController.java
@RestController
@RequestMapping("/api/v1/tenants")
public class TenantController {

    private final CreateTenantUseCase createTenantUseCase;
    private final UpdateTenantUseCase updateTenantUseCase;
    private final SuspendTenantUseCase suspendTenantUseCase;

    @PostMapping
    public ResponseEntity<CreateTenantResponseDto> create(
        @Valid @RequestBody CreateTenantRequestDto request
    ) {
        CreateTenantCommand command = new CreateTenantCommand(
            request.name(),
            extractUserIdFromSecurityContext()
        );

        CreateTenantResponse response = createTenantUseCase.execute(command);

        return ResponseEntity
            .status(HttpStatus.CREATED)
            .body(CreateTenantResponseDto.from(response));
    }

    @PutMapping("/{tenantId}")
    public ResponseEntity<UpdateTenantResponseDto> update(
        @PathVariable UUID tenantId,
        @Valid @RequestBody UpdateTenantRequestDto request
    ) {
        UpdateTenantCommand command = new UpdateTenantCommand(
            tenantId,
            request.name(),
            request.config(),
            extractUserIdFromSecurityContext()
        );

        UpdateTenantResponse response = updateTenantUseCase.execute(command);

        return ResponseEntity.ok(UpdateTenantResponseDto.from(response));
    }

    @PostMapping("/{tenantId}/suspend")
    public ResponseEntity<Void> suspend(
        @PathVariable UUID tenantId,
        @Valid @RequestBody SuspendTenantRequestDto request
    ) {
        SuspendTenantCommand command = new SuspendTenantCommand(
            tenantId,
            request.reason(),
            extractUserIdFromSecurityContext()
        );

        suspendTenantUseCase.execute(command);

        return ResponseEntity.noContent().build();
    }
}
```

---

### 2. Global Exception Handler

```java
// error/GlobalExceptionHandler.java
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(DomainException.class)
    public ResponseEntity<ErrorResponseDto> handleDomainException(DomainException ex) {
        ErrorResponseDto error = new ErrorResponseDto(
            ex.getErrorCode(),
            ex.getMessage(),
            LocalDateTime.now()
        );

        HttpStatus status = mapToHttpStatus(ex.getErrorCode());

        return ResponseEntity.status(status).body(error);
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ValidationErrorResponseDto> handleValidationException(
        MethodArgumentNotValidException ex
    ) {
        List<FieldErrorDto> errors = ex.getBindingResult()
            .getFieldErrors()
            .stream()
            .map(error -> new FieldErrorDto(
                error.getField(),
                error.getDefaultMessage(),
                error.getRejectedValue()
            ))
            .toList();

        ValidationErrorResponseDto response = new ValidationErrorResponseDto(
            "VALIDATION_FAILED",
            "ì…ë ¥ ê°’ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤",
            errors,
            LocalDateTime.now()
        );

        return ResponseEntity.badRequest().body(response);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponseDto> handleException(Exception ex) {
        ErrorResponseDto error = new ErrorResponseDto(
            "INTERNAL_SERVER_ERROR",
            "ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
            LocalDateTime.now()
        );

        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(error);
    }

    private HttpStatus mapToHttpStatus(String errorCode) {
        if (errorCode.endsWith("001")) { // NOT_FOUND
            return HttpStatus.NOT_FOUND;
        } else if (errorCode.endsWith("002")) { // ALREADY_EXISTS
            return HttpStatus.CONFLICT;
        } else if (errorCode.endsWith("005")) { // INVALID
            return HttpStatus.BAD_REQUEST;
        }
        return HttpStatus.INTERNAL_SERVER_ERROR;
    }
}

// dto/response/ErrorResponseDto.java
public record ErrorResponseDto(
    String errorCode,
    String message,
    LocalDateTime timestamp
) {}

// dto/response/ValidationErrorResponseDto.java
public record ValidationErrorResponseDto(
    String errorCode,
    String message,
    List<FieldErrorDto> errors,
    LocalDateTime timestamp
) {}

public record FieldErrorDto(
    String field,
    String message,
    Object rejectedValue
) {}
```

---

## âœ… Zero-Tolerance Rules Checklist

### REST API Layer í•„ìˆ˜ ê·œì¹™

- [ ] **RESTful ì„¤ê³„**: HTTP ë©”ì„œë“œ, ìƒíƒœ ì½”ë“œ ì ì ˆíˆ ì‚¬ìš©
- [ ] **Request/Response DTO**: Domain ê°ì²´ ì§ì ‘ ë…¸ì¶œ ê¸ˆì§€
- [ ] **@Valid ê²€ì¦**: ëª¨ë“  Request DTOëŠ” `@Valid` í•„ìˆ˜
- [ ] **MockMvc ê¸ˆì§€**: TestRestTemplate í•„ìˆ˜ ì‚¬ìš©
- [ ] **Spring REST Docs**: ëª¨ë“  API ë¬¸ì„œí™”
- [ ] **Global Exception Handler**: ëª¨ë“  ì˜ˆì™¸ë¥¼ ErrorResponseDtoë¡œ ë³€í™˜
- [ ] **HTTP ìƒíƒœ ì½”ë“œ**: ì ì ˆí•œ ìƒíƒœ ì½”ë“œ ë°˜í™˜

### ê¸ˆì§€ëœ íŒ¨í„´ ì˜ˆì‹œ

âŒ **ì˜ëª»ëœ ì˜ˆ (Domain ê°ì²´ ì§ì ‘ ë°˜í™˜)**:
```java
@GetMapping("/{userId}")
public ResponseEntity<User> get(@PathVariable UUID userId) {
    return ResponseEntity.ok(getUserUseCase.execute(userId)); // âŒ Domain ë…¸ì¶œ
}
```

âœ… **ì˜¬ë°”ë¥¸ ì˜ˆ (Response DTO ë°˜í™˜)**:
```java
@GetMapping("/{userId}")
public ResponseEntity<GetUserResponseDto> get(@PathVariable UUID userId) {
    GetUserResponse response = getUserUseCase.execute(new GetUserQuery(userId));
    return ResponseEntity.ok(GetUserResponseDto.from(response)); // âœ… DTO ë³€í™˜
}
```

âŒ **ì˜ëª»ëœ ì˜ˆ (@Valid ëˆ„ë½)**:
```java
@PostMapping
public ResponseEntity<CreateUserResponseDto> create(@RequestBody CreateUserRequestDto request) {
    // âŒ @Valid ëˆ„ë½ - ê²€ì¦ ì•ˆ ë¨
}
```

âœ… **ì˜¬ë°”ë¥¸ ì˜ˆ (@Valid ì ìš©)**:
```java
@PostMapping
public ResponseEntity<CreateUserResponseDto> create(@Valid @RequestBody CreateUserRequestDto request) {
    // âœ… @Validë¡œ ê²€ì¦
}
```

---

## ğŸ§ª Test Rules

### 1. Test íŒŒì¼ ìœ„ì¹˜
```
adapter-in/rest-api/src/test/java/
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ AuthControllerTest.java
â”‚   â”œâ”€â”€ UserControllerTest.java
â”‚   â”œâ”€â”€ OrganizationControllerTest.java
â”‚   â”œâ”€â”€ RoleControllerTest.java
â”‚   â””â”€â”€ TenantControllerTest.java
â””â”€â”€ error/
    â””â”€â”€ GlobalExceptionHandlerTest.java
```

### 2. Test ì‘ì„± ê·œì¹™ (TestRestTemplate ì‚¬ìš©)

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles("test")
@AutoConfigureRestDocs
@DisplayName("AuthController í…ŒìŠ¤íŠ¸")
class AuthControllerTest {

    @Autowired
    private TestRestTemplate restTemplate;

    @MockBean
    private LoginUseCase loginUseCase;

    @Test
    @DisplayName("ë¡œê·¸ì¸ ì„±ê³µ")
    void login_Success() {
        // Given
        LoginRequestDto request = new LoginRequestDto("testuser", "Password123");
        LoginResponse mockResponse = new LoginResponse(
            "accessToken",
            "refreshToken",
            900L
        );

        when(loginUseCase.execute(any(LoginCommand.class))).thenReturn(mockResponse);

        // When
        ResponseEntity<LoginResponseDto> response = restTemplate.postForEntity(
            "/api/v1/auth/login",
            request,
            LoginResponseDto.class
        );

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().accessToken()).isEqualTo("accessToken");

        verify(loginUseCase, times(1)).execute(any(LoginCommand.class));
    }

    @Test
    @DisplayName("ë¡œê·¸ì¸ ì‹¤íŒ¨ - ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸")
    void login_InvalidPassword_ThrowsException() {
        // Given
        LoginRequestDto request = new LoginRequestDto("testuser", "WrongPassword");

        when(loginUseCase.execute(any(LoginCommand.class)))
            .thenThrow(new InvalidPasswordException());

        // When
        ResponseEntity<ErrorResponseDto> response = restTemplate.postForEntity(
            "/api/v1/auth/login",
            request,
            ErrorResponseDto.class
        );

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.BAD_REQUEST);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().errorCode()).isEqualTo("U005");
    }

    @Test
    @DisplayName("ë¡œê·¸ì¸ ì‹¤íŒ¨ - Validation ì—ëŸ¬")
    void login_ValidationError() {
        // Given
        LoginRequestDto request = new LoginRequestDto("", ""); // ë¹ˆ ê°’

        // When
        ResponseEntity<ValidationErrorResponseDto> response = restTemplate.postForEntity(
            "/api/v1/auth/login",
            request,
            ValidationErrorResponseDto.class
        );

        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.BAD_REQUEST);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().errorCode()).isEqualTo("VALIDATION_FAILED");
        assertThat(response.getBody().errors()).hasSize(2);
    }
}
```

### 3. Test Coverage ëª©í‘œ
- **Controller**: 90% ì´ìƒ (ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸)
- **GlobalExceptionHandler**: 100% (ëª¨ë“  ì˜ˆì™¸ ì¼€ì´ìŠ¤)

---

## ğŸ¯ Completion Criteria

### 1. êµ¬í˜„ ì™„ë£Œ ì¡°ê±´
- [ ] 27ê°œ API ì—”ë“œí¬ì¸íŠ¸ ëª¨ë‘ êµ¬í˜„ ì™„ë£Œ
- [ ] Request/Response DTO ëª¨ë‘ êµ¬í˜„ ì™„ë£Œ
- [ ] Global Exception Handler êµ¬í˜„ ì™„ë£Œ
- [ ] ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ (TestRestTemplate)
- [ ] Spring REST Docs ë¬¸ì„œ ìƒì„± ì™„ë£Œ
- [ ] ArchUnit ê²€ì¦ í†µê³¼

### 2. ArchUnit ê²€ì¦ í•­ëª©
```java
@ArchTest
static final ArchRule controllers_should_not_depend_on_domain =
    noClasses()
        .that().resideInAPackage("..adapter.in.rest.controller..")
        .should().dependOnClassesThat()
        .resideInAPackage("..domain.aggregate..");

@ArchTest
static final ArchRule request_dtos_should_have_valid_annotation =
    methods()
        .that().areDeclaredInClassesThat().resideInAPackage("..controller..")
        .and().areAnnotatedWith(PostMapping.class)
        .should().haveRawParameterTypes(containItemWithAnnotation(Valid.class));
```

### 3. Code Review Checklist
- [ ] RESTful API ì„¤ê³„ ì›ì¹™ ì¤€ìˆ˜ í™•ì¸
- [ ] Request/Response DTO íŒ¨í„´ ì ìš© í™•ì¸
- [ ] @Valid ê²€ì¦ ì ìš© í™•ì¸
- [ ] HTTP ìƒíƒœ ì½”ë“œ ì ì ˆì„± í™•ì¸
- [ ] Spring REST Docs ë¬¸ì„œí™” í™•ì¸

---

## ğŸ“š Related Documents

- [REST API Guide](../../docs/coding_convention/01-adapter-in-layer/rest-api/rest-api-guide.md)
- [Controller Guide](../../docs/coding_convention/01-adapter-in-layer/rest-api/controller/controller-guide.md)
- [Controller Test Guide](../../docs/coding_convention/01-adapter-in-layer/rest-api/controller/controller-test-guide.md)
- [DTO Guide (Command)](../../docs/coding_convention/01-adapter-in-layer/rest-api/dto/command/command-dto-guide.md)
- [Error Handling Strategy](../../docs/coding_convention/01-adapter-in-layer/rest-api/error/error-handling-strategy.md)
- [PRD: B2B AuthHub](../b2b-auth-hub.md)

---

## ğŸ”„ Kent Beck TDD Commands

```bash
# REST API Layer TDD ì‚¬ì´í´ ì‹¤í–‰
/kb/rest-api/go          # Plan íŒŒì¼ ê¸°ë°˜ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
/kb/rest-api/red         # Red: test: ì»¤ë°‹
/kb/rest-api/green       # Green: feat: ì»¤ë°‹
/kb/rest-api/refactor    # Refactor: struct: ì»¤ë°‹
```

# AUT-004: ë¡œê·¸ì•„ì›ƒ

**Epic**: IAM Platform (AuthHub)
**Feature**: ë¡œê·¸ì•„ì›ƒ
**Phase**: Phase 1 - Core Authentication
**ë¸Œëœì¹˜**: feature/AUT-004-logout
**ì˜ì¡´ì„±**: AUT-000, AUT-001, AUT-002 (ë¡œê·¸ì¸)

---

## ğŸ“ ëª©ì 

ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ êµ¬í˜„
- Refresh Token íê¸° (MySQL + Redis)
- Access Tokenì€ ë§Œë£Œ ì‹œê¹Œì§€ ìœ íš¨ (stateless)
- ë‹¤ì¤‘ ë””ë°”ì´ìŠ¤ ì§€ì› (íŠ¹ì • Refresh Tokenë§Œ ì‚­ì œ)

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 Domain Exception
- [ ] **RefreshTokenNotFoundException** (Refresh Token ì—†ìŒ)

#### 1.2 Domain Event
- [ ] **UserLoggedOut** Event
  - userId, refreshToken, logoutAt

### 2. Application Layer

#### 2.1 LogoutUseCase (Command)
- [ ] **Input**: LogoutCommand
  - refreshToken (String)

- [ ] **Output**: void (HTTP 204 No Content)

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. Refresh Token ê²€ì¦ (LoadRefreshTokenPort)
     - ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ RefreshTokenNotFoundException
  2. Refresh Token ì‚­ì œ (DeleteRefreshTokenPort)
     - MySQL: refresh_tokens í…Œì´ë¸”ì—ì„œ ì‚­ì œ
     - Redis: refresh_token:{token} ìºì‹œ ì‚­ì œ
  3. UserLoggedOut Event ë°œí–‰

#### 2.2 Port ì •ì˜
- **ê¸°ì¡´ Port ì¬ì‚¬ìš©**:
  - LoadRefreshTokenPort (AUT-003)
  - DeleteRefreshTokenPort (AUT-003)

### 3. Persistence Layer

**ê¸°ì¡´ Repository ë° Adapter ì¬ì‚¬ìš©**:
- RefreshTokenJpaRepository
- RedisRefreshTokenRepository
- RefreshTokenPersistenceAdapter

**ì¶”ê°€ êµ¬í˜„ ì—†ìŒ** (AUT-003ì—ì„œ ì´ë¯¸ êµ¬í˜„ë¨)

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/auth/logout**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 204 No Content

#### 4.2 Request DTO
- [ ] **LogoutRequest**:
  - refreshToken (String, @NotBlank)

#### 4.3 Controller
- [ ] **AuthController**:
  - logout(@Valid LogoutRequest) â†’ ResponseEntity<Void>

#### 4.4 Error Handling
- [ ] **RefreshTokenNotFoundException** â†’ HTTP 404, "Refresh Tokenì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
  - ì´ë¯¸ ë¡œê·¸ì•„ì›ƒí•œ ê²½ìš° ë˜ëŠ” ë§Œë£Œëœ ê²½ìš°

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ ë¡œê·¸ì•„ì›ƒ**:
  - Given: ë¡œê·¸ì¸ ì™„ë£Œ (refreshToken ë³´ìœ )
  - When: POST /api/v1/auth/logout
  - Then: HTTP 204
  - DB í™•ì¸: refresh_tokens í…Œì´ë¸”ì—ì„œ ì‚­ì œ
  - Redis í™•ì¸: refresh_token ìºì‹œ ì‚­ì œ

- [ ] **ì´ë¯¸ ë¡œê·¸ì•„ì›ƒí•œ ê²½ìš°**:
  - Given: ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ (refreshToken ì‚­ì œë¨)
  - When: POST /api/v1/auth/logout (ê°™ì€ refreshToken)
  - Then: HTTP 404, "Refresh Tokenì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

- [ ] **ë‹¤ì¤‘ ë””ë°”ì´ìŠ¤ ë¡œê·¸ì•„ì›ƒ**:
  - Given: 2ê°œ ë””ë°”ì´ìŠ¤ ë¡œê·¸ì¸ (refreshToken1, refreshToken2)
  - When: POST /api/v1/auth/logout (refreshToken1)
  - Then: HTTP 204
  - DB í™•ì¸: refreshToken1ë§Œ ì‚­ì œ, refreshToken2ëŠ” ìœ ì§€

- [ ] **ë¡œê·¸ì•„ì›ƒ í›„ ì¬ë°œê¸‰ ì‹œë„**:
  - Given: ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ
  - When: POST /api/v1/auth/refresh (ì‚­ì œëœ refreshToken)
  - Then: HTTP 401, "ìœ íš¨í•˜ì§€ ì•Šì€ Refresh Tokenì…ë‹ˆë‹¤"

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **ë¡œê·¸ì¸**: AUT-002 API í˜¸ì¶œí•˜ì—¬ refreshToken íšë“
- [ ] **ë‹¤ì¤‘ ë””ë°”ì´ìŠ¤**: 2íšŒ ë¡œê·¸ì¸ (ì„œë¡œ ë‹¤ë¥¸ refreshToken)

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Transaction ê²½ê³„** - ì™¸ë¶€ API í˜¸ì¶œ ì—†ìŒ (DB ì‚­ì œë§Œ)

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000, AUT-001, AUT-002 (ë¡œê·¸ì¸)
  - AUT-003 (DeleteRefreshTokenPort ì¬ì‚¬ìš©)

### ì„¤ê³„ ê²°ì •
- [ ] **Access Tokenì€ ë§Œë£Œ ì‹œê¹Œì§€ ìœ íš¨**
  - Stateless JWTì´ë¯€ë¡œ ê°•ì œ ë¬´íš¨í™” ë¶ˆê°€
  - ê¸´ê¸‰ ê¶Œí•œ íšŒìˆ˜ ì‹œ Access Token Blacklist ì‚¬ìš© (ì„ íƒ, ì´ Task ë²”ìœ„ ë°–)
- [ ] **Refresh Tokenë§Œ ì‚­ì œ**
  - ë‹¤ì¤‘ ë””ë°”ì´ìŠ¤ ì§€ì› (íŠ¹ì • ë””ë°”ì´ìŠ¤ë§Œ ë¡œê·¸ì•„ì›ƒ)

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (Domain Event)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (LogoutUseCase)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (Controller)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 4ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **ë…ë¦½ ë°°í¬ ê°€ëŠ¥ í™•ì¸** (ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ë§Œ ë™ì‘)
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥)
- **Plan**: docs/prd/plans/AUT-004-logout-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-57

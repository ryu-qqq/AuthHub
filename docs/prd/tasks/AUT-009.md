# AUT-006: ê³„ì • ë³‘í•© (Account Merging)

**Epic**: IAM Platform (AuthHub)
**Feature**: ê³„ì • ë³‘í•©
**Phase**: Phase 2 - Social Login
**ë¸Œëœì¹˜**: feature/AUT-009-account-merging
**ì˜ì¡´ì„±**: AUT-000, AUT-001, AUT-002, AUT-005 (ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸)

---

## ğŸ“ ëª©ì 

ì „í™”ë²ˆí˜¸ ê³„ì •ê³¼ ì†Œì…œ ê³„ì • ë³‘í•© ê¸°ëŠ¥ êµ¬í˜„
- ì „í™”ë²ˆí˜¸ë¡œ ê°€ì… â†’ ë‚˜ì¤‘ì— ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ â†’ ë™ì¼ ì‚¬ìš©ì ë³‘í•©
- ì¹´ì¹´ì˜¤ë¡œ ê°€ì… â†’ ë‚˜ì¤‘ì— ì „í™”ë²ˆí˜¸ ì¶”ê°€ â†’ ê³„ì • ë³‘í•©
- ì¤‘ë³µ ê³„ì • ë°©ì§€ (Email ê¸°ë°˜ ìë™ ë³‘í•©)
- ì‚¬ìš©ì ëª…ì‹œì  ë³‘í•© (ì „í™”ë²ˆí˜¸ ì¸ì¦ í›„ ë³‘í•©)

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 User Aggregate í™•ì¥
- [ ] **User Aggregateì— ì¶”ê°€**:
  - `linkSocialAccount(SocialAccount)` â†’ void (ì†Œì…œ ê³„ì • ì—°ë™)
  - `mergeWith(User otherUser)` â†’ void (ê³„ì • ë³‘í•©, ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦)

#### 1.2 Domain Exception
- [ ] **AccountMergeNotAllowedException** (ë³‘í•© ë¶ˆê°€ ì¡°ê±´)
- [ ] **ConflictingAccountException** (ì¶©ëŒ ê³„ì • ì¡´ì¬)
- [ ] **PhoneVerificationRequiredException** (ì „í™”ë²ˆí˜¸ ì¸ì¦ í•„ìš”)

#### 1.3 Domain Event
- [ ] **AccountsMerged** Event
  - primaryUserId, mergedUserId, mergeTrigger (EMAIL_AUTO, PHONE_MANUAL), mergedAt

### 2. Application Layer

#### 2.1 LinkSocialAccountUseCase (Command)
- [ ] **Input**: LinkSocialAccountCommand
  - userId (Long, í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì)
  - provider (SocialProvider, KAKAO)
  - authorizationCode (String)

- [ ] **Output**: void

- [ ] **Transaction**: í•„ìˆ˜ (ë‹¨, Kakao API í˜¸ì¶œì€ íŠ¸ëœì­ì…˜ ë°–)

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. **Kakao API í˜¸ì¶œ (íŠ¸ëœì­ì…˜ ë°–)**:
     - Authorization Code â†’ Kakao Access Token êµí™˜
     - Kakao Access Token â†’ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (providerId, email)
  2. **Transaction ì‹œì‘**:
     - providerIdë¡œ SocialAccount ì¡°íšŒ
     - ì´ë¯¸ ë‹¤ë¥¸ ì‚¬ìš©ìì— ì—°ë™ë˜ì–´ ìˆìœ¼ë©´ ConflictingAccountException
     - í˜„ì¬ ì‚¬ìš©ìì— SocialAccount ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
  3. SocialAccountLinked Event ë°œí–‰

#### 2.2 MergeAccountsUseCase (Command)
- [ ] **Input**: MergeAccountsCommand
  - primaryUserId (Long, ìœ ì§€í•  ê³„ì •)
  - secondaryUserId (Long, ë³‘í•©ë  ê³„ì •)
  - phoneVerificationToken (String, ì „í™”ë²ˆí˜¸ ì¸ì¦ í† í°)

- [ ] **Output**: void

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. ì „í™”ë²ˆí˜¸ ì¸ì¦ í† í° ê²€ì¦ (LoadPhoneVerificationPort)
     - ë§Œë£Œ í™•ì¸, primaryUser ì „í™”ë²ˆí˜¸ì™€ ì¼ì¹˜ í™•ì¸
  2. Primary User, Secondary User ì¡°íšŒ
  3. Tenant ì¼ì¹˜ í™•ì¸ (ë‹¤ë¥¸ Tenant ë³‘í•© ë¶ˆê°€)
  4. Secondary Userì˜ SocialAccountë¥¼ Primary Userë¡œ ì´ë™
  5. Secondary Userì˜ Refresh Token ëª¨ë‘ ì‚­ì œ
  6. Secondary User ìƒíƒœ â†’ DELETED
  7. AccountsMerged Event ë°œí–‰

#### 2.3 DetectAndMergeByEmailUseCase (Internal, Event-Driven)
- [ ] **Trigger**: UserRegisteredViaSocial Event (AUT-005)

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. ì†Œì…œ ë¡œê·¸ì¸ ì‹œ Emailì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°
  2. ë™ì¼ Emailì„ ê°€ì§„ ì „í™”ë²ˆí˜¸ ê³„ì • ì¡°íšŒ (LoadUserByEmailPort)
  3. ì¡´ì¬ ì‹œ: ìë™ ë³‘í•© (ì „í™”ë²ˆí˜¸ ê³„ì •ì´ Primary)
     - SocialAccountë¥¼ ì „í™”ë²ˆí˜¸ ê³„ì •ìœ¼ë¡œ ì´ë™
     - ì†Œì…œ ë¡œê·¸ì¸ìœ¼ë¡œ ìƒì„±ëœ ì„ì‹œ User ì‚­ì œ
  4. AccountsMerged Event ë°œí–‰ (mergeTrigger: EMAIL_AUTO)

#### 2.4 Port ì •ì˜
- [ ] **LoadUserByEmailPort** (Out):
  - load(Long tenantId, String email) â†’ Optional<User>

- [ ] **LoadPhoneVerificationPort** (Out):
  - load(String token) â†’ Optional<PhoneVerification>

- [ ] **TransferSocialAccountsPort** (Out):
  - transfer(Long fromUserId, Long toUserId) â†’ void (SocialAccount ì†Œìœ ì ë³€ê²½)

### 3. Persistence Layer

#### 3.1 Flyway ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] **V6__add_user_email_index.sql**:
  - users í…Œì´ë¸”ì— email ì»¬ëŸ¼ Index ì¶”ê°€ (ê²€ìƒ‰ ìµœì í™”)

#### 3.2 Repository í™•ì¥
- [ ] **UserJpaRepository**:
  - findByTenantIdAndEmail(Long, String) â†’ Optional<UserEntity>

- [ ] **SocialAccountJpaRepository**:
  - updateUserId(Long oldUserId, Long newUserId) â†’ void (Native Query)

#### 3.3 Adapter í™•ì¥
- [ ] **UserQueryAdapter** (LoadUserByEmailPort êµ¬í˜„)

- [ ] **SocialAccountPersistenceAdapter** (TransferSocialAccountsPort êµ¬í˜„)

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/users/me/social-accounts/link**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 204 No Content
  - ì¸ì¦ í•„ìˆ˜ (Access Token)

- [ ] **POST /api/v1/users/me/merge**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 204 No Content
  - ì¸ì¦ í•„ìˆ˜ (Access Token)

#### 4.2 Request DTO
- [ ] **LinkSocialAccountRequest**:
  - provider (String, KAKAO)
  - authorizationCode (String, @NotBlank)

- [ ] **MergeAccountsRequest**:
  - secondaryUserId (Long, @NotNull)
  - phoneVerificationToken (String, @NotBlank)

#### 4.3 Controller
- [ ] **UserController**:
  - linkSocialAccount(@Valid LinkSocialAccountRequest, @AuthenticationPrincipal userId) â†’ ResponseEntity<Void>
  - mergeAccounts(@Valid MergeAccountsRequest, @AuthenticationPrincipal userId) â†’ ResponseEntity<Void>

#### 4.4 Error Handling
- [ ] **ConflictingAccountException** â†’ HTTP 409, "ì´ë¯¸ ë‹¤ë¥¸ ê³„ì •ì— ì—°ë™ëœ ì†Œì…œ ê³„ì •ì…ë‹ˆë‹¤"
- [ ] **AccountMergeNotAllowedException** â†’ HTTP 400, "ê³„ì • ë³‘í•©ì´ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
- [ ] **PhoneVerificationRequiredException** â†’ HTTP 400, "ì „í™”ë²ˆí˜¸ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤"

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ ì†Œì…œ ê³„ì • ì—°ë™**:
  - Given: ì „í™”ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì
  - When: POST /api/v1/users/me/social-accounts/link (ì¹´ì¹´ì˜¤ ì¸ì¦ ì½”ë“œ)
  - Then: HTTP 204
  - DB í™•ì¸: social_accounts í…Œì´ë¸”ì— user_id ì—°ë™

- [ ] **ì´ë¯¸ ì—°ë™ëœ ì†Œì…œ ê³„ì • ì‹œë„**:
  - Given: ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œ ì´ë¯¸ ì—°ë™ëœ ì¹´ì¹´ì˜¤ ê³„ì •
  - When: POST /api/v1/users/me/social-accounts/link
  - Then: HTTP 409, "ì´ë¯¸ ë‹¤ë¥¸ ê³„ì •ì— ì—°ë™ëœ ì†Œì…œ ê³„ì •ì…ë‹ˆë‹¤"

- [ ] **ì •ìƒ ê³„ì • ë³‘í•© (ì „í™”ë²ˆí˜¸ ì¸ì¦)**:
  - Given: 2ê°œ ê³„ì • (ì „í™”ë²ˆí˜¸ ê³„ì •, ì¹´ì¹´ì˜¤ ê³„ì •), ì „í™”ë²ˆí˜¸ ì¸ì¦ ì™„ë£Œ
  - When: POST /api/v1/users/me/merge
  - Then: HTTP 204
  - DB í™•ì¸:
    - SocialAccountê°€ Primary Userë¡œ ì´ë™
    - Secondary User ìƒíƒœ â†’ DELETED
  - Event í™•ì¸: AccountsMerged ë°œí–‰

- [ ] **Email ê¸°ë°˜ ìë™ ë³‘í•©**:
  - Given: Emailë¡œ ì „í™”ë²ˆí˜¸ ê°€ì… (test@example.com)
  - When: ë™ì¼ Emailë¡œ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ (ì‹ ê·œ ê°€ì…)
  - Then: ìë™ ë³‘í•© ë°œìƒ
  - DB í™•ì¸: SocialAccountê°€ ì „í™”ë²ˆí˜¸ ê³„ì •ìœ¼ë¡œ ì—°ë™, ì†Œì…œ ì„ì‹œ User ì‚­ì œ
  - Event í™•ì¸: AccountsMerged (mergeTrigger: EMAIL_AUTO)

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V6 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **WireMock**: Kakao API Mock

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Transaction ê²½ê³„** - Kakao API í˜¸ì¶œì€ íŠ¸ëœì­ì…˜ ë°–
- [ ] **Tell Don't Ask** - User.mergeWith(User) ë©”ì„œë“œë¡œ ë³‘í•© ë¡œì§ ìº¡ìŠí™”

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000, AUT-001, AUT-002 (ê¸°ë³¸ êµ¬ì¡°)
  - AUT-005 (SocialAccount, Kakao ë¡œê·¸ì¸)

### ë³´ì•ˆ ê·œì¹™
- [ ] **ì „í™”ë²ˆí˜¸ ì¸ì¦ í•„ìˆ˜** - ìˆ˜ë™ ë³‘í•© ì‹œ ì „í™”ë²ˆí˜¸ ì¸ì¦ í† í° ê²€ì¦
- [ ] **Tenant ê²©ë¦¬** - ë‹¤ë¥¸ Tenant ê³„ì • ë³‘í•© ë¶ˆê°€

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: User.mergeWith, linkSocialAccount
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate + WireMock
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (User.mergeWith, linkSocialAccount)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (LinkSocialAccountUseCase, MergeAccountsUseCase, DetectAndMergeByEmailUseCase)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (Email Index, Repository í™•ì¥)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (UserController)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 4ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **Email ê¸°ë°˜ ìë™ ë³‘í•© ê²€ì¦** (Event-Driven)
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (2.2 Account Merging)
- **Plan**: docs/prd/plans/AUT-006-account-merging-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-62

# AUT-009: Role ì‹œìŠ¤í…œ (SUPER_ADMIN, ORG_ADMIN, MEMBER)

**Epic**: IAM Platform (AuthHub)
**Feature**: Role ì‹œìŠ¤í…œ
**Phase**: Phase 2 - Organization & Authorization
**ë¸Œëœì¹˜**: feature/AUT-011-role-system
**ì˜ì¡´ì„±**: AUT-000, AUT-007, AUT-008 (Organization & Member)

---

## ğŸ“ ëª©ì 

Role ê¸°ë°˜ ê¶Œí•œ ì‹œìŠ¤í…œ êµ¬í˜„
- Role ì •ì˜ (SUPER_ADMIN, ORG_ADMIN, MEMBER)
- Role ìƒì„± ë° ê´€ë¦¬ (SUPER_ADMIN ì „ìš©)
- Role ì¡°íšŒ (ëª©ë¡, ìƒì„¸)
- Role ì‚­ì œ (Soft Delete)

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 Role Aggregate
- [ ] **Role Aggregate Root** ìƒì„±
  - roleId (RoleId VO, Long)
  - tenantId (Long FK)
  - organizationId (Long FK, Nullable)
  - name (RoleName VO)
  - roleScope (RoleScope Enum) â† **NEW**
  - roleType (RoleType Enum) â† **ë³€ê²½ë¨**
  - description (String)
  - status (RoleStatus Enum: ACTIVE, INACTIVE, DELETED)
  - createdAt, updatedAt (LocalDateTime)

#### 1.2 RoleScope Enum (NEW)
- [ ] **RoleScope Enum** (ì—­í• ì˜ ë²”ìœ„):
  - `TENANT_GLOBAL`: Tenant ì „ì²´ ë²”ìœ„ (organizationId = null)
    - ì˜ˆ: SUPER_ADMIN (ëª¨ë“  Organization ê´€ë¦¬)
  - `ORGANIZATION`: Organization ë²”ìœ„ (organizationId != null)
    - ì˜ˆ: ORG_ADMIN (íŠ¹ì • Organizationë§Œ ê´€ë¦¬)

**Invariant (ë¶ˆë³€ì‹)**:
```java
if (roleScope == TENANT_GLOBAL) {
    assert organizationId == null;
}
if (roleScope == ORGANIZATION) {
    assert organizationId != null;
}
```

#### 1.3 RoleType Enum (ë³€ê²½)
- [ ] **RoleType Enum** (ì—­í• ì˜ ì¢…ë¥˜):
  - `SYSTEM`: ì‹œìŠ¤í…œ ì •ì˜ Role (ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€)
    - ì˜ˆ: SUPER_ADMIN, ORG_ADMIN, MEMBER
  - `CUSTOM`: ì‚¬ìš©ì ì •ì˜ Role (ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥)
    - ì˜ˆ: DEVELOPER, VIEWER, EDITOR

**ì¡°í•© ì˜ˆì‹œ**:
```
SUPER_ADMIN:
  - roleScope: TENANT_GLOBAL
  - roleType: SYSTEM
  - organizationId: null

ORG_ADMIN:
  - roleScope: ORGANIZATION
  - roleType: SYSTEM
  - organizationId: 123

Custom Developer Role:
  - roleScope: ORGANIZATION
  - roleType: CUSTOM
  - organizationId: 123
```

#### 1.4 RoleName VO
- [ ] **RoleName VO**:
  - ê²€ì¦ ê·œì¹™: 2-50ì
  - ì˜ˆì•½ì–´ ê²€ì¦ (SUPER_ADMIN, ORG_ADMIN, MEMBERëŠ” ì‹œìŠ¤í…œ ì˜ˆì•½)

#### 1.5 RoleId VO
- [ ] **RoleId VO** (Long ê¸°ë°˜)

#### 1.6 Domain Exception
- [ ] **DuplicateRoleNameException** (Role ì´ë¦„ ì¤‘ë³µ)
- [ ] **RoleNotFoundException** (Role ì—†ìŒ)
- [ ] **ReservedRoleNameException** (ì˜ˆì•½ì–´ ì‚¬ìš© ì‹œë„)
- [ ] **RoleInUseException** (ì‚¬ìš© ì¤‘ì¸ Role ì‚­ì œ ì‹œë„)
- [ ] **InvalidRoleScopeException** (RoleScopeì™€ organizationId ë¶ˆì¼ì¹˜) â† **NEW**

#### 1.7 Domain Event
- [ ] **RoleCreated** Event
  - roleId, tenantId, name, roleType, createdBy, createdAt

- [ ] **RoleDeleted** Event
  - roleId, deletedBy, deletedAt

### 2. Application Layer

#### 2.1 CreateRoleUseCase (Command)
- [ ] **Input**: CreateRoleCommand
  - tenantId (Long)
  - organizationId (Long, optional)
  - name (String)
  - roleType (RoleType)
  - description (String)
  - requestedBy (Long, SUPER_ADMIN userId)

- [ ] **Output**: RoleResponse
  - roleId, tenantId, organizationId, name, roleType, description, status, createdAt

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. SUPER_ADMIN ê¶Œí•œ ê²€ì¦ (LoadUserPort)
  2. Role ì´ë¦„ ì¤‘ë³µ í™•ì¸ (CheckDuplicateRoleNamePort)
  3. ì˜ˆì•½ì–´ ê²€ì¦ (RoleName VO)
  4. Role Aggregate ìƒì„±
  5. Role ì €ì¥ (SaveRolePort)
  6. RoleCreated Event ë°œí–‰

#### 2.2 DeleteRoleUseCase (Command)
- [ ] **Input**: DeleteRoleCommand
  - roleId (Long)
  - requestedBy (Long, SUPER_ADMIN userId)

- [ ] **Output**: void

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. SUPER_ADMIN ê¶Œí•œ ê²€ì¦
  2. Role ì¡°íšŒ (LoadRolePort)
  3. ì‹œìŠ¤í…œ ì˜ˆì•½ Role (SUPER_ADMIN, ORG_ADMIN, MEMBER) ì‚­ì œ ì°¨ë‹¨
  4. Roleì´ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸ (CheckRoleInUsePort)
  5. Role ìƒíƒœ â†’ DELETED (Soft Delete)
  6. Role ì €ì¥ (SaveRolePort)
  7. RoleDeleted Event ë°œí–‰

#### 2.3 GetRoleQuery (Query)
- [ ] **Input**: GetRoleQueryRequest
  - roleId (Long)

- [ ] **Output**: RoleResponse

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. Role ì¡°íšŒ (LoadRolePort)

#### 2.4 ListRolesQuery (Query)
- [ ] **Input**: ListRolesQueryRequest
  - tenantId (Long, optional filter)
  - organizationId (Long, optional filter)
  - roleType (RoleType, optional filter)
  - status (RoleStatus, optional filter)

- [ ] **Output**: List<RoleResponse>

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. Role ëª©ë¡ ì¡°íšŒ (LoadRolesPort)

#### 2.5 Port ì •ì˜
- [ ] **SaveRolePort** (Out):
  - save(Role) â†’ Role

- [ ] **LoadRolePort** (Out):
  - load(Long roleId) â†’ Optional<Role>

- [ ] **LoadRolesPort** (Out):
  - loadAll(Long tenantId, Long organizationId, RoleType, RoleStatus) â†’ List<Role>

- [ ] **CheckDuplicateRoleNamePort** (Out):
  - exists(Long tenantId, Long organizationId, String name) â†’ boolean

- [ ] **CheckRoleInUsePort** (Out):
  - isInUse(Long roleId) â†’ boolean (ì‚¬ìš©ìê°€ í•´ë‹¹ Roleì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸)

### 3. Persistence Layer

#### 3.1 RoleEntity
- [ ] **RoleEntity** ìƒì„±
  - id (Long, PK)
  - tenant_id (Long, FK)
  - organization_id (Long, FK, Nullable)
  - name (String)
  - role_scope (String, TENANT_GLOBAL/ORGANIZATION) â† **NEW**
  - role_type (String, SYSTEM/CUSTOM) â† **ë³€ê²½ë¨**
  - description (String)
  - status (String, ACTIVE/INACTIVE/DELETED)
  - created_at, updated_at (LocalDateTime)

**Constraint**:
```sql
CHECK (
  (role_scope = 'TENANT_GLOBAL' AND organization_id IS NULL) OR
  (role_scope = 'ORGANIZATION' AND organization_id IS NOT NULL)
)
```

#### 3.2 Flyway ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] **V9__create_roles.sql**:
  - roles í…Œì´ë¸” ìƒì„±
  - `role_scope` ì»¬ëŸ¼ ì¶”ê°€ (VARCHAR(20), NOT NULL)
  - `role_type` ì»¬ëŸ¼ ë³€ê²½ (SYSTEM/CUSTOM)
  - Unique Constraint: (tenant_id, organization_id, name)
  - Index: (tenant_id, role_scope, status)
  - CHECK Constraint: roleScopeì™€ organizationId ì¼ì¹˜ ê²€ì¦

- [ ] **V10__insert_default_roles.sql**:
  - ì‹œìŠ¤í…œ ê¸°ë³¸ Role ì‚½ì…:
    ```sql
    -- SUPER_ADMIN (Tenant ì „ì²´ ë²”ìœ„)
    INSERT INTO roles (tenant_id, organization_id, name, role_scope, role_type, description, status)
    VALUES (1, NULL, 'SUPER_ADMIN', 'TENANT_GLOBAL', 'SYSTEM', 'System Administrator', 'ACTIVE');

    -- ORG_ADMIN Template (Organization ë²”ìœ„, ê° Organization ìƒì„± ì‹œ ìë™ ìƒì„±)
    -- ì´ˆê¸°ì—ëŠ” ìƒì„±í•˜ì§€ ì•ŠìŒ, Organization ìƒì„± ì‹œ ìë™ ìƒì„±

    -- MEMBER Template (Organization ë²”ìœ„)
    -- ì´ˆê¸°ì—ëŠ” ìƒì„±í•˜ì§€ ì•ŠìŒ, Organization ìƒì„± ì‹œ ìë™ ìƒì„±
    ```

#### 3.3 Repository
- [ ] **RoleJpaRepository**:
  - save(RoleEntity) â†’ RoleEntity
  - findById(Long) â†’ Optional<RoleEntity>
  - findByTenantIdAndOrganizationIdAndName(Long, Long, String) â†’ Optional<RoleEntity>
  - findAllByTenantIdAndOrganizationIdAndRoleTypeAndStatus(Long, Long, String, String) â†’ List<RoleEntity>
  - existsByTenantIdAndOrganizationIdAndName(Long, Long, String) â†’ boolean

#### 3.4 Adapter
- [ ] **RoleCommandAdapter** (SaveRolePort êµ¬í˜„)

- [ ] **RoleQueryAdapter** (LoadRolePort, LoadRolesPort, CheckDuplicateRoleNamePort, CheckRoleInUsePort êµ¬í˜„)

#### 3.5 Mapper
- [ ] **RoleMapper**:
  - toEntity(Role) â†’ RoleEntity
  - toDomain(RoleEntity) â†’ Role

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/roles**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 201 Created
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN)

- [ ] **GET /api/v1/roles/{roleId}**
  - HTTP Method: GET
  - Response: HTTP 200 OK

- [ ] **GET /api/v1/roles**
  - HTTP Method: GET
  - Query Params: tenantId, organizationId, roleType, status
  - Response: HTTP 200 OK

- [ ] **DELETE /api/v1/roles/{roleId}**
  - HTTP Method: DELETE
  - Response: HTTP 204 No Content
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN)

#### 4.2 Request DTO
- [ ] **CreateRoleRequest**:
  - name (String, @NotBlank, @Size(min=2, max=50))
  - roleType (String, @NotBlank, SUPER_ADMIN/ORG_ADMIN/MEMBER)
  - organizationId (Long, optional)
  - description (String)

#### 4.3 Response DTO
- [ ] **RoleResponse**:
  - roleId (Long)
  - tenantId (Long)
  - organizationId (Long, nullable)
  - name (String)
  - roleType (String)
  - description (String)
  - status (String)
  - createdAt (LocalDateTime)

#### 4.4 Controller
- [ ] **RoleController**:
  - createRole(@Valid CreateRoleRequest, @AuthenticationPrincipal userId) â†’ ResponseEntity<RoleResponse>
  - getRole(@PathVariable Long roleId) â†’ ResponseEntity<RoleResponse>
  - listRoles(@RequestParam tenantId, organizationId, roleType, status) â†’ ResponseEntity<List<RoleResponse>>
  - deleteRole(@PathVariable Long roleId, @AuthenticationPrincipal userId) â†’ ResponseEntity<Void>

#### 4.5 Error Handling
- [ ] **DuplicateRoleNameException** â†’ HTTP 409, "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” Role ì´ë¦„ì…ë‹ˆë‹¤"
- [ ] **RoleNotFoundException** â†’ HTTP 404, "Roleì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
- [ ] **ReservedRoleNameException** â†’ HTTP 400, "ì˜ˆì•½ëœ Role ì´ë¦„ì…ë‹ˆë‹¤"
- [ ] **RoleInUseException** â†’ HTTP 400, "ì‚¬ìš© ì¤‘ì¸ Roleì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
- [ ] **UnauthorizedException** (SUPER_ADMIN ì•„ë‹˜) â†’ HTTP 403, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ Role ìƒì„±**:
  - Given: SUPER_ADMIN ë¡œê·¸ì¸
  - When: POST /api/v1/roles (name: "Developer", roleType: MEMBER)
  - Then: HTTP 201, RoleResponse ë°˜í™˜
  - DB í™•ì¸: roles í…Œì´ë¸”ì— ë°ì´í„° ì‚½ì…
  - Event í™•ì¸: RoleCreated ë°œí–‰

- [ ] **ì˜ˆì•½ì–´ Role ìƒì„± ì‹œë„**:
  - Given: SUPER_ADMIN ë¡œê·¸ì¸
  - When: POST /api/v1/roles (name: "SUPER_ADMIN")
  - Then: HTTP 400, "ì˜ˆì•½ëœ Role ì´ë¦„ì…ë‹ˆë‹¤"

- [ ] **ì •ìƒ Role ì‚­ì œ (Soft Delete)**:
  - Given: ì‚¬ìš© ì¤‘ì´ì§€ ì•Šì€ Role
  - When: DELETE /api/v1/roles/{roleId}
  - Then: HTTP 204
  - DB í™•ì¸: status = DELETED
  - Event í™•ì¸: RoleDeleted ë°œí–‰

- [ ] **ì‚¬ìš© ì¤‘ì¸ Role ì‚­ì œ ì‹œë„**:
  - Given: ì‚¬ìš©ìê°€ í• ë‹¹ëœ Role
  - When: DELETE /api/v1/roles/{roleId}
  - Then: HTTP 400, "ì‚¬ìš© ì¤‘ì¸ Roleì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

- [ ] **Role ëª©ë¡ ì¡°íšŒ (í•„í„°ë§)**:
  - Given: 3ê°œ Role (SUPER_ADMIN, ORG_ADMIN, MEMBER)
  - When: GET /api/v1/roles?roleType=ORG_ADMIN
  - Then: HTTP 200, 1ê°œ Role ë°˜í™˜

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V10 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **SUPER_ADMIN ì‚¬ìš©ì**: INTERNAL ì‚¬ìš©ì + SUPER_ADMIN ê¶Œí•œ

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Long FK ì „ëµ** - RoleEntityì— `private Long tenantId`, `private Long organizationId`

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (User Aggregate)
  - AUT-007 (Tenant ê´€ë¦¬)
  - AUT-008 (Organization ê´€ë¦¬)

### ë³´ì•ˆ ê·œì¹™
- [ ] **SUPER_ADMIN ì „ìš©** - Role ìƒì„±/ì‚­ì œëŠ” SUPER_ADMINë§Œ ê°€ëŠ¥
- [ ] **ì˜ˆì•½ì–´ ë³´í˜¸** - SUPER_ADMIN, ORG_ADMIN, MEMBER ì´ë¦„ ì‚¬ìš© ê¸ˆì§€

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: Role VO, RoleName ê²€ì¦
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (Role Aggregate, RoleType Enum)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (CreateRoleUseCase, DeleteRoleUseCase, Query)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (RoleEntity, Repository, ê¸°ë³¸ ë°ì´í„° ì‚½ì…)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (RoleController)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 5ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **ì˜ˆì•½ì–´ ë³´í˜¸ ê²€ì¦ ì™„ë£Œ**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (3.3 Role System)
- **Plan**: docs/prd/plans/AUT-009-role-system-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-64

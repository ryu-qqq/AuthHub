# AUT-017: User ì¡°íšŒ ë° ìˆ˜ì •

**Epic**: IAM Platform (AuthHub)
**Feature**: User ì¡°íšŒ ë° ìˆ˜ì •
**Phase**: Phase 4 - User Management
**ë¸Œëœì¹˜**: feature/AUT-017-user-query-update
**ì˜ì¡´ì„±**: AUT-000, AUT-001 (User Aggregate)

---

## ğŸ“ ëª©ì 

ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ë° ìˆ˜ì • ê¸°ëŠ¥ êµ¬í˜„
- User ìƒì„¸ ì¡°íšŒ (ë³¸ì¸, SUPER_ADMIN, ORG_ADMIN)
- User ëª©ë¡ ì¡°íšŒ (Tenant, Organization í•„í„°ë§)
- User Profile ìˆ˜ì • (ì´ë¦„, í”„ë¡œí•„ ì´ë¯¸ì§€)
- ì „í™”ë²ˆí˜¸ ë³€ê²½ (ì¸ì¦ í•„ìš”)

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 User Aggregate í™•ì¥
- [ ] **User Aggregateì— ì¶”ê°€**:
  - `updateProfile(UserProfile)` â†’ void
  - `changePhoneNumber(PhoneNumber, PhoneVerificationToken)` â†’ void
  - `canBeViewedBy(User viewer)` â†’ boolean (ê¶Œí•œ ê²€ì¦)
  - `canBeEditedBy(User editor)` â†’ boolean (ê¶Œí•œ ê²€ì¦)

#### 1.2 Domain Exception
- [ ] **PhoneNumberAlreadyInUseException** (ì „í™”ë²ˆí˜¸ ì¤‘ë³µ)

### 2. Application Layer

#### 2.1 GetUserQuery (Query)
- [ ] **Input**: GetUserQueryRequest
  - userId (Long)
  - requestedBy (Long, í˜„ì¬ ì‚¬ìš©ì)

- [ ] **Output**: UserResponse
  - userId, userType, phoneNumber, email, name, profileImageUrl, status, createdAt

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. User ì¡°íšŒ (LoadUserPort)
  2. requestedBy ì¡°íšŒ
  3. User.canBeViewedBy(requestedBy) â†’ ë³¸ì¸ ë˜ëŠ” SUPER_ADMIN ë˜ëŠ” ê°™ì€ Organizationì˜ ORG_ADMIN

#### 2.2 ListUsersQuery (Query)
- [ ] **Input**: ListUsersQueryRequest
  - tenantId (Long, optional filter)
  - organizationId (Long, optional filter)
  - userType (UserType, optional filter)
  - status (UserStatus, optional filter)
  - searchKeyword (String, optional, name or phoneNumber)
  - page, size (Pagination)

- [ ] **Output**: PageResponse<UserResponse>

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. User ëª©ë¡ ì¡°íšŒ (LoadUsersPort)

#### 2.3 UpdateUserProfileUseCase (Command)
- [ ] **Input**: UpdateUserProfileCommand
  - userId (Long)
  - name (String, optional)
  - profileImageUrl (String, optional)
  - requestedBy (Long, í˜„ì¬ ì‚¬ìš©ì)

- [ ] **Output**: UserResponse

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. User ì¡°íšŒ (LoadUserPort)
  2. requestedBy ì¡°íšŒ
  3. User.canBeEditedBy(requestedBy) â†’ ë³¸ì¸ë§Œ ê°€ëŠ¥
  4. User.updateProfile(new UserProfile(name, profileImageUrl))
  5. User ì €ì¥ (SaveUserPort)

#### 2.4 ChangePhoneNumberUseCase (Command)
- [ ] **Input**: ChangePhoneNumberCommand
  - userId (Long)
  - newPhoneNumber (String)
  - phoneVerificationToken (String)
  - requestedBy (Long, í˜„ì¬ ì‚¬ìš©ì)

- [ ] **Output**: UserResponse

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. User ì¡°íšŒ (LoadUserPort)
  2. requestedBy ì¡°íšŒ
  3. User.canBeEditedBy(requestedBy) â†’ ë³¸ì¸ë§Œ ê°€ëŠ¥
  4. ì „í™”ë²ˆí˜¸ ì¸ì¦ í† í° ê²€ì¦ (LoadPhoneVerificationPort)
  5. ìƒˆ ì „í™”ë²ˆí˜¸ ì¤‘ë³µ í™•ì¸ (CheckDuplicatePhoneNumberPort)
  6. User.changePhoneNumber(newPhoneNumber, verificationToken)
  7. User ì €ì¥ (SaveUserPort)

#### 2.5 Port ì •ì˜
- [ ] **LoadUsersPort** (Out):
  - loadAll(tenantId, organizationId, userType, status, searchKeyword, Pageable) â†’ Page<User>

### 3. Persistence Layer

**ê¸°ì¡´ Repository ë° Adapter ì¬ì‚¬ìš©** (AUT-001ì—ì„œ êµ¬í˜„ë¨)

- [ ] **UserJpaRepository í™•ì¥**:
  - findAllByTenantIdAndOrganizationIdAndUserTypeAndStatusAndNameContainingOrPhoneNumberContaining(Long, Long, String, String, String, String, Pageable) â†’ Page<UserEntity>

#### 3.1 Adapter í™•ì¥
- [ ] **UserQueryAdapter** (LoadUsersPort êµ¬í˜„)

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **GET /api/v1/users/{userId}**
  - HTTP Method: GET
  - Response: HTTP 200 OK
  - ì¸ì¦ í•„ìˆ˜ (ë³¸ì¸, SUPER_ADMIN, ORG_ADMIN)

- [ ] **GET /api/v1/users**
  - HTTP Method: GET
  - Query Params: tenantId, organizationId, userType, status, searchKeyword, page, size
  - Response: HTTP 200 OK
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN, ORG_ADMIN)

- [ ] **PUT /api/v1/users/{userId}/profile**
  - HTTP Method: PUT
  - Content-Type: application/json
  - Response: HTTP 200 OK
  - ì¸ì¦ í•„ìˆ˜ (ë³¸ì¸ë§Œ)

- [ ] **PUT /api/v1/users/{userId}/phone-number**
  - HTTP Method: PUT
  - Content-Type: application/json
  - Response: HTTP 200 OK
  - ì¸ì¦ í•„ìˆ˜ (ë³¸ì¸ë§Œ)

#### 4.2 Request DTO
- [ ] **UpdateUserProfileRequest**:
  - name (String, @Size(min=1, max=50))
  - profileImageUrl (String)

- [ ] **ChangePhoneNumberRequest**:
  - newPhoneNumber (String, @NotBlank, @Pattern)
  - phoneVerificationToken (String, @NotBlank)

#### 4.3 Response DTO
- [ ] **UserResponse** (ì¬ì‚¬ìš©, AUT-001)

#### 4.4 Controller
- [ ] **UserController**:
  - getUser(@PathVariable Long userId, @AuthenticationPrincipal requestedBy) â†’ ResponseEntity<UserResponse>
  - listUsers(@RequestParam tenantId, organizationId, userType, status, searchKeyword, Pageable) â†’ ResponseEntity<PageApiResponse<UserResponse>>
  - updateUserProfile(@PathVariable Long userId, @Valid UpdateUserProfileRequest, @AuthenticationPrincipal requestedBy) â†’ ResponseEntity<UserResponse>
  - changePhoneNumber(@PathVariable Long userId, @Valid ChangePhoneNumberRequest, @AuthenticationPrincipal requestedBy) â†’ ResponseEntity<UserResponse>

#### 4.5 Error Handling
- [ ] **InsufficientPermissionException** â†’ HTTP 403, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"
- [ ] **PhoneNumberAlreadyInUseException** â†’ HTTP 409, "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤"

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ User ì¡°íšŒ (ë³¸ì¸)**:
  - Given: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (userId: 1)
  - When: GET /api/v1/users/1
  - Then: HTTP 200, UserResponse ë°˜í™˜

- [ ] **ì •ìƒ User ì¡°íšŒ (SUPER_ADMIN)**:
  - Given: SUPER_ADMIN ë¡œê·¸ì¸
  - When: GET /api/v1/users/{anyUserId}
  - Then: HTTP 200, UserResponse ë°˜í™˜

- [ ] **ê¶Œí•œ ì—†ëŠ” User ì¡°íšŒ ì‹œë„**:
  - Given: ì¼ë°˜ ì‚¬ìš©ì (userId: 1)
  - When: GET /api/v1/users/2 (ë‹¤ë¥¸ ì‚¬ìš©ì)
  - Then: HTTP 403, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

- [ ] **User ëª©ë¡ ì¡°íšŒ (Organization í•„í„°ë§)**:
  - Given: ORG_ADMIN ë¡œê·¸ì¸ (organizationId: 1)
  - When: GET /api/v1/users?organizationId=1
  - Then: HTTP 200, Organization 1ì˜ User ëª©ë¡ ë°˜í™˜

- [ ] **ì •ìƒ Profile ìˆ˜ì •**:
  - Given: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (userId: 1)
  - When: PUT /api/v1/users/1/profile (name: "New Name")
  - Then:
    - HTTP 200, ì—…ë°ì´íŠ¸ëœ UserResponse
    - DB í™•ì¸: users.name = "New Name"

- [ ] **ì •ìƒ ì „í™”ë²ˆí˜¸ ë³€ê²½**:
  - Given: ë¡œê·¸ì¸í•œ ì‚¬ìš©ì (userId: 1), ì „í™”ë²ˆí˜¸ ì¸ì¦ ì™„ë£Œ
  - When: PUT /api/v1/users/1/phone-number (newPhoneNumber: "010-9999-9999")
  - Then:
    - HTTP 200
    - DB í™•ì¸: users.phone_number = "010-9999-9999"

- [ ] **ì „í™”ë²ˆí˜¸ ì¤‘ë³µ ì‹œë„**:
  - Given: ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì „í™”ë²ˆí˜¸ (010-1234-5678)
  - When: PUT /api/v1/users/{userId}/phone-number (newPhoneNumber: "010-1234-5678")
  - Then: HTTP 409, "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤"

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V17 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **SUPER_ADMIN, ORG_ADMIN ì‚¬ìš©ì**: ê¶Œí•œ í…ŒìŠ¤íŠ¸ìš©

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Tell Don't Ask** - User.updateProfile, changePhoneNumber, canBeViewedBy, canBeEditedBy ë©”ì„œë“œ ì‚¬ìš©

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (User Aggregate)
  - AUT-001 (User ë“±ë¡)

### ë³´ì•ˆ ê·œì¹™
- [ ] **ë³¸ì¸ í™•ì¸** - Profile ìˆ˜ì •, ì „í™”ë²ˆí˜¸ ë³€ê²½ì€ ë³¸ì¸ë§Œ ê°€ëŠ¥
- [ ] **ì „í™”ë²ˆí˜¸ ì¸ì¦ í•„ìˆ˜** - ì „í™”ë²ˆí˜¸ ë³€ê²½ ì‹œ ì¸ì¦ í† í° ê²€ì¦

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: User.updateProfile, changePhoneNumber, canBeViewedBy, canBeEditedBy
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (User í™•ì¥)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (GetUserQuery, ListUsersQuery, UpdateUserProfileUseCase, ChangePhoneNumberUseCase)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (Repository í™•ì¥)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (UserController)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 7ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **ê¶Œí•œ ê²€ì¦ ë¡œì§ ì™„ë£Œ (canBeViewedBy, canBeEditedBy)**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (5.1 User Query/Update)
- **Plan**: docs/prd/plans/AUT-015-user-query-update-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-70

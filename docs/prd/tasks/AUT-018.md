# AUT-018: User ìƒíƒœ ê´€ë¦¬

**Epic**: IAM Platform (AuthHub)
**Feature**: User ìƒíƒœ ê´€ë¦¬
**Phase**: Phase 4 - User Management
**ë¸Œëœì¹˜**: feature/AUT-018-user-status-management
**ì˜ì¡´ì„±**: AUT-000, AUT-001 (User Aggregate)

---

## ğŸ“ ëª©ì 

ì‚¬ìš©ì ìƒíƒœ ê´€ë¦¬ ê¸°ëŠ¥ êµ¬í˜„
- User í™œì„±í™” (ACTIVE)
- User ë¹„í™œì„±í™” (INACTIVE, ì„ì‹œ ì •ì§€)
- User ì •ì§€ (SUSPENDED, ì˜êµ¬ ì •ì§€)
- ìƒíƒœ ì „í™˜ ê·œì¹™ ê²€ì¦

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 User Aggregate í™•ì¥
- [ ] **User Aggregateì— ì¶”ê°€**:
  - `activate()` â†’ void (status = ACTIVE)
  - `deactivate(String reason)` â†’ void (status = INACTIVE)
  - `suspend(String reason)` â†’ void (status = SUSPENDED)
  - `canTransitionTo(UserStatus)` â†’ boolean (ìƒíƒœ ì „í™˜ ê·œì¹™ ê²€ì¦)

#### 1.2 UserStatus Enum í™•ì¥ (AUT-000ì—ì„œ ì •ì˜ë¨)
- [ ] **ìƒíƒœ ì „í™˜ ê·œì¹™**:
  - ACTIVE â†’ INACTIVE (ë¹„í™œì„±í™”)
  - ACTIVE â†’ SUSPENDED (ì •ì§€)
  - INACTIVE â†’ ACTIVE (ì¬í™œì„±í™”)
  - SUSPENDED â†’ ACTIVE (ì •ì§€ í•´ì œ)
  - DELETEDëŠ” ë³µêµ¬ ë¶ˆê°€ (ìµœì¢… ìƒíƒœ)

#### 1.3 Domain Exception
- [ ] **InvalidUserStatusTransitionException** (ì˜ëª»ëœ ìƒíƒœ ì „í™˜)

#### 1.4 Domain Event
- [ ] **UserActivated** Event
  - userId, activatedBy, activatedAt

- [ ] **UserDeactivated** Event
  - userId, deactivatedBy, reason, deactivatedAt

- [ ] **UserSuspended** Event
  - userId, suspendedBy, reason, suspendedAt

### 2. Application Layer

#### 2.1 ActivateUserUseCase (Command)
- [ ] **Input**: ActivateUserCommand
  - userId (Long)
  - requestedBy (Long, SUPER_ADMIN ë˜ëŠ” ORG_ADMIN userId)

- [ ] **Output**: UserResponse

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. ê¶Œí•œ ê²€ì¦ (SUPER_ADMIN ë˜ëŠ” ORG_ADMIN)
  2. User ì¡°íšŒ (LoadUserPort)
  3. User.canTransitionTo(ACTIVE) ê²€ì¦
  4. User.activate()
  5. User ì €ì¥ (SaveUserPort)
  6. UserActivated Event ë°œí–‰

#### 2.2 DeactivateUserUseCase (Command)
- [ ] **Input**: DeactivateUserCommand
  - userId (Long)
  - reason (String)
  - requestedBy (Long, SUPER_ADMIN ë˜ëŠ” ORG_ADMIN userId)

- [ ] **Output**: UserResponse

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. ê¶Œí•œ ê²€ì¦ (SUPER_ADMIN ë˜ëŠ” ORG_ADMIN)
  2. User ì¡°íšŒ (LoadUserPort)
  3. User.canTransitionTo(INACTIVE) ê²€ì¦
  4. User.deactivate(reason)
  5. ëª¨ë“  Refresh Token íê¸° (DeleteAllRefreshTokensByUserIdPort)
  6. User ì €ì¥ (SaveUserPort)
  7. UserDeactivated Event ë°œí–‰

#### 2.3 SuspendUserUseCase (Command)
- [ ] **Input**: SuspendUserCommand
  - userId (Long)
  - reason (String)
  - requestedBy (Long, SUPER_ADMIN userId)

- [ ] **Output**: UserResponse

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. SUPER_ADMIN ê¶Œí•œ ê²€ì¦
  2. User ì¡°íšŒ (LoadUserPort)
  3. User.canTransitionTo(SUSPENDED) ê²€ì¦
  4. User.suspend(reason)
  5. ëª¨ë“  Refresh Token íê¸° (DeleteAllRefreshTokensByUserIdPort)
  6. User ì €ì¥ (SaveUserPort)
  7. UserSuspended Event ë°œí–‰

#### 2.4 Port ì •ì˜
- [ ] **DeleteAllRefreshTokensByUserIdPort** (Out, AUT-003ì—ì„œ ì •ì˜ë¨):
  - deleteAll(Long userId) â†’ void (MySQL + Redis ë™ì‹œ ì‚­ì œ)

### 3. Persistence Layer

**ê¸°ì¡´ Repository ë° Adapter ì¬ì‚¬ìš©** (AUT-001, AUT-003ì—ì„œ êµ¬í˜„ë¨)

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/users/{userId}/activate**
  - HTTP Method: POST
  - Response: HTTP 200 OK
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN, ORG_ADMIN)

- [ ] **POST /api/v1/users/{userId}/deactivate**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 200 OK
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN, ORG_ADMIN)

- [ ] **POST /api/v1/users/{userId}/suspend**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 200 OK
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN)

#### 4.2 Request DTO
- [ ] **DeactivateUserRequest**:
  - reason (String, @NotBlank)

- [ ] **SuspendUserRequest**:
  - reason (String, @NotBlank)

#### 4.3 Response DTO
- [ ] **UserResponse** (ì¬ì‚¬ìš©, AUT-001)

#### 4.4 Controller
- [ ] **UserController**:
  - activateUser(@PathVariable Long userId, @AuthenticationPrincipal requestedBy) â†’ ResponseEntity<UserResponse>
  - deactivateUser(@PathVariable Long userId, @Valid DeactivateUserRequest, @AuthenticationPrincipal requestedBy) â†’ ResponseEntity<UserResponse>
  - suspendUser(@PathVariable Long userId, @Valid SuspendUserRequest, @AuthenticationPrincipal requestedBy) â†’ ResponseEntity<UserResponse>

#### 4.5 Error Handling
- [ ] **InvalidUserStatusTransitionException** â†’ HTTP 400, "ì˜ëª»ëœ ìƒíƒœ ì „í™˜ì…ë‹ˆë‹¤"
- [ ] **InsufficientPermissionException** â†’ HTTP 403, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ User í™œì„±í™” (INACTIVE â†’ ACTIVE)**:
  - Given: INACTIVE ìƒíƒœ User
  - When: POST /api/v1/users/{userId}/activate
  - Then:
    - HTTP 200, status = ACTIVE
    - DB í™•ì¸: users.status = ACTIVE
    - Event í™•ì¸: UserActivated ë°œí–‰

- [ ] **ì •ìƒ User ë¹„í™œì„±í™” (ACTIVE â†’ INACTIVE)**:
  - Given: ACTIVE ìƒíƒœ User
  - When: POST /api/v1/users/{userId}/deactivate (reason: "íœ´ë©´ ì „í™˜")
  - Then:
    - HTTP 200, status = INACTIVE
    - DB í™•ì¸: users.status = INACTIVE
    - DB í™•ì¸: refresh_tokens í…Œì´ë¸”ì—ì„œ í•´ë‹¹ Userì˜ í† í° ì‚­ì œ
    - Event í™•ì¸: UserDeactivated ë°œí–‰

- [ ] **ì •ìƒ User ì •ì§€ (ACTIVE â†’ SUSPENDED)**:
  - Given: ACTIVE ìƒíƒœ User, SUPER_ADMIN ë¡œê·¸ì¸
  - When: POST /api/v1/users/{userId}/suspend (reason: "ë³´ì•ˆ ìœ„í˜‘")
  - Then:
    - HTTP 200, status = SUSPENDED
    - DB í™•ì¸: users.status = SUSPENDED
    - DB í™•ì¸: refresh_tokens í…Œì´ë¸”ì—ì„œ í•´ë‹¹ Userì˜ í† í° ì‚­ì œ
    - Event í™•ì¸: UserSuspended ë°œí–‰

- [ ] **ì˜ëª»ëœ ìƒíƒœ ì „í™˜ ì‹œë„ (DELETED â†’ ACTIVE)**:
  - Given: DELETED ìƒíƒœ User
  - When: POST /api/v1/users/{userId}/activate
  - Then: HTTP 400, "ì˜ëª»ëœ ìƒíƒœ ì „í™˜ì…ë‹ˆë‹¤"

- [ ] **ê¶Œí•œ ì—†ëŠ” ì •ì§€ ì‹œë„ (ORG_ADMIN â†’ SUSPENDED)**:
  - Given: ORG_ADMIN ë¡œê·¸ì¸ (SUPER_ADMIN ì•„ë‹˜)
  - When: POST /api/v1/users/{userId}/suspend
  - Then: HTTP 403, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

- [ ] **ë¹„í™œì„±í™”ëœ User ë¡œê·¸ì¸ ì‹œë„**:
  - Given: INACTIVE ìƒíƒœ User
  - When: POST /api/v1/auth/login/phone (ì˜¬ë°”ë¥¸ ë¹„ë°€ë²ˆí˜¸)
  - Then: HTTP 403, "ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤" (AUT-002 í†µí•©)

- [ ] **ì •ì§€ëœ User ë¡œê·¸ì¸ ì‹œë„**:
  - Given: SUSPENDED ìƒíƒœ User
  - When: POST /api/v1/auth/login/phone (ì˜¬ë°”ë¥¸ ë¹„ë°€ë²ˆí˜¸)
  - Then: HTTP 403, "ì •ì§€ëœ ê³„ì •ì…ë‹ˆë‹¤" (AUT-002 í†µí•©)

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V17 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **SUPER_ADMIN, ORG_ADMIN ì‚¬ìš©ì**: ê¶Œí•œ í…ŒìŠ¤íŠ¸ìš©

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Tell Don't Ask** - User.activate, deactivate, suspend, canTransitionTo ë©”ì„œë“œ ì‚¬ìš©
- [ ] **Transaction ê²½ê³„** - Refresh Token íê¸°ëŠ” íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì‹¤í–‰

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (User Aggregate)
  - AUT-001 (User ë“±ë¡)
  - AUT-003 (Refresh Token ê´€ë¦¬, DeleteAllRefreshTokensByUserIdPort)

### ë³´ì•ˆ ê·œì¹™
- [ ] **SUPER_ADMIN ì „ìš©** - User ì •ì§€(SUSPENDED)ëŠ” SUPER_ADMINë§Œ ê°€ëŠ¥
- [ ] **ORG_ADMIN í—ˆìš©** - User í™œì„±í™”/ë¹„í™œì„±í™”ëŠ” ORG_ADMINë„ ê°€ëŠ¥
- [ ] **Refresh Token íê¸°** - ë¹„í™œì„±í™”/ì •ì§€ ì‹œ ëª¨ë“  ì„¸ì…˜ ì¢…ë£Œ

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: User.activate, deactivate, suspend, canTransitionTo
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (User í™•ì¥, ìƒíƒœ ì „í™˜ ê·œì¹™)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (ActivateUserUseCase, DeactivateUserUseCase, SuspendUserUseCase)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (UserController)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 7ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **ìƒíƒœ ì „í™˜ ê·œì¹™ ê²€ì¦ ì™„ë£Œ (canTransitionTo)**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (5.2 User Status Management)
- **Plan**: docs/prd/plans/AUT-016-user-status-management-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-71

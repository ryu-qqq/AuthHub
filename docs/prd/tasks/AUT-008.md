# AUT-008: ì¹´ì¹´ì˜¤ ì†Œì…œ ë¡œê·¸ì¸ (Spring Security OAuth 2.0)

**Epic**: IAM Platform (AuthHub)
**Feature**: ì¹´ì¹´ì˜¤ ì†Œì…œ ë¡œê·¸ì¸
**Phase**: Phase 2 - Social Login
**ë¸Œëœì¹˜**: feature/AUT-008-kakao-oauth
**ì˜ì¡´ì„±**: AUT-000, AUT-001, AUT-002 (ë¡œê·¸ì¸)

---

## ğŸ“ ëª©ì 

**Spring Security OAuth 2.0 Client**ë¥¼ í™œìš©í•œ ì¹´ì¹´ì˜¤ ì†Œì…œ ë¡œê·¸ì¸ êµ¬í˜„
- Spring Securityì˜ í‘œì¤€ OAuth 2.0 Authorization Code Flow ì‚¬ìš©
- ì‹ ê·œ ì‚¬ìš©ì ìë™ ë“±ë¡ (ì „í™”ë²ˆí˜¸ ì„ íƒì  ìˆ˜ì§‘)
- ê¸°ì¡´ ì‚¬ìš©ì ì†Œì…œ ê³„ì • ì—°ë™
- Access Token ë° Refresh Token ë°œê¸‰ (ìì²´ JWT í† í°)

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 0. Infrastructure Layer (Spring Security OAuth 2.0 ì„¤ì •)

#### 0.1 Gradle Dependencies
- [ ] **build.gradle**:
  ```gradle
  dependencies {
      implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
  }
  ```

#### 0.2 Spring Security OAuth 2.0 Client ì„¤ì •
- [ ] **application.yml** (ë˜ëŠ” bootstrap/config ëª¨ë“ˆ):
  ```yaml
  spring:
    security:
      oauth2:
        client:
          registration:
            kakao:
              client-id: ${KAKAO_CLIENT_ID}
              client-secret: ${KAKAO_CLIENT_SECRET}
              redirect-uri: "{baseUrl}/login/oauth2/code/kakao"
              authorization-grant-type: authorization_code
              scope:
                - profile_nickname
                - profile_image
                - account_email
              client-name: Kakao
              client-authentication-method: client_secret_post
          provider:
            kakao:
              authorization-uri: https://kauth.kakao.com/oauth/authorize
              token-uri: https://kauth.kakao.com/oauth/token
              user-info-uri: https://kapi.kakao.com/v2/user/me
              user-name-attribute: id
  ```

#### 0.3 SecurityFilterChain ì„¤ì •
- [ ] **OAuth2LoginConfig** ìƒì„± (bootstrap-web-api ëª¨ë“ˆ):
  ```java
  @Configuration
  @EnableWebSecurity
  public class OAuth2LoginConfig {

      @Bean
      public SecurityFilterChain securityFilterChain(HttpSecurity http,
                                                     OAuth2AuthenticationSuccessHandler successHandler) {
          http
              .oauth2Login(oauth2 -> oauth2
                  .authorizationEndpoint(auth -> auth
                      .baseUri("/oauth2/authorization"))
                  .redirectionEndpoint(redirect -> redirect
                      .baseUri("/login/oauth2/code/*"))
                  .userInfoEndpoint(userInfo -> userInfo
                      .userService(customOAuth2UserService()))
                  .successHandler(successHandler)
              );
          return http.build();
      }
  }
  ```

**ì—”ë“œí¬ì¸íŠ¸ ë™ì‘**:
- ì‚¬ìš©ì ìš”ì²­: `GET /oauth2/authorization/kakao`
- Spring Securityê°€ ìë™ìœ¼ë¡œ Kakao ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
- ì¹´ì¹´ì˜¤ ì¸ì¦ í›„ ì½œë°±: `GET /login/oauth2/code/kakao?code=...`
- Spring Securityê°€ ìë™ìœ¼ë¡œ í† í° êµí™˜ ë° ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
- `OAuth2AuthenticationSuccessHandler`ë¡œ í›„ì† ì²˜ë¦¬

---

### 1. Domain Layer

#### 1.1 SocialAccount Aggregate
- [ ] **SocialAccount Aggregate Root** ìƒì„±
  - socialAccountId (SocialAccountId VO, Long)
  - userId (Long FK)
  - tenantId (Long FK)
  - provider (SocialProvider Enum)
  - providerId (String, Unique per provider)
  - email (Email VO, optional)
  - displayName (String)
  - profileImageUrl (String, optional)
  - createdAt, updatedAt (LocalDateTime)

**ë³€ê²½ ì‚¬í•­**: Kakao Access Token, Refresh Token ì €ì¥ ì œê±° (Spring Securityê°€ ê´€ë¦¬)

#### 1.2 SocialProvider Enum
- [ ] **SocialProvider Enum**:
  - KAKAO, GOOGLE, NAVER (Phase 2ì—ì„œëŠ” KAKAOë§Œ êµ¬í˜„)

#### 1.3 Domain Exception
- [ ] **SocialAccountNotFoundException** (ì†Œì…œ ê³„ì • ì—†ìŒ)
- [ ] **DuplicateSocialAccountException** (ì´ë¯¸ ì—°ë™ëœ ê³„ì •)

#### 1.4 Domain Event
- [ ] **SocialAccountLinked** Event
  - userId, provider, providerId, linkedAt

- [ ] **UserRegisteredViaSocial** Event
  - userId, provider, email, registeredAt

---

### 2. Application Layer

#### 2.1 LinkOrRegisterSocialAccountUseCase (Command)
- [ ] **Input**: LinkOrRegisterSocialAccountCommand
  - provider (SocialProvider)
  - providerId (String, from OAuth2User)
  - email (String, optional)
  - displayName (String)
  - profileImageUrl (String, optional)

- [ ] **Output**: LinkOrRegisterSocialAccountResult
  - userId (Long)
  - isNewUser (Boolean)
  - socialAccountId (Long)

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. providerIdë¡œ SocialAccount ì¡°íšŒ (LoadSocialAccountPort)
  2. **ì¡´ì¬ ì‹œ**: ê¸°ì¡´ ì‚¬ìš©ì ë°˜í™˜ (`isNewUser = false`)
  3. **ë¯¸ì¡´ì¬ ì‹œ**:
     - User.registerPublic (ì´ë©”ì¼ ë˜ëŠ” providerId ê¸°ë°˜)
     - SocialAccount ìƒì„± ë° ì €ì¥ (SaveSocialAccountPort)
     - UserRegisteredViaSocial Event ë°œí–‰ (`isNewUser = true`)
  4. SocialAccountLinked Event ë°œí–‰

**í•µì‹¬ ë³€ê²½**: OAuth2 í† í° êµí™˜ ë° ì‚¬ìš©ì ì •ë³´ ì¡°íšŒëŠ” Spring Securityê°€ ì²˜ë¦¬í•˜ë¯€ë¡œ UseCaseì—ì„œ ì œê±°

#### 2.2 GenerateTokensForSocialLoginUseCase (Command)
- [ ] **Input**: GenerateTokensForSocialLoginCommand
  - userId (Long)

- [ ] **Output**: AuthTokenResponse
  - accessToken (String)
  - refreshToken (String)
  - expiresAt (LocalDateTime)

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. User ì¡°íšŒ (LoadUserPort)
  2. Access Token ìƒì„± (GenerateAccessTokenPort)
  3. Refresh Token ìƒì„± ë° ì €ì¥ (SaveRefreshTokenPort)
  4. AuthTokenResponse ë°˜í™˜

#### 2.3 Port ì •ì˜
- [ ] **LoadSocialAccountPort** (Out):
  - load(SocialProvider, String providerId) â†’ Optional<SocialAccount>

- [ ] **SaveSocialAccountPort** (Out):
  - save(SocialAccount) â†’ SocialAccount

**ì œê±°ëœ Port**:
- ~~ExchangeKakaoTokenPort~~ (Spring Securityê°€ ì²˜ë¦¬)
- ~~LoadKakaoUserInfoPort~~ (Spring Securityê°€ ì²˜ë¦¬)

---

### 3. Persistence Layer

#### 3.1 SocialAccountEntity
- [ ] **SocialAccountEntity** ìƒì„±
  - id (Long, PK)
  - user_id (Long, FK)
  - tenant_id (Long, FK)
  - provider (String, KAKAO/GOOGLE/NAVER)
  - provider_id (String, Unique per provider)
  - email (String, Nullable)
  - display_name (String)
  - profile_image_url (String, Nullable)
  - created_at, updated_at (LocalDateTime)

**ë³€ê²½ ì‚¬í•­**: access_token, refresh_token, expires_at ì»¬ëŸ¼ ì œê±°

#### 3.2 Flyway ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] **V5__create_social_accounts.sql**:
  - social_accounts í…Œì´ë¸” ìƒì„±
  - Unique Constraint: (provider, provider_id)
  - Index: (user_id, provider)

#### 3.3 Repository
- [ ] **SocialAccountJpaRepository**:
  - save(SocialAccountEntity) â†’ SocialAccountEntity
  - findByProviderAndProviderId(String, String) â†’ Optional<SocialAccountEntity>
  - findByUserId(Long) â†’ List<SocialAccountEntity>

#### 3.4 Adapter
- [ ] **SocialAccountPersistenceAdapter** (LoadSocialAccountPort, SaveSocialAccountPort êµ¬í˜„)

**ì œê±°ëœ Adapter**:
- ~~KakaoApiAdapter~~ (Spring Security OAuth2 Clientê°€ ëŒ€ì²´)

#### 3.5 Mapper
- [ ] **SocialAccountMapper**:
  - toEntity(SocialAccount) â†’ SocialAccountEntity
  - toDomain(SocialAccountEntity) â†’ SocialAccount

---

### 4. REST API Layer (Spring Security OAuth 2.0 Integration)

#### 4.1 OAuth2 Endpoints (Spring Security ìë™ ì œê³µ)
- [ ] **GET /oauth2/authorization/kakao**
  - ì‚¬ìš©ìê°€ ì´ URL í´ë¦­ ì‹œ ì¹´ì¹´ì˜¤ ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  - Spring Securityê°€ ìë™ ì²˜ë¦¬

- [ ] **GET /login/oauth2/code/kakao** (Redirect URI)
  - ì¹´ì¹´ì˜¤ ì¸ì¦ í›„ ì½œë°± URL
  - Spring Securityê°€ ìë™ìœ¼ë¡œ í† í° êµí™˜ ë° ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
  - `CustomOAuth2UserService` â†’ `OAuth2AuthenticationSuccessHandler` í˜¸ì¶œ

**ì¤‘ìš”**: ì»¤ìŠ¤í…€ `/api/v1/auth/login/kakao` ì—”ë“œí¬ì¸íŠ¸ëŠ” **ì œê±°**

#### 4.2 CustomOAuth2UserService
- [ ] **CustomOAuth2UserService extends DefaultOAuth2UserService**:
  ```java
  @Service
  public class CustomOAuth2UserService extends DefaultOAuth2UserService {

      @Override
      public OAuth2User loadUser(OAuth2UserRequest userRequest) {
          OAuth2User oauth2User = super.loadUser(userRequest);

          // ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
          String providerId = oauth2User.getAttribute("id").toString();
          String email = oauth2User.getAttribute("kakao_account.email");
          String nickname = oauth2User.getAttribute("properties.nickname");
          String profileImage = oauth2User.getAttribute("properties.profile_image");

          // OAuth2Userì— ì¶”ê°€ ì •ë³´ ì €ì¥ (SuccessHandlerì—ì„œ ì‚¬ìš©)
          Map<String, Object> attributes = new HashMap<>(oauth2User.getAttributes());
          attributes.put("provider", "KAKAO");
          attributes.put("providerId", providerId);

          return new DefaultOAuth2User(
              oauth2User.getAuthorities(),
              attributes,
              "id"
          );
      }
  }
  ```

#### 4.3 OAuth2AuthenticationSuccessHandler
- [ ] **OAuth2AuthenticationSuccessHandler**:
  ```java
  @Component
  @RequiredArgsConstructor
  public class OAuth2AuthenticationSuccessHandler
      implements AuthenticationSuccessHandler {

      private final LinkOrRegisterSocialAccountUseCase linkOrRegisterUseCase;
      private final GenerateTokensForSocialLoginUseCase generateTokensUseCase;

      @Override
      public void onAuthenticationSuccess(HttpServletRequest request,
                                          HttpServletResponse response,
                                          Authentication authentication) {
          OAuth2User oauth2User = (OAuth2User) authentication.getPrincipal();

          // 1. ì†Œì…œ ê³„ì • ì—°ë™ ë˜ëŠ” ì‹ ê·œ ì‚¬ìš©ì ë“±ë¡
          LinkOrRegisterSocialAccountCommand command = new LinkOrRegisterSocialAccountCommand(
              SocialProvider.KAKAO,
              oauth2User.getAttribute("providerId"),
              oauth2User.getAttribute("kakao_account.email"),
              oauth2User.getAttribute("properties.nickname"),
              oauth2User.getAttribute("properties.profile_image")
          );

          LinkOrRegisterSocialAccountResult result = linkOrRegisterUseCase.execute(command);

          // 2. JWT í† í° ë°œê¸‰
          GenerateTokensForSocialLoginCommand tokenCommand =
              new GenerateTokensForSocialLoginCommand(result.userId());

          AuthTokenResponse tokenResponse = generateTokensUseCase.execute(tokenCommand);

          // 3. í”„ë¡ íŠ¸ì—”ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (í† í° ì „ë‹¬)
          String redirectUrl = String.format(
              "%s/auth/callback?accessToken=%s&refreshToken=%s",
              frontendBaseUrl,
              tokenResponse.accessToken(),
              tokenResponse.refreshToken()
          );

          response.sendRedirect(redirectUrl);
      }
  }
  ```

#### 4.4 Error Handling
- [ ] **OAuth2AuthenticationFailureHandler**:
  - OAuth ì¸ì¦ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
  - ì—ëŸ¬ ë©”ì‹œì§€ì™€ í•¨ê»˜ í”„ë¡ íŠ¸ì—”ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  ```java
  @Component
  public class OAuth2AuthenticationFailureHandler
      implements AuthenticationFailureHandler {

      @Override
      public void onAuthenticationFailure(HttpServletRequest request,
                                          HttpServletResponse response,
                                          AuthenticationException exception) {
          String redirectUrl = String.format(
              "%s/auth/error?message=%s",
              frontendBaseUrl,
              URLEncoder.encode(exception.getMessage(), StandardCharsets.UTF_8)
          );
          response.sendRedirect(redirectUrl);
      }
  }
  ```

---

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ (ì‹ ê·œ ì‚¬ìš©ì)**:
  - Given: Spring Security OAuth2 Mock ì„¤ì • (MockOAuth2User)
  - When: OAuth2 ì¸ì¦ ì™„ë£Œ â†’ SuccessHandler í˜¸ì¶œ
  - Then:
    - DB í™•ì¸: users, social_accounts, refresh_tokens í…Œì´ë¸”ì— ë°ì´í„° ì‚½ì…
    - Event í™•ì¸: UserRegisteredViaSocial ë°œí–‰
    - ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì— JWT í† í° í¬í•¨

- [ ] **ì •ìƒ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ (ê¸°ì¡´ ì‚¬ìš©ì)**:
  - Given: ì´ë¯¸ ë“±ë¡ëœ ì¹´ì¹´ì˜¤ ê³„ì • (providerId ì¡´ì¬)
  - When: OAuth2 ì¸ì¦ ì™„ë£Œ â†’ SuccessHandler í˜¸ì¶œ
  - Then:
    - DB í™•ì¸: ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° ì¡°íšŒ
    - Event í™•ì¸: SocialAccountLinked ë°œí–‰
    - ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì— JWT í† í° í¬í•¨

- [ ] **ì¹´ì¹´ì˜¤ OAuth ì¸ì¦ ì‹¤íŒ¨**:
  - Given: ì˜ëª»ëœ OAuth2 ìƒíƒœ
  - When: OAuth2 ì¸ì¦ ì‹¤íŒ¨
  - Then: FailureHandler í˜¸ì¶œ â†’ ì—ëŸ¬ ë©”ì‹œì§€ì™€ í•¨ê»˜ í”„ë¡ íŠ¸ì—”ë“œ ë¦¬ë‹¤ì´ë ‰íŠ¸

#### 5.2 í…ŒìŠ¤íŠ¸ ì „ëµ
- [ ] **Spring Security Test í™œìš©**:
  ```java
  @SpringBootTest
  @AutoConfigureMockMvc
  class KakaoOAuthIntegrationTest {

      @Test
      void ì¹´ì¹´ì˜¤_ì†Œì…œ_ë¡œê·¸ì¸_ì‹ ê·œ_ì‚¬ìš©ì() {
          // Given
          OAuth2User mockOAuth2User = new DefaultOAuth2User(
              Collections.singleton(new SimpleGrantedAuthority("ROLE_USER")),
              Map.of(
                  "id", "12345678",
                  "kakao_account", Map.of("email", "user@kakao.com"),
                  "properties", Map.of("nickname", "í™ê¸¸ë™")
              ),
              "id"
          );

          // When
          successHandler.onAuthenticationSuccess(request, response,
              new OAuth2AuthenticationToken(mockOAuth2User, ...));

          // Then
          assertThat(userRepository.findByEmail("user@kakao.com")).isPresent();
          assertThat(socialAccountRepository.findByProviderAndProviderId("KAKAO", "12345678"))
              .isPresent();
      }
  }
  ```

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Spring Security OAuth2 í‘œì¤€ ì¤€ìˆ˜** - ì»¤ìŠ¤í…€ OAuth ì—”ë“œí¬ì¸íŠ¸ ê¸ˆì§€
- [ ] **Transaction ê²½ê³„** - OAuth2 í† í° êµí™˜ì€ Spring Securityê°€ ì²˜ë¦¬ (íŠ¸ëœì­ì…˜ ë°–)
- [ ] **SuccessHandler ë‚´ UseCase í˜¸ì¶œ** - OAuth2 í›„ì† ì²˜ë¦¬ëŠ” Application Layer UseCaseë¡œ ìœ„ì„

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000, AUT-001 (User Aggregate, ì‚¬ìš©ì ë“±ë¡)
  - AUT-002 (AuthToken, Access Token ë°œê¸‰)
  - Spring Security OAuth2 Client (spring-boot-starter-oauth2-client)

### ë³´ì•ˆ ê·œì¹™
- [ ] **HTTPS í•„ìˆ˜** - Redirect URIëŠ” HTTPSë§Œ í—ˆìš© (í”„ë¡œë•ì…˜)
- [ ] **CSRF ë³´í˜¸** - Spring Securityì˜ CSRF ë³´í˜¸ í™œì„±í™”
- [ ] **State Parameter** - Spring Securityê°€ ìë™ìœ¼ë¡œ CSRF ê³µê²© ë°©ì§€

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: SocialAccount VO ê²€ì¦
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: Spring Security Test + MockOAuth2User
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Infrastructure Layer êµ¬í˜„ ì™„ë£Œ (Spring Security OAuth2 Client ì„¤ì •)
- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (SocialAccount, SocialProvider)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (LinkOrRegisterSocialAccountUseCase, GenerateTokensForSocialLoginUseCase)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (SocialAccountEntity, Repository)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (CustomOAuth2UserService, OAuth2AuthenticationSuccessHandler)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 3ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **Spring Security OAuth2 í‘œì¤€ ì¤€ìˆ˜ ê²€ì¦**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (2.1.3 LoginWithKakaoUseCase)
- **Plan**: docs/prd/plans/AUT-005-kakao-oauth-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-61
- **Spring Security OAuth2**: https://docs.spring.io/spring-security/reference/servlet/oauth2/login/index.html

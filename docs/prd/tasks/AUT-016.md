# AUT-016: Account Locking

**Epic**: IAM Platform (AuthHub)
**Feature**: Account Locking
**Phase**: Phase 3 - Security & Monitoring
**ë¸Œëœì¹˜**: feature/AUT-016-account-locking
**ì˜ì¡´ì„±**: AUT-000, AUT-002 (ë¡œê·¸ì¸), AUT-015 (Audit Log)

---

## ğŸ“ ëª©ì 

ê³„ì • ì ê¸ˆ ê¸°ëŠ¥ êµ¬í˜„ (ì—°ì† ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ)
- ì—°ì† 5íšŒ ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ê³„ì • ìë™ ì ê¸ˆ (30ë¶„)
- SUPER_ADMINì— ì˜í•œ ìˆ˜ë™ ì ê¸ˆ/ì ê¸ˆ í•´ì œ
- ì ê¸ˆ ì´ë ¥ Audit Log ê¸°ë¡

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 User Aggregate í™•ì¥
- [ ] **User Aggregateì— ì¶”ê°€**:
  - accountLockStatus (AccountLockStatus Enum)
  - lockReason (String)
  - lockedAt (LocalDateTime, Nullable)
  - lockExpiresAt (LocalDateTime, Nullable)
  - `lock(String reason, Duration duration)` â†’ void
  - `unlock()` â†’ void
  - `isLocked()` â†’ boolean
  - `canLogin()` â†’ boolean (ìƒíƒœ + ì ê¸ˆ í™•ì¸)

#### 1.2 AccountLockStatus Enum
- [ ] **AccountLockStatus Enum**:
  - UNLOCKED (ì •ìƒ)
  - LOCKED_AUTO (ìë™ ì ê¸ˆ, ì—°ì† ë¡œê·¸ì¸ ì‹¤íŒ¨)
  - LOCKED_MANUAL (ìˆ˜ë™ ì ê¸ˆ, SUPER_ADMIN)

#### 1.3 LoginAttempt VO
- [ ] **LoginAttempt VO** ìƒì„±
  - phoneNumber (String)
  - attemptCount (int)
  - lastAttemptAt (LocalDateTime)
  - windowStart (LocalDateTime)

#### 1.4 Domain Exception
- [ ] **AccountLockedException** (ê³„ì • ì ê¸ˆ)
  - lockReason (String)
  - lockExpiresAt (LocalDateTime)

#### 1.5 Domain Event
- [ ] **AccountLocked** Event
  - userId, lockReason, lockedAt, lockExpiresAt, lockStatus

- [ ] **AccountUnlocked** Event
  - userId, unlockedBy, unlockedAt

### 2. Application Layer

#### 2.1 LoginWithPhoneUseCase í™•ì¥ (AUT-002)
- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì¶”ê°€**:
  1. ì „í™”ë²ˆí˜¸ë¡œ ì‚¬ìš©ì ì¡°íšŒ
  2. **ê³„ì • ì ê¸ˆ í™•ì¸**: User.isLocked() â†’ AccountLockedException
  3. ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
  4. **ì„±ê³µ ì‹œ**: LoginAttempt ì´ˆê¸°í™” (RecordLoginAttemptPort)
  5. **ì‹¤íŒ¨ ì‹œ**:
     - LoginAttempt ì¦ê°€ (RecordLoginAttemptPort)
     - 5íšŒ ë„ë‹¬ ì‹œ: User.lock("ì—°ì† 5íšŒ ë¡œê·¸ì¸ ì‹¤íŒ¨", 30ë¶„)
     - AccountLocked Event ë°œí–‰

#### 2.2 LockAccountUseCase (Command)
- [ ] **Input**: LockAccountCommand
  - userId (Long)
  - reason (String)
  - duration (Duration, optional, nullì´ë©´ ì˜êµ¬ ì ê¸ˆ)
  - requestedBy (Long, SUPER_ADMIN userId)

- [ ] **Output**: void

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. SUPER_ADMIN ê¶Œí•œ ê²€ì¦
  2. User ì¡°íšŒ (LoadUserPort)
  3. User.lock(reason, duration)
  4. User ì €ì¥ (SaveUserPort)
  5. AccountLocked Event ë°œí–‰

#### 2.3 UnlockAccountUseCase (Command)
- [ ] **Input**: UnlockAccountCommand
  - userId (Long)
  - requestedBy (Long, SUPER_ADMIN userId)

- [ ] **Output**: void

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. SUPER_ADMIN ê¶Œí•œ ê²€ì¦
  2. User ì¡°íšŒ (LoadUserPort)
  3. User.unlock()
  4. User ì €ì¥ (SaveUserPort)
  5. AccountUnlocked Event ë°œí–‰

#### 2.4 Port ì •ì˜
- [ ] **RecordLoginAttemptPort** (Out):
  - recordSuccess(String phoneNumber) â†’ void (Redis ì‚­ì œ)
  - recordFailure(String phoneNumber) â†’ LoginAttempt (Redis ì¦ê°€)

- [ ] **LoadLoginAttemptPort** (Out):
  - load(String phoneNumber) â†’ Optional<LoginAttempt>

### 3. Persistence Layer

#### 3.1 UserEntity í™•ì¥
- [ ] **UserEntityì— ì¶”ê°€**:
  - account_lock_status (String, UNLOCKED/LOCKED_AUTO/LOCKED_MANUAL)
  - lock_reason (String, Nullable)
  - locked_at (LocalDateTime, Nullable)
  - lock_expires_at (LocalDateTime, Nullable)

#### 3.2 Flyway ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] **V17__add_account_lock_fields.sql**:
  - users í…Œì´ë¸”ì— ê³„ì • ì ê¸ˆ ê´€ë ¨ ì»¬ëŸ¼ ì¶”ê°€
  - Index: (account_lock_status, lock_expires_at)

#### 3.3 Redis LoginAttempt
- [ ] **RedisLoginAttemptRepository** êµ¬í˜„
  - Key: `login_attempt:{phoneNumber}`
  - Value: JSON (attemptCount, lastAttemptAt, windowStart)
  - TTL: 30ë¶„ (ìœˆë„ìš° ê¸°ê°„)
  - recordFailure(): Increment attempt count
  - recordSuccess(): Delete key

#### 3.4 Adapter
- [ ] **LoginAttemptAdapter** (RecordLoginAttemptPort, LoadLoginAttemptPort êµ¬í˜„)

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/users/{userId}/lock**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 204 No Content
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN)

- [ ] **POST /api/v1/users/{userId}/unlock**
  - HTTP Method: POST
  - Response: HTTP 204 No Content
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN)

#### 4.2 Request DTO
- [ ] **LockAccountRequest**:
  - reason (String, @NotBlank)
  - durationMinutes (Integer, optional)

#### 4.3 Controller
- [ ] **UserController**:
  - lockAccount(@PathVariable Long userId, @Valid LockAccountRequest, @AuthenticationPrincipal requestedBy) â†’ ResponseEntity<Void>
  - unlockAccount(@PathVariable Long userId, @AuthenticationPrincipal requestedBy) â†’ ResponseEntity<Void>

#### 4.4 Error Handling
- [ ] **AccountLockedException** â†’ HTTP 403 Forbidden
  ```json
  {
    "errorCode": "ACCOUNT_LOCKED",
    "message": "ê³„ì •ì´ ì ê²¼ìŠµë‹ˆë‹¤",
    "lockReason": "ì—°ì† 5íšŒ ë¡œê·¸ì¸ ì‹¤íŒ¨",
    "lockExpiresAt": "2024-01-01T12:30:00",
    "details": {
      "remainingMinutes": 25
    }
  }
  ```

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ìë™ ê³„ì • ì ê¸ˆ (5íšŒ ì‹¤íŒ¨)**:
  - Given: ìœ íš¨í•œ ì‚¬ìš©ì (phone: 010-1234-5678)
  - When: ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ë¡œ 5ë²ˆ ë¡œê·¸ì¸ ì‹œë„
  - Then:
    - 1~4ë²ˆ: HTTP 401, "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
    - 5ë²ˆ: HTTP 403, "ê³„ì •ì´ ì ê²¼ìŠµë‹ˆë‹¤" (lockReason: "ì—°ì† 5íšŒ ë¡œê·¸ì¸ ì‹¤íŒ¨")
  - DB í™•ì¸:
    - users.account_lock_status = LOCKED_AUTO
    - users.lock_expires_at = now + 30ë¶„
  - Event í™•ì¸: AccountLocked ë°œí–‰

- [ ] **ì ê¸´ ê³„ì • ë¡œê·¸ì¸ ì‹œë„**:
  - Given: ê³„ì • ì ê¸ˆ ìƒíƒœ (LOCKED_AUTO)
  - When: ì˜¬ë°”ë¥¸ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ ì‹œë„
  - Then: HTTP 403, "ê³„ì •ì´ ì ê²¼ìŠµë‹ˆë‹¤"

- [ ] **ìë™ ì ê¸ˆ í•´ì œ (30ë¶„ ê²½ê³¼)**:
  - Given: ê³„ì • ì ê¸ˆ (lock_expires_at = now - 1ë¶„)
  - When: ë¡œê·¸ì¸ ì‹œë„
  - Then: HTTP 200 (ìë™ ì ê¸ˆ í•´ì œ)

- [ ] **ìˆ˜ë™ ê³„ì • ì ê¸ˆ (SUPER_ADMIN)**:
  - Given: SUPER_ADMIN ë¡œê·¸ì¸
  - When: POST /api/v1/users/{userId}/lock (reason: "ë³´ì•ˆ ìœ„í˜‘ ê°ì§€")
  - Then:
    - HTTP 204
    - DB í™•ì¸: account_lock_status = LOCKED_MANUAL, lock_expires_at = null (ì˜êµ¬)
  - Event í™•ì¸: AccountLocked ë°œí–‰

- [ ] **ìˆ˜ë™ ì ê¸ˆ í•´ì œ (SUPER_ADMIN)**:
  - Given: ìˆ˜ë™ ì ê¸ˆ ìƒíƒœ (LOCKED_MANUAL)
  - When: POST /api/v1/users/{userId}/unlock
  - Then:
    - HTTP 204
    - DB í™•ì¸: account_lock_status = UNLOCKED, locked_at = null
  - Event í™•ì¸: AccountUnlocked ë°œí–‰

- [ ] **ì„±ê³µ ë¡œê·¸ì¸ â†’ LoginAttempt ì´ˆê¸°í™”**:
  - Given: 3íšŒ ë¡œê·¸ì¸ ì‹¤íŒ¨ (attemptCount = 3)
  - When: ì˜¬ë°”ë¥¸ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ ì„±ê³µ
  - Then:
    - HTTP 200
    - Redis í™•ì¸: login_attempt:{phoneNumber} í‚¤ ì‚­ì œ

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V17 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **Testcontainers**: Redis (LoginAttempt)
- [ ] **SUPER_ADMIN ì‚¬ìš©ì**: INTERNAL ì‚¬ìš©ì + SUPER_ADMIN ê¶Œí•œ

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Tell Don't Ask** - User.lock, unlock, isLocked, canLogin ë©”ì„œë“œ ì‚¬ìš©

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (User Aggregate)
  - AUT-002 (LoginWithPhoneUseCase)
  - AUT-013 (Audit Log, Event ê¸°ë¡)

### ë³´ì•ˆ ê·œì¹™
- [ ] **ìë™ ì ê¸ˆ í•´ì œ** - 30ë¶„ ê²½ê³¼ ì‹œ ìë™ í•´ì œ (LOCKED_AUTOë§Œ)
- [ ] **SUPER_ADMIN ìˆ˜ë™ í•´ì œ** - LOCKED_MANUALì€ SUPER_ADMINë§Œ í•´ì œ ê°€ëŠ¥

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: User.lock, unlock, isLocked, canLogin
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate + Testcontainers Redis
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (User í™•ì¥, AccountLockStatus Enum, LoginAttempt VO)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (LoginWithPhoneUseCase í™•ì¥, LockAccountUseCase, UnlockAccountUseCase)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (UserEntity í™•ì¥, Redis LoginAttempt)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (UserController, Error Handling)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 6ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **ìë™ ì ê¸ˆ/í•´ì œ ë¡œì§ ê²€ì¦ ì™„ë£Œ**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (4.3 Account Locking)
- **Plan**: docs/prd/plans/AUT-014-account-locking-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-69

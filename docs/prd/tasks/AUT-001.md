# AUT-001: ì‚¬ìš©ì ë“±ë¡ (PUBLIC - ì „í™”ë²ˆí˜¸)

**Epic**: IAM Platform (AuthHub)
**Feature**: ì‚¬ìš©ì ë“±ë¡ (ì „í™”ë²ˆí˜¸ ê¸°ë°˜)
**Phase**: Phase 1 - Core Authentication
**ë¸Œëœì¹˜**: feature/AUT-001-user-registration
**ì˜ì¡´ì„±**: AUT-000 (Domain Skeleton)

---

## ğŸ“ ëª©ì 

PUBLIC ì‚¬ìš©ìì˜ ì „í™”ë²ˆí˜¸ ê¸°ë°˜ íšŒì› ê°€ì… ê¸°ëŠ¥ êµ¬í˜„
- ì „í™”ë²ˆí˜¸ ì¤‘ë³µ ë°©ì§€
- ë¹„ë°€ë²ˆí˜¸ ì•ˆì „ ì €ì¥ (BCrypt)
- Tenant ìë™ í• ë‹¹ ("Connectly Public Tenant")

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 Credential VO (Phone + Email ì§€ì›)
- [ ] **Credential VO** ìƒì„±
  - email (Email VO, optional, INTERNAL ì‚¬ìš©ì í•„ìˆ˜)
  - phoneNumber (PhoneNumber VO, optional, PUBLIC ì‚¬ìš©ì í•„ìˆ˜)
  - password (String, BCrypt í•´ì‹œ)
  - credentialType (Enum: PHONE, EMAIL, SOCIAL)
  - phoneLoginEnabled (Boolean, default: false)
  - emailLoginEnabled (Boolean, default: false)
  - createdAt, updatedAt (LocalDateTime)

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™**:
  - ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦ (ì •ê·œì‹, PhoneNumber VO)
  - ì´ë©”ì¼ í˜•ì‹ ê²€ì¦ (RFC 5322, Email VO)
  - ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ ì²˜ë¦¬ (BCrypt)
  - `ofPhone(phoneNumber, password, ClockHolder)` íŒ©í† ë¦¬ ë©”ì„œë“œ (PUBLIC ì‚¬ìš©ììš©)
  - `ofEmail(email, password, ClockHolder)` íŒ©í† ë¦¬ ë©”ì„œë“œ (INTERNAL ì‚¬ìš©ììš©, AUT-001.5ì—ì„œ ì¶”ê°€)

#### 1.2 Email VO
- [ ] **Email VO** ìƒì„±
  - value (String, RFC 5322 í˜•ì‹)
  - `validate()` ë©”ì„œë“œ (ì´ë©”ì¼ í˜•ì‹ ê²€ì¦)

#### 1.3 PhoneNumber VO
- [ ] **PhoneNumber VO** ìƒì„±
  - value (String, êµ­ì œ í˜•ì‹: +82-10-1234-5678)
  - `validate()` ë©”ì„œë“œ (ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦)

#### 1.4 UserProfile VO
- [ ] **UserProfile VO** ìƒì„±
  - name (String, 1-50ì)
  - profileImageUrl (String, optional)

#### 1.5 User Aggregate í™•ì¥
- [ ] **User Aggregateì— ì¶”ê°€**:
  - credential (Credential VO)
  - profile (UserProfile VO)

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™**:
  - `User.registerPublic(phoneNumber, password, name)` íŒ©í† ë¦¬ ë©”ì„œë“œ
  - PUBLIC ì‚¬ìš©ìëŠ” organizationId = null
  - Tenant ìë™ í• ë‹¹

#### 1.6 Domain Exception
- [ ] **DuplicatePhoneNumberException** (ì „í™”ë²ˆí˜¸ ì¤‘ë³µ)
- [ ] **InvalidPhoneNumberException** (ì „í™”ë²ˆí˜¸ í˜•ì‹ ì˜¤ë¥˜)
- [ ] **InvalidPasswordException** (ë¹„ë°€ë²ˆí˜¸ í˜•ì‹ ì˜¤ë¥˜)

#### 1.7 Domain Event
- [ ] **UserRegistered** Event
  - userId, tenantId, phoneNumber, registeredAt

### 2. Application Layer

#### 2.1 RegisterUserUseCase (Command)
- [ ] **Input**: RegisterUserCommand
  - phoneNumber (String)
  - password (String)
  - name (String)
  - profileImageUrl (String, optional)

- [ ] **Output**: UserResponse
  - userId, userType, phoneNumber, name, status, createdAt

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. ì „í™”ë²ˆí˜¸ ì¤‘ë³µ í™•ì¸ (CheckDuplicatePhoneNumberPort)
  2. Credential ìƒì„± (BCrypt í•´ì‹œ)
  3. User Aggregate ìƒì„± (userType=PUBLIC, tenantId=1)
  4. User ì €ì¥ (SaveUserPort)
  5. UserRegistered Event ë°œí–‰

#### 2.2 Port ì •ì˜
- [ ] **SaveUserPort** (Out):
  - save(User) â†’ User

- [ ] **CheckDuplicatePhoneNumberPort** (Out):
  - exists(Long tenantId, String phoneNumber) â†’ boolean

### 3. Persistence Layer

#### 3.1 UserEntity í™•ì¥
- [ ] **UserEntityì— ì¶”ê°€**:
  - phone_number (String, Unique with tenant_id)
  - password (String, BCrypt hash)
  - name (String)
  - profile_image_url (String, Nullable)

- [ ] **Unique Constraint**:
  - `UNIQUE(tenant_id, phone_number)`

#### 3.2 Flyway ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] **V3__add_user_credentials.sql**:
  - phone_number, password ì»¬ëŸ¼ ì¶”ê°€
  - name, profile_image_url ì»¬ëŸ¼ ì¶”ê°€
  - Unique Constraint ì¶”ê°€

#### 3.3 Repository
- [ ] **UserJpaRepository**:
  - save(UserEntity) â†’ UserEntity
  - findByTenantIdAndPhoneNumber(Long, String) â†’ Optional<UserEntity>
  - existsByTenantIdAndPhoneNumber(Long, String) â†’ boolean

#### 3.4 Adapter
- [ ] **UserCommandAdapter** (SaveUserPort êµ¬í˜„):
  - save(User) â†’ User (Domain â†” Entity ë³€í™˜)

- [ ] **UserQueryAdapter** (CheckDuplicatePhoneNumberPort êµ¬í˜„):
  - exists(Long tenantId, String phoneNumber) â†’ boolean

#### 3.5 Mapper
- [ ] **UserMapper**:
  - toEntity(User) â†’ UserEntity
  - toDomain(UserEntity) â†’ User

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/auth/register**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 201 Created

#### 4.2 Request DTO
- [ ] **RegisterUserRequest**:
  - phoneNumber (String, @NotBlank, @Pattern)
  - password (String, @NotBlank, @Size(min=8))
  - name (String, @NotBlank, @Size(min=1, max=50))
  - profileImageUrl (String, optional)

#### 4.3 Response DTO
- [ ] **UserResponse**:
  - userId (Long)
  - userType (String)
  - phoneNumber (String)
  - name (String)
  - status (String)
  - createdAt (LocalDateTime)

#### 4.4 Controller
- [ ] **AuthController**:
  - register(@Valid RegisterUserRequest) â†’ ResponseEntity<UserResponse>

#### 4.5 Validation
- [ ] **ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦**: `@Pattern(regexp = "^\\+82-10-\\d{4}-\\d{4}$")`
- [ ] **ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ê²€ì¦**: ìµœì†Œ 8ì
- [ ] **ì´ë¦„ ê¸¸ì´ ê²€ì¦**: 1-50ì

#### 4.6 Error Handling
- [ ] **DuplicatePhoneNumberException** â†’ HTTP 409 Conflict
- [ ] **InvalidPhoneNumberException** â†’ HTTP 400 Bad Request
- [ ] **MethodArgumentNotValidException** â†’ HTTP 400 Bad Request

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ íšŒì› ê°€ì…**:
  - Given: ì‹œìŠ¤í…œ ì´ˆê¸° ìƒíƒœ
  - When: POST /api/v1/auth/register (ìœ íš¨í•œ ë°ì´í„°)
  - Then: HTTP 201, UserResponse ë°˜í™˜
  - DB í™•ì¸: users í…Œì´ë¸”ì— ë°ì´í„° ì‚½ì…

- [ ] **ì „í™”ë²ˆí˜¸ ì¤‘ë³µ**:
  - Given: ì´ë¯¸ ë“±ë¡ëœ ì „í™”ë²ˆí˜¸ (010-1234-5678)
  - When: POST /api/v1/auth/register (ê°™ì€ ì „í™”ë²ˆí˜¸)
  - Then: HTTP 409, "ì „í™”ë²ˆí˜¸ê°€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤"

- [ ] **ì „í™”ë²ˆí˜¸ í˜•ì‹ ì˜¤ë¥˜**:
  - Given: ì‹œìŠ¤í…œ ì´ˆê¸° ìƒíƒœ
  - When: POST /api/v1/auth/register (ì˜ëª»ëœ í˜•ì‹: "010-1234-5678")
  - Then: HTTP 400, "ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤"

- [ ] **ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ë¶€ì¡±**:
  - Given: ì‹œìŠ¤í…œ ì´ˆê¸° ìƒíƒœ
  - When: POST /api/v1/auth/register (ë¹„ë°€ë²ˆí˜¸: "1234")
  - Then: HTTP 400, "ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤"

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1, V2, V3 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **TestRestTemplate** ì‚¬ìš©

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Lombok ê¸ˆì§€** - Credential, UserProfile VOëŠ” Record ì‚¬ìš©
- [ ] **Law of Demeter** - `user.getPhoneNumber()` ì§ì ‘ ì œê³µ
- [ ] **Long FK ì „ëµ** - `private Long tenantId`
- [ ] **Transaction ê²½ê³„** - ì™¸ë¶€ API í˜¸ì¶œ ì—†ìŒ (DB ì €ì¥ë§Œ)

### ì˜ì¡´ì„±
- **í•„ìˆ˜**: AUT-000 (User, Tenant ê¸°ë³¸ êµ¬ì¡°)
- **ì„ íƒ**: ì—†ìŒ

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: Credential, UserProfile ê²€ì¦ ë¡œì§
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (Credential, UserProfile, User í™•ì¥)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (RegisterUserUseCase)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (Entity, Repository, Adapter)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (Controller, DTO)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 4ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **ë…ë¦½ ë°°í¬ ê°€ëŠ¥ í™•ì¸** (íšŒì› ê°€ì… ê¸°ëŠ¥ë§Œ ë™ì‘)
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (1.1 ì‚¬ìš©ì ìƒì„± - PUBLIC ì‚¬ìš©ì)
- **Plan**: docs/prd/plans/AUT-001-user-registration-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-54

# AUT-015: Audit Log

**Epic**: IAM Platform (AuthHub)
**Feature**: Audit Log
**Phase**: Phase 3 - Security & Monitoring
**ë¸Œëœì¹˜**: feature/AUT-015-audit-log
**ì˜ì¡´ì„±**: AUT-000, AUT-001, AUT-002 (ëª¨ë“  ê¸°ëŠ¥)

---

## ğŸ“ ëª©ì 

ì‹œìŠ¤í…œ ê°ì‚¬ ë¡œê·¸ ê¸°ë¡ ê¸°ëŠ¥ êµ¬í˜„
- ì‚¬ìš©ì í–‰ìœ„ ì¶”ì  (ë¡œê·¸ì¸, ê¶Œí•œ ë³€ê²½ ë“±)
- ë³´ì•ˆ ì´ë²¤íŠ¸ ê¸°ë¡ (ì‹¤íŒ¨í•œ ë¡œê·¸ì¸, ê¶Œí•œ ìœ„ë°˜ ì‹œë„)
- ì´ë²¤íŠ¸ ê¸°ë°˜ ë¹„ë™ê¸° ë¡œê·¸ ì €ì¥
- Audit Log ì¡°íšŒ (ê²€ìƒ‰, í•„í„°ë§)

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 AuditLog Aggregate
- [ ] **AuditLog Aggregate Root** ìƒì„±
  - auditLogId (AuditLogId VO, Long)
  - tenantId (Long FK)
  - userId (Long FK, Nullable)
  - eventType (EventType Enum)
  - resourceType (ResourceType Enum)
  - resourceId (String)
  - action (ActionType Enum)
  - ipAddress (String)
  - userAgent (String)
  - status (AuditLogStatus Enum: SUCCESS, FAILURE)
  - details (Map<String, Object>, JSON)
  - occurredAt (LocalDateTime)

#### 1.2 EventType Enum
- [ ] **EventType Enum**:
  - AUTHENTICATION (ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ)
  - AUTHORIZATION (ê¶Œí•œ ë³€ê²½)
  - RESOURCE_MANAGEMENT (Tenant, Organization, User ìƒì„±/ìˆ˜ì •/ì‚­ì œ)

#### 1.3 AuditLogStatus Enum
- [ ] **AuditLogStatus Enum**:
  - SUCCESS (ì„±ê³µ)
  - FAILURE (ì‹¤íŒ¨)

#### 1.4 AuditLogId VO
- [ ] **AuditLogId VO** (Long ê¸°ë°˜)

### 2. Application Layer

#### 2.1 RecordAuditLogUseCase (Command, Event-Driven)
- [ ] **Trigger**: ëª¨ë“  Domain Event (UserLoggedIn, RoleAssignedToUser ë“±)

- [ ] **Input**: RecordAuditLogCommand
  - tenantId (Long)
  - userId (Long, optional)
  - eventType (EventType)
  - resourceType (ResourceType)
  - resourceId (String)
  - action (ActionType)
  - ipAddress (String)
  - userAgent (String)
  - status (AuditLogStatus)
  - details (Map<String, Object>)

- [ ] **Output**: void (ë¹„ë™ê¸° ì²˜ë¦¬)

- [ ] **Transaction**: í•„ìˆ˜ (ë³„ë„ íŠ¸ëœì­ì…˜)

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. AuditLog Aggregate ìƒì„±
  2. AuditLog ì €ì¥ (SaveAuditLogPort)

#### 2.2 GetAuditLogsQuery (Query)
- [ ] **Input**: GetAuditLogsQueryRequest
  - tenantId (Long, optional filter)
  - userId (Long, optional filter)
  - eventType (EventType, optional filter)
  - resourceType (ResourceType, optional filter)
  - status (AuditLogStatus, optional filter)
  - startDate (LocalDateTime, optional filter)
  - endDate (LocalDateTime, optional filter)
  - page, size (Pagination)

- [ ] **Output**: PageResponse<AuditLogResponse>

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. AuditLog ëª©ë¡ ì¡°íšŒ (LoadAuditLogsPort)

#### 2.3 Port ì •ì˜
- [ ] **SaveAuditLogPort** (Out):
  - save(AuditLog) â†’ AuditLog

- [ ] **LoadAuditLogsPort** (Out):
  - loadAll(tenantId, userId, eventType, resourceType, status, startDate, endDate, Pageable) â†’ Page<AuditLog>

### 3. Persistence Layer

#### 3.1 AuditLogEntity
- [ ] **AuditLogEntity** ìƒì„±
  - id (Long, PK)
  - tenant_id (Long, FK)
  - user_id (Long, FK, Nullable)
  - event_type (String, AUTHENTICATION/AUTHORIZATION/RESOURCE_MANAGEMENT)
  - resource_type (String, TENANT/ORGANIZATION/USER/ROLE/PERMISSION)
  - resource_id (String)
  - action (String, CREATE/READ/UPDATE/DELETE/LOGIN/LOGOUT)
  - ip_address (String)
  - user_agent (String)
  - status (String, SUCCESS/FAILURE)
  - details (String, JSON)
  - occurred_at (LocalDateTime, Index)

#### 3.2 Flyway ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] **V16__create_audit_logs.sql**:
  - audit_logs í…Œì´ë¸” ìƒì„±
  - Index: (tenant_id, occurred_at DESC)
  - Index: (user_id, occurred_at DESC)
  - Index: (event_type, occurred_at DESC)

#### 3.3 Repository
- [ ] **AuditLogJpaRepository**:
  - save(AuditLogEntity) â†’ AuditLogEntity
  - findAllByTenantIdAndUserIdAndEventTypeAndResourceTypeAndStatusAndOccurredAtBetween(Long, Long, String, String, String, LocalDateTime, LocalDateTime, Pageable) â†’ Page<AuditLogEntity>

#### 3.4 Adapter
- [ ] **AuditLogPersistenceAdapter** (SaveAuditLogPort, LoadAuditLogsPort êµ¬í˜„)

#### 3.5 Mapper
- [ ] **AuditLogMapper**:
  - toEntity(AuditLog) â†’ AuditLogEntity
  - toDomain(AuditLogEntity) â†’ AuditLog

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **GET /api/v1/audit-logs**
  - HTTP Method: GET
  - Query Params: tenantId, userId, eventType, resourceType, status, startDate, endDate, page, size
  - Response: HTTP 200 OK
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN)

#### 4.2 Response DTO
- [ ] **AuditLogResponse**:
  - auditLogId (Long)
  - tenantId (Long)
  - userId (Long, nullable)
  - eventType (String)
  - resourceType (String)
  - resourceId (String)
  - action (String)
  - ipAddress (String)
  - userAgent (String)
  - status (String)
  - details (Map<String, Object>)
  - occurredAt (LocalDateTime)

#### 4.3 Controller
- [ ] **AuditLogController**:
  - getAuditLogs(@RequestParam tenantId, userId, eventType, resourceType, status, startDate, endDate, Pageable) â†’ ResponseEntity<PageApiResponse<AuditLogResponse>>

#### 4.4 Error Handling
- [ ] **UnauthorizedException** (SUPER_ADMIN ì•„ë‹˜) â†’ HTTP 403, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

### 5. Event Listener

#### 5.1 AuditLogEventListener
- [ ] **@EventListener** êµ¬í˜„
  - UserLoggedIn â†’ AUTHENTICATION / USER / LOGIN / SUCCESS
  - UserLoggedOut â†’ AUTHENTICATION / USER / LOGOUT / SUCCESS
  - RoleAssignedToUser â†’ AUTHORIZATION / ROLE / CREATE / SUCCESS
  - TenantCreated â†’ RESOURCE_MANAGEMENT / TENANT / CREATE / SUCCESS
  - InvalidPasswordException â†’ AUTHENTICATION / USER / LOGIN / FAILURE
  - InsufficientPermissionException â†’ AUTHORIZATION / PERMISSION / READ / FAILURE

#### 5.2 ë¹„ë™ê¸° ì²˜ë¦¬
- [ ] **@Async** ì ìš©
  - AuditLog ì €ì¥ì€ ë¹„ë™ê¸° ì²˜ë¦¬
  - ì‹¤íŒ¨ ì‹œ ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ì›ë˜ íŠ¸ëœì­ì…˜ì— ì˜í–¥ ì—†ìŒ

### 6. Integration Test

#### 6.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ ë¡œê·¸ì¸ â†’ Audit Log ê¸°ë¡**:
  - Given: ì‚¬ìš©ì ë¡œê·¸ì¸
  - When: POST /api/v1/auth/login/phone
  - Then:
    - HTTP 200 ì„±ê³µ
    - DB í™•ì¸: audit_logs í…Œì´ë¸”ì— AUTHENTICATION / LOGIN / SUCCESS ê¸°ë¡

- [ ] **ì‹¤íŒ¨í•œ ë¡œê·¸ì¸ â†’ Audit Log ê¸°ë¡**:
  - Given: ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸
  - When: POST /api/v1/auth/login/phone
  - Then:
    - HTTP 401 ì‹¤íŒ¨
    - DB í™•ì¸: audit_logs í…Œì´ë¸”ì— AUTHENTICATION / LOGIN / FAILURE ê¸°ë¡

- [ ] **Role í• ë‹¹ â†’ Audit Log ê¸°ë¡**:
  - Given: SUPER_ADMINì´ Userì—ê²Œ Role í• ë‹¹
  - When: POST /api/v1/users/{userId}/roles
  - Then:
    - HTTP 201 ì„±ê³µ
    - DB í™•ì¸: audit_logs í…Œì´ë¸”ì— AUTHORIZATION / ROLE / CREATE / SUCCESS ê¸°ë¡

- [ ] **Audit Log ì¡°íšŒ (í•„í„°ë§)**:
  - Given: 3ê°œ Audit Log (LOGIN SUCCESS, LOGIN FAILURE, ROLE CREATE)
  - When: GET /api/v1/audit-logs?eventType=AUTHENTICATION&status=FAILURE
  - Then: HTTP 200, 1ê°œ Audit Log ë°˜í™˜

- [ ] **Audit Log ì¡°íšŒ (ë‚ ì§œ ë²”ìœ„)**:
  - Given: 5ê°œ Audit Log (2024-01-01 ~ 2024-01-05)
  - When: GET /api/v1/audit-logs?startDate=2024-01-02&endDate=2024-01-04
  - Then: HTTP 200, 3ê°œ Audit Log ë°˜í™˜ (2024-01-02 ~ 2024-01-04)

#### 6.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V16 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **SUPER_ADMIN ì‚¬ìš©ì**: INTERNAL ì‚¬ìš©ì + SUPER_ADMIN ê¶Œí•œ

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Long FK ì „ëµ** - AuditLogEntityì— `private Long tenantId`, `private Long userId`
- [ ] **ë¹„ë™ê¸° ì²˜ë¦¬** - AuditLog ì €ì¥ ì‹¤íŒ¨ëŠ” ì›ë˜ íŠ¸ëœì­ì…˜ì— ì˜í–¥ ì—†ìŒ

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (ê¸°ë³¸ êµ¬ì¡°)
  - AUT-001, AUT-002 (ë¡œê·¸ì¸ ì´ë²¤íŠ¸)
  - AUT-011, AUT-013 (ê¶Œí•œ ì´ë²¤íŠ¸)

### ë³´ì•ˆ ê·œì¹™
- [ ] **SUPER_ADMIN ì „ìš©** - Audit Log ì¡°íšŒëŠ” SUPER_ADMINë§Œ ê°€ëŠ¥
- [ ] **ë¯¼ê° ì •ë³´ ì œì™¸** - detailsì— ë¹„ë°€ë²ˆí˜¸, í† í° ë“± ì €ì¥ ê¸ˆì§€

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: AuditLog VO
- [ ] **Event í…ŒìŠ¤íŠ¸**: EventListener ë™ì‘ í™•ì¸
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (AuditLog Aggregate, EventType Enum)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (RecordAuditLogUseCase, GetAuditLogsQuery)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (AuditLogEntity, Repository)
- [ ] Event Listener êµ¬í˜„ ì™„ë£Œ (ë¹„ë™ê¸° ì²˜ë¦¬)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (AuditLogController)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 5ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **Event-Driven ì•„í‚¤í…ì²˜ ê²€ì¦ ì™„ë£Œ**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (4.2 Audit Log)
- **Plan**: docs/prd/plans/AUT-013-audit-log-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-68

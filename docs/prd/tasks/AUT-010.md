# AUT-010: Tenant ê´€ë¦¬

**Epic**: IAM Platform (AuthHub)
**Feature**: Tenant ê´€ë¦¬
**Phase**: Phase 2 - Organization & Authorization
**ë¸Œëœì¹˜**: feature/AUT-010-tenant-management
**ì˜ì¡´ì„±**: AUT-000 (Tenant Aggregate ê¸°ë³¸ êµ¬ì¡°)

---

## ğŸ“ ëª©ì 

ë©€í‹° í…Œë„ŒíŠ¸ ê´€ë¦¬ ê¸°ëŠ¥ êµ¬í˜„
- Tenant ìƒì„± (SUPER_ADMIN ì „ìš©)
- Tenant ì¡°íšŒ (ëª©ë¡, ìƒì„¸)
- Tenant ì—…ë°ì´íŠ¸ (ì´ë¦„, ìƒíƒœ)
- Tenant ì‚­ì œ (Soft Delete)

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 Tenant Aggregate í™•ì¥
- [ ] **Tenant Aggregateì— ì¶”ê°€**:
  - `updateName(TenantName)` â†’ void
  - `activate()` â†’ void (status = ACTIVE)
  - `deactivate()` â†’ void (status = INACTIVE)
  - `delete()` â†’ void (status = DELETED, Soft Delete)
  - `canActivate()` â†’ boolean (ê²€ì¦ ë¡œì§)

#### 1.2 TenantName VO í™•ì¥
- [ ] **TenantName VO**:
  - ê²€ì¦ ê·œì¹™: 2-100ì, íŠ¹ìˆ˜ë¬¸ì ì œí•œ

#### 1.3 Domain Exception
- [ ] **DuplicateTenantNameException** (Tenant ì´ë¦„ ì¤‘ë³µ)
- [ ] **TenantNotFoundException** (Tenant ì—†ìŒ)
- [ ] **TenantAlreadyDeletedException** (ì´ë¯¸ ì‚­ì œëœ Tenant)

#### 1.4 Domain Event
- [ ] **TenantCreated** Event
  - tenantId, name, createdAt

- [ ] **TenantUpdated** Event
  - tenantId, oldName, newName, updatedAt

- [ ] **TenantDeleted** Event
  - tenantId, deletedAt

### 2. Application Layer

#### 2.1 CreateTenantUseCase (Command)
- [ ] **Input**: CreateTenantCommand
  - name (String)
  - requestedBy (Long, SUPER_ADMIN userId)

- [ ] **Output**: TenantResponse
  - tenantId, name, status, createdAt

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. SUPER_ADMIN ê¶Œí•œ ê²€ì¦ (LoadUserPort)
  2. Tenant ì´ë¦„ ì¤‘ë³µ í™•ì¸ (CheckDuplicateTenantNamePort)
  3. Tenant Aggregate ìƒì„±
  4. Tenant ì €ì¥ (SaveTenantPort)
  5. TenantCreated Event ë°œí–‰

#### 2.2 UpdateTenantUseCase (Command)
- [ ] **Input**: UpdateTenantCommand
  - tenantId (Long)
  - name (String, optional)
  - requestedBy (Long, SUPER_ADMIN userId)

- [ ] **Output**: TenantResponse

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. SUPER_ADMIN ê¶Œí•œ ê²€ì¦
  2. Tenant ì¡°íšŒ (LoadTenantPort)
  3. ì´ë¦„ ë³€ê²½ ì‹œ ì¤‘ë³µ í™•ì¸
  4. Tenant.updateName(name)
  5. Tenant ì €ì¥ (SaveTenantPort)
  6. TenantUpdated Event ë°œí–‰

#### 2.3 DeleteTenantUseCase (Command)
- [ ] **Input**: DeleteTenantCommand
  - tenantId (Long)
  - requestedBy (Long, SUPER_ADMIN userId)

- [ ] **Output**: void

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. SUPER_ADMIN ê¶Œí•œ ê²€ì¦
  2. Tenant ì¡°íšŒ (LoadTenantPort)
  3. Tenant.delete() (Soft Delete)
  4. Tenant ì €ì¥ (SaveTenantPort)
  5. TenantDeleted Event ë°œí–‰

#### 2.4 GetTenantQuery (Query)
- [ ] **Input**: GetTenantQueryRequest
  - tenantId (Long)

- [ ] **Output**: TenantResponse

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. Tenant ì¡°íšŒ (LoadTenantPort)

#### 2.5 ListTenantsQuery (Query)
- [ ] **Input**: ListTenantsQueryRequest
  - status (TenantStatus, optional filter)
  - page, size (Pagination)

- [ ] **Output**: PageResponse<TenantResponse>

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. Tenant ëª©ë¡ ì¡°íšŒ (LoadTenantsPort)

#### 2.6 Port ì •ì˜
- [ ] **SaveTenantPort** (Out):
  - save(Tenant) â†’ Tenant

- [ ] **LoadTenantPort** (Out):
  - load(Long tenantId) â†’ Optional<Tenant>

- [ ] **LoadTenantsPort** (Out):
  - loadAll(TenantStatus, Pageable) â†’ Page<Tenant>

- [ ] **CheckDuplicateTenantNamePort** (Out):
  - exists(String name) â†’ boolean

### 3. Persistence Layer

#### 3.1 TenantEntity í™•ì¥
- [ ] **TenantEntity**:
  - ì´ë¯¸ AUT-000ì—ì„œ ê¸°ë³¸ êµ¬ì¡° ì¡´ì¬
  - ì¶”ê°€ ë³€ê²½ ì—†ìŒ

#### 3.2 Flyway ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] **V7__add_tenant_name_unique.sql**:
  - tenants í…Œì´ë¸”ì— name Unique Constraint ì¶”ê°€
  - Index: (status, created_at)

#### 3.3 Repository
- [ ] **TenantJpaRepository**:
  - save(TenantEntity) â†’ TenantEntity
  - findById(Long) â†’ Optional<TenantEntity>
  - findByName(String) â†’ Optional<TenantEntity>
  - findAllByStatus(String status, Pageable) â†’ Page<TenantEntity>
  - existsByName(String) â†’ boolean

#### 3.4 Adapter
- [ ] **TenantCommandAdapter** (SaveTenantPort êµ¬í˜„)

- [ ] **TenantQueryAdapter** (LoadTenantPort, LoadTenantsPort, CheckDuplicateTenantNamePort êµ¬í˜„)

#### 3.5 Mapper
- [ ] **TenantMapper**:
  - toEntity(Tenant) â†’ TenantEntity
  - toDomain(TenantEntity) â†’ Tenant

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/tenants**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 201 Created
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN)

- [ ] **GET /api/v1/tenants/{tenantId}**
  - HTTP Method: GET
  - Response: HTTP 200 OK

- [ ] **GET /api/v1/tenants**
  - HTTP Method: GET
  - Query Params: status, page, size
  - Response: HTTP 200 OK

- [ ] **PUT /api/v1/tenants/{tenantId}**
  - HTTP Method: PUT
  - Content-Type: application/json
  - Response: HTTP 200 OK
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN)

- [ ] **DELETE /api/v1/tenants/{tenantId}**
  - HTTP Method: DELETE
  - Response: HTTP 204 No Content
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN)

#### 4.2 Request DTO
- [ ] **CreateTenantRequest**:
  - name (String, @NotBlank, @Size(min=2, max=100))

- [ ] **UpdateTenantRequest**:
  - name (String, @Size(min=2, max=100))

#### 4.3 Response DTO
- [ ] **TenantResponse**:
  - tenantId (Long)
  - name (String)
  - status (String)
  - createdAt (LocalDateTime)
  - updatedAt (LocalDateTime)

#### 4.4 Controller
- [ ] **TenantController**:
  - createTenant(@Valid CreateTenantRequest, @AuthenticationPrincipal userId) â†’ ResponseEntity<TenantResponse>
  - getTenant(@PathVariable Long tenantId) â†’ ResponseEntity<TenantResponse>
  - listTenants(@RequestParam status, Pageable) â†’ ResponseEntity<PageApiResponse<TenantResponse>>
  - updateTenant(@PathVariable Long tenantId, @Valid UpdateTenantRequest, @AuthenticationPrincipal userId) â†’ ResponseEntity<TenantResponse>
  - deleteTenant(@PathVariable Long tenantId, @AuthenticationPrincipal userId) â†’ ResponseEntity<Void>

#### 4.5 Error Handling
- [ ] **DuplicateTenantNameException** â†’ HTTP 409, "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” Tenant ì´ë¦„ì…ë‹ˆë‹¤"
- [ ] **TenantNotFoundException** â†’ HTTP 404, "Tenantë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
- [ ] **TenantAlreadyDeletedException** â†’ HTTP 400, "ì´ë¯¸ ì‚­ì œëœ Tenantì…ë‹ˆë‹¤"
- [ ] **UnauthorizedException** (SUPER_ADMIN ì•„ë‹˜) â†’ HTTP 403, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ Tenant ìƒì„±**:
  - Given: SUPER_ADMIN ë¡œê·¸ì¸
  - When: POST /api/v1/tenants (name: "New Tenant")
  - Then: HTTP 201, TenantResponse ë°˜í™˜
  - DB í™•ì¸: tenants í…Œì´ë¸”ì— ë°ì´í„° ì‚½ì…
  - Event í™•ì¸: TenantCreated ë°œí–‰

- [ ] **Tenant ì´ë¦„ ì¤‘ë³µ**:
  - Given: ì´ë¯¸ ì¡´ì¬í•˜ëŠ” Tenant ì´ë¦„
  - When: POST /api/v1/tenants (ê°™ì€ ì´ë¦„)
  - Then: HTTP 409, "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” Tenant ì´ë¦„ì…ë‹ˆë‹¤"

- [ ] **ì •ìƒ Tenant ì—…ë°ì´íŠ¸**:
  - Given: ê¸°ì¡´ Tenant
  - When: PUT /api/v1/tenants/{tenantId} (name: "Updated Name")
  - Then: HTTP 200, ì—…ë°ì´íŠ¸ëœ TenantResponse
  - DB í™•ì¸: tenants í…Œì´ë¸” name ë³€ê²½
  - Event í™•ì¸: TenantUpdated ë°œí–‰

- [ ] **ì •ìƒ Tenant ì‚­ì œ (Soft Delete)**:
  - Given: ê¸°ì¡´ Tenant
  - When: DELETE /api/v1/tenants/{tenantId}
  - Then: HTTP 204
  - DB í™•ì¸: status = DELETED
  - Event í™•ì¸: TenantDeleted ë°œí–‰

- [ ] **Tenant ëª©ë¡ ì¡°íšŒ (í•„í„°ë§)**:
  - Given: 3ê°œ Tenant (ACTIVE: 2, DELETED: 1)
  - When: GET /api/v1/tenants?status=ACTIVE
  - Then: HTTP 200, 2ê°œ Tenant ë°˜í™˜

- [ ] **SUPER_ADMIN ê¶Œí•œ ê²€ì¦**:
  - Given: SUPER_ADMIN ì•„ë‹Œ ì‚¬ìš©ì
  - When: POST /api/v1/tenants
  - Then: HTTP 403, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V7 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **SUPER_ADMIN ì‚¬ìš©ì**: INTERNAL ì‚¬ìš©ì + SUPER_ADMIN ê¶Œí•œ

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Tell Don't Ask** - Tenant.updateName, activate, delete ë©”ì„œë“œ ì‚¬ìš©
- [ ] **Long FK ì „ëµ** - TenantEntityì— `private Long id`

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (Tenant Aggregate ê¸°ë³¸ êµ¬ì¡°)

### ë³´ì•ˆ ê·œì¹™
- [ ] **SUPER_ADMIN ì „ìš©** - Tenant ìƒì„±/ìˆ˜ì •/ì‚­ì œëŠ” SUPER_ADMINë§Œ ê°€ëŠ¥

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: Tenant.updateName, activate, delete
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (Tenant í™•ì¥)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (CreateTenantUseCase, UpdateTenantUseCase, DeleteTenantUseCase, Query)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (Repository, Adapter)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (TenantController)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 6ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **SUPER_ADMIN ê¶Œí•œ ê²€ì¦ ì™„ë£Œ**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (3.1 Tenant Management)
- **Plan**: docs/prd/plans/AUT-007-tenant-management-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-63

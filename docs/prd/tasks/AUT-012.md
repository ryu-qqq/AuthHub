# AUT-012: Permission ê´€ë¦¬

**Epic**: IAM Platform (AuthHub)
**Feature**: Permission ê´€ë¦¬
**Phase**: Phase 2 - Organization & Authorization
**ë¸Œëœì¹˜**: feature/AUT-012-permission-management
**ì˜ì¡´ì„±**: AUT-000, AUT-009 (Role ì‹œìŠ¤í…œ)

---

## ğŸ“ ëª©ì 

Permission ê´€ë¦¬ ê¸°ëŠ¥ êµ¬í˜„
- Permission ìƒì„± (SUPER_ADMIN ì „ìš©)
- Permission ì¡°íšŒ (ëª©ë¡, ìƒì„¸)
- Permission ì‚­ì œ (Soft Delete)
- Resource-Action ê¸°ë°˜ ê¶Œí•œ ì²´ê³„

---

## ğŸ¯ ìš”êµ¬ì‚¬í•­

### 1. Domain Layer

#### 1.1 Permission Aggregate
- [ ] **Permission Aggregate Root** ìƒì„±
  - permissionId (PermissionId VO, Long)
  - tenantId (Long FK)
  - resource (ResourceType Enum)
  - action (ActionType Enum)
  - description (String)
  - status (PermissionStatus Enum: ACTIVE, INACTIVE, DELETED)
  - createdAt, updatedAt (LocalDateTime)

#### 1.2 ResourceType Enum
- [ ] **ResourceType Enum**:
  - TENANT (Tenant ê´€ë¦¬)
  - ORGANIZATION (Organization ê´€ë¦¬)
  - USER (ì‚¬ìš©ì ê´€ë¦¬)
  - ROLE (Role ê´€ë¦¬)
  - PERMISSION (Permission ê´€ë¦¬)

#### 1.3 ActionType Enum
- [ ] **ActionType Enum**:
  - CREATE (ìƒì„±)
  - READ (ì¡°íšŒ)
  - UPDATE (ìˆ˜ì •)
  - DELETE (ì‚­ì œ)
  - MANAGE (ì „ì²´ ê´€ë¦¬, CREATE + UPDATE + DELETE í¬í•¨)

#### 1.4 PermissionId VO
- [ ] **PermissionId VO** (Long ê¸°ë°˜)

#### 1.5 Domain Exception
- [ ] **DuplicatePermissionException** (Permission ì¤‘ë³µ)
- [ ] **PermissionNotFoundException** (Permission ì—†ìŒ)
- [ ] **PermissionInUseException** (ì‚¬ìš© ì¤‘ì¸ Permission ì‚­ì œ ì‹œë„)

#### 1.6 Domain Event
- [ ] **PermissionCreated** Event
  - permissionId, tenantId, resource, action, createdBy, createdAt

- [ ] **PermissionDeleted** Event
  - permissionId, deletedBy, deletedAt

### 2. Application Layer

#### 2.1 CreatePermissionUseCase (Command)
- [ ] **Input**: CreatePermissionCommand
  - tenantId (Long)
  - resource (ResourceType)
  - action (ActionType)
  - description (String)
  - requestedBy (Long, SUPER_ADMIN userId)

- [ ] **Output**: PermissionResponse
  - permissionId, tenantId, resource, action, description, status, createdAt

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. SUPER_ADMIN ê¶Œí•œ ê²€ì¦ (LoadUserPort)
  2. Permission ì¤‘ë³µ í™•ì¸ (CheckDuplicatePermissionPort)
     - ë™ì¼ Tenant + Resource + Action ì¡°í•© ì¤‘ë³µ ê¸ˆì§€
  3. Permission Aggregate ìƒì„±
  4. Permission ì €ì¥ (SavePermissionPort)
  5. PermissionCreated Event ë°œí–‰

#### 2.2 DeletePermissionUseCase (Command)
- [ ] **Input**: DeletePermissionCommand
  - permissionId (Long)
  - requestedBy (Long, SUPER_ADMIN userId)

- [ ] **Output**: void

- [ ] **Transaction**: í•„ìˆ˜

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. SUPER_ADMIN ê¶Œí•œ ê²€ì¦
  2. Permission ì¡°íšŒ (LoadPermissionPort)
  3. Permissionì´ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸ (CheckPermissionInUsePort)
  4. Permission ìƒíƒœ â†’ DELETED (Soft Delete)
  5. Permission ì €ì¥ (SavePermissionPort)
  6. PermissionDeleted Event ë°œí–‰

#### 2.3 GetPermissionQuery (Query)
- [ ] **Input**: GetPermissionQueryRequest
  - permissionId (Long)

- [ ] **Output**: PermissionResponse

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. Permission ì¡°íšŒ (LoadPermissionPort)

#### 2.4 ListPermissionsQuery (Query)
- [ ] **Input**: ListPermissionsQueryRequest
  - tenantId (Long, optional filter)
  - resource (ResourceType, optional filter)
  - action (ActionType, optional filter)
  - status (PermissionStatus, optional filter)

- [ ] **Output**: List<PermissionResponse>

- [ ] **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
  1. Permission ëª©ë¡ ì¡°íšŒ (LoadPermissionsPort)

#### 2.5 Port ì •ì˜
- [ ] **SavePermissionPort** (Out):
  - save(Permission) â†’ Permission

- [ ] **LoadPermissionPort** (Out):
  - load(Long permissionId) â†’ Optional<Permission>

- [ ] **LoadPermissionsPort** (Out):
  - loadAll(Long tenantId, ResourceType, ActionType, PermissionStatus) â†’ List<Permission>

- [ ] **CheckDuplicatePermissionPort** (Out):
  - exists(Long tenantId, ResourceType, ActionType) â†’ boolean

- [ ] **CheckPermissionInUsePort** (Out):
  - isInUse(Long permissionId) â†’ boolean (Roleì´ í•´ë‹¹ Permissionì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸)

### 3. Persistence Layer

#### 3.1 PermissionEntity
- [ ] **PermissionEntity** ìƒì„±
  - id (Long, PK)
  - tenant_id (Long, FK)
  - resource (String, TENANT/ORGANIZATION/USER/ROLE/PERMISSION)
  - action (String, CREATE/READ/UPDATE/DELETE/MANAGE)
  - description (String)
  - status (String, ACTIVE/INACTIVE/DELETED)
  - created_at, updated_at (LocalDateTime)

#### 3.2 Flyway ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] **V11__create_permissions.sql**:
  - permissions í…Œì´ë¸” ìƒì„±
  - Unique Constraint: (tenant_id, resource, action)
  - Index: (tenant_id, status)

- [ ] **V12__insert_default_permissions.sql**:
  - ì‹œìŠ¤í…œ ê¸°ë³¸ Permission ì‚½ì…:
    - TENANT:MANAGE (Tenant ì „ì²´ ê´€ë¦¬)
    - ORGANIZATION:MANAGE (Organization ì „ì²´ ê´€ë¦¬)
    - USER:READ, USER:MANAGE
    - ROLE:READ, ROLE:MANAGE
    - PERMISSION:READ, PERMISSION:MANAGE

#### 3.3 Repository
- [ ] **PermissionJpaRepository**:
  - save(PermissionEntity) â†’ PermissionEntity
  - findById(Long) â†’ Optional<PermissionEntity>
  - findByTenantIdAndResourceAndAction(Long, String, String) â†’ Optional<PermissionEntity>
  - findAllByTenantIdAndResourceAndActionAndStatus(Long, String, String, String) â†’ List<PermissionEntity>
  - existsByTenantIdAndResourceAndAction(Long, String, String) â†’ boolean

#### 3.4 Adapter
- [ ] **PermissionCommandAdapter** (SavePermissionPort êµ¬í˜„)

- [ ] **PermissionQueryAdapter** (LoadPermissionPort, LoadPermissionsPort, CheckDuplicatePermissionPort, CheckPermissionInUsePort êµ¬í˜„)

#### 3.5 Mapper
- [ ] **PermissionMapper**:
  - toEntity(Permission) â†’ PermissionEntity
  - toDomain(PermissionEntity) â†’ Permission

### 4. REST API Layer

#### 4.1 Endpoint
- [ ] **POST /api/v1/permissions**
  - HTTP Method: POST
  - Content-Type: application/json
  - Response: HTTP 201 Created
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN)

- [ ] **GET /api/v1/permissions/{permissionId}**
  - HTTP Method: GET
  - Response: HTTP 200 OK

- [ ] **GET /api/v1/permissions**
  - HTTP Method: GET
  - Query Params: tenantId, resource, action, status
  - Response: HTTP 200 OK

- [ ] **DELETE /api/v1/permissions/{permissionId}**
  - HTTP Method: DELETE
  - Response: HTTP 204 No Content
  - ì¸ì¦ í•„ìˆ˜ (SUPER_ADMIN)

#### 4.2 Request DTO
- [ ] **CreatePermissionRequest**:
  - resource (String, @NotBlank, TENANT/ORGANIZATION/USER/ROLE/PERMISSION)
  - action (String, @NotBlank, CREATE/READ/UPDATE/DELETE/MANAGE)
  - description (String)

#### 4.3 Response DTO
- [ ] **PermissionResponse**:
  - permissionId (Long)
  - tenantId (Long)
  - resource (String)
  - action (String)
  - description (String)
  - status (String)
  - createdAt (LocalDateTime)

#### 4.4 Controller
- [ ] **PermissionController**:
  - createPermission(@Valid CreatePermissionRequest, @AuthenticationPrincipal userId) â†’ ResponseEntity<PermissionResponse>
  - getPermission(@PathVariable Long permissionId) â†’ ResponseEntity<PermissionResponse>
  - listPermissions(@RequestParam tenantId, resource, action, status) â†’ ResponseEntity<List<PermissionResponse>>
  - deletePermission(@PathVariable Long permissionId, @AuthenticationPrincipal userId) â†’ ResponseEntity<Void>

#### 4.5 Error Handling
- [ ] **DuplicatePermissionException** â†’ HTTP 409, "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” Permissionì…ë‹ˆë‹¤"
- [ ] **PermissionNotFoundException** â†’ HTTP 404, "Permissionì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
- [ ] **PermissionInUseException** â†’ HTTP 400, "ì‚¬ìš© ì¤‘ì¸ Permissionì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
- [ ] **UnauthorizedException** (SUPER_ADMIN ì•„ë‹˜) â†’ HTTP 403, "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

### 5. Integration Test

#### 5.1 E2E ì‹œë‚˜ë¦¬ì˜¤
- [ ] **ì •ìƒ Permission ìƒì„±**:
  - Given: SUPER_ADMIN ë¡œê·¸ì¸
  - When: POST /api/v1/permissions (resource: USER, action: CREATE)
  - Then: HTTP 201, PermissionResponse ë°˜í™˜
  - DB í™•ì¸: permissions í…Œì´ë¸”ì— ë°ì´í„° ì‚½ì…
  - Event í™•ì¸: PermissionCreated ë°œí–‰

- [ ] **Permission ì¤‘ë³µ ì‹œë„**:
  - Given: ì´ë¯¸ ì¡´ì¬í•˜ëŠ” Permission (TENANT:MANAGE)
  - When: POST /api/v1/permissions (ê°™ì€ Resource + Action)
  - Then: HTTP 409, "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” Permissionì…ë‹ˆë‹¤"

- [ ] **ì •ìƒ Permission ì‚­ì œ (Soft Delete)**:
  - Given: ì‚¬ìš© ì¤‘ì´ì§€ ì•Šì€ Permission
  - When: DELETE /api/v1/permissions/{permissionId}
  - Then: HTTP 204
  - DB í™•ì¸: status = DELETED
  - Event í™•ì¸: PermissionDeleted ë°œí–‰

- [ ] **ì‚¬ìš© ì¤‘ì¸ Permission ì‚­ì œ ì‹œë„**:
  - Given: Roleì— í• ë‹¹ëœ Permission
  - When: DELETE /api/v1/permissions/{permissionId}
  - Then: HTTP 400, "ì‚¬ìš© ì¤‘ì¸ Permissionì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

- [ ] **Permission ëª©ë¡ ì¡°íšŒ (í•„í„°ë§)**:
  - Given: 3ê°œ Permission (USER:READ, USER:CREATE, TENANT:MANAGE)
  - When: GET /api/v1/permissions?resource=USER
  - Then: HTTP 200, 2ê°œ Permission ë°˜í™˜

#### 5.2 í…ŒìŠ¤íŠ¸ ë°ì´í„°
- [ ] **@Sql**: V1~V12 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] **SUPER_ADMIN ì‚¬ìš©ì**: INTERNAL ì‚¬ìš©ì + SUPER_ADMIN ê¶Œí•œ

---

## âš ï¸ ì œì•½ì‚¬í•­

### Zero-Tolerance ê·œì¹™
- [ ] **Long FK ì „ëµ** - PermissionEntityì— `private Long tenantId`

### ì˜ì¡´ì„±
- **í•„ìˆ˜**:
  - AUT-000 (User Aggregate)
  - AUT-009 (Role ì‹œìŠ¤í…œ)

### ë³´ì•ˆ ê·œì¹™
- [ ] **SUPER_ADMIN ì „ìš©** - Permission ìƒì„±/ì‚­ì œëŠ” SUPER_ADMINë§Œ ê°€ëŠ¥
- [ ] **Resource-Action ì¡°í•© Unique** - ë™ì¼ Tenant ë‚´ì—ì„œ ì¤‘ë³µ ë¶ˆê°€

### í…ŒìŠ¤íŠ¸ ê·œì¹™
- [ ] **ArchUnit í…ŒìŠ¤íŠ¸** í•„ìˆ˜
- [ ] **Domain í…ŒìŠ¤íŠ¸**: Permission VO, ResourceType, ActionType
- [ ] **UseCase í…ŒìŠ¤íŠ¸**: Mock ê¸°ë°˜
- [ ] **Integration í…ŒìŠ¤íŠ¸**: TestRestTemplate
- [ ] **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** > 80%

---

## âœ… ì™„ë£Œ ì¡°ê±´

- [ ] Domain Layer êµ¬í˜„ ì™„ë£Œ (Permission Aggregate, ResourceType, ActionType Enum)
- [ ] Application Layer êµ¬í˜„ ì™„ë£Œ (CreatePermissionUseCase, DeletePermissionUseCase, Query)
- [ ] Persistence Layer êµ¬í˜„ ì™„ë£Œ (PermissionEntity, Repository, ê¸°ë³¸ ë°ì´í„° ì‚½ì…)
- [ ] REST API Layer êµ¬í˜„ ì™„ë£Œ (PermissionController)
- [ ] Integration Test í†µê³¼ (E2E ì‹œë‚˜ë¦¬ì˜¤ 5ê°œ)
- [ ] ArchUnit í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] **Resource-Action ì¡°í•© Unique ê²€ì¦ ì™„ë£Œ**
- [ ] ì½”ë“œ ë¦¬ë·° ìŠ¹ì¸
- [ ] PR ë¨¸ì§€ ì™„ë£Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **PRD**: docs/prd/iam-platform.md (3.4 Permission Management)
- **Plan**: docs/prd/plans/AUT-010-permission-management-plan.md (create-plan í›„ ìƒì„±)
- **Jira**: https://ryuqqq.atlassian.net/browse/AUT-65

version: '3.8'
name: authhub-aws

# ===============================================
# AWS 리소스 연결용 로컬 개발 환경
# ===============================================
# 사용법:
# 1. AWS SSM Session Manager로 포트 포워딩 설정
# 2. docker-compose -f docker-compose.aws.yml up -d
# ===============================================

services:
  # ===============================================
  # Application Services (AWS 리소스 연결)
  # ===============================================

  web-api:
    build:
      context: ..
      dockerfile: Dockerfile.local
      args:
        MODULE_NAME: auth-web-api
    container_name: authhub
    env_file:
      - .env.aws
    environment:
      # Static values (override .env.aws)
      SPRING_PROFILES_ACTIVE: prod
      SERVER_PORT: 8080

      # Database (AWS RDS via SSM Port Forwarding)
      # SSM으로 localhost:13307 -> RDS:3306 포워딩 필요
      DB_HOST: host.docker.internal
      DB_PORT: 13307
      # DB_NAME, DB_USER, DB_PASSWORD → .env.aws에서 로드

      # Redis (AWS ElastiCache via SSM Port Forwarding)
      # SSM으로 localhost:16380 -> ElastiCache:6379 포워딩 필요
      REDIS_HOST: host.docker.internal
      REDIS_PORT: 16380
      REDISSON_ENABLED: "true"
      # REDIS_PASSWORD → .env.aws에서 로드

      # AWS Credentials → .env.aws에서 로드
      # AWS_REGION, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_SESSION_TOKEN

      # S3 → .env.aws에서 로드
      # AWS_S3_BUCKET (S3_BUCKET)

      # SQS (실제 AWS SQS 사용)
      SPRING_CLOUD_AWS_SQS_ENABLED: "true"
      # SQS URLs → .env.aws에서 로드

      # Service Token (Internal API 인증용 - Gateway → AuthHub)
      SERVICE_TOKEN_SECRET: "local-dev-service-token-secret"

      # Swagger UI 활성화 (로컬 개발용)
      SWAGGER_ENABLED: "true"

    ports:
      - "9090:8080"
    volumes:
      - ./secrets:/app/secrets:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

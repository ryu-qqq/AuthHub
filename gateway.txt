 ğŸ” AuthHub í† í° ë° í—¤ë” ì „ë‹¬ ë°©ì‹ ë¶„ì„ ê²°ê³¼

  1. í† í° ì „ë‹¬ í˜•íƒœ

  Access Token (Authorization í—¤ë”)

  Authorization: Bearer <JWT_ACCESS_TOKEN>
  - ìœ„ì¹˜: HTTP Request Header
  - í˜•ì‹: Bearer  prefix + JWT í† í°
  - ì²˜ë¦¬: JwtAuthenticationFilter (Order: +3)

  Refresh Token (Cookie)

  Cookie: refresh_token=<REFRESH_TOKEN_VALUE>
  - ìœ„ì¹˜: HTTP Cookie
  - ì†ì„±: HttpOnly, Secure, SameSite=Strict
  - MaxAge: 7ì¼
  - ì²˜ë¦¬: TokenRefreshFilter (Order: +2)

  ---
  2. Gateway Filter ì‹¤í–‰ ìˆœì„œ ë° í—¤ë” ì¶”ê°€

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Filter Chain ì‹¤í–‰ ìˆœì„œ (HIGHEST_PRECEDENCE ê¸°ì¤€)                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  +0  TraceIdFilter
      â””â”€ ì¶”ê°€: X-Trace-Id (Request/Response)

  +1  RateLimitFilter
      â””â”€ IP/Endpoint Rate Limiting

  +2  TokenRefreshFilter
      â””â”€ Access Token ë§Œë£Œ ì‹œ ê°±ì‹ 
      â””â”€ ê°±ì‹  ì‹œ ì¶”ê°€:
         - Authorization: Bearer <new_access_token>
         - X-User-Id: <user_id>
         - Cookie: refresh_token=<new_refresh_token>

  +3  JwtAuthenticationFilter
      â””â”€ JWT ê²€ì¦ í›„ ì¶”ê°€: X-User-Id

  +4  UserRateLimitFilter
      â””â”€ User Rate Limiting

  +5  TenantIsolationFilter
      â””â”€ ì¶”ê°€: X-Tenant-Id, X-Roles

  +6  PermissionFilter
      â””â”€ ê¶Œí•œ ê²€ì¦

  +7  MfaVerificationFilter
      â””â”€ MFA ê²€ì¦

  ---
  3. Downstream ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬ë˜ëŠ” í—¤ë”

  | í—¤ë”            | ê°’                | ì„¤ì • ìœ„ì¹˜                                        | ì„¤ëª…                           |
  |---------------|------------------|----------------------------------------------|------------------------------|
  | Authorization | Bearer <jwt>     | í´ë¼ì´ì–¸íŠ¸ (ì›ë³¸ ë˜ëŠ” ê°±ì‹ ë¨)                            | JWT Access Token             |
  | X-Trace-Id    | UUID í˜•ì‹          | TraceIdFilter                                | ë¶„ì‚° ì¶”ì  ID                     |
  | X-User-Id     | ì‚¬ìš©ì ID (subject) | JwtAuthenticationFilter / TokenRefreshFilter | JWTì—ì„œ ì¶”ì¶œëœ userId             |
  | X-Tenant-Id   | í…Œë„ŒíŠ¸ ID           | TenantIsolationFilter                        | JWTì—ì„œ ì¶”ì¶œëœ tenantId           |
  | X-Roles       | JSON ë°°ì—´          | TenantIsolationFilter                        | ì‚¬ìš©ì ì—­í•  (ì˜ˆ: ["ADMIN","USER"]) |

  ---
  4. AuthHubì™€ì˜ í†µì‹ 

  4.1 AuthHub Adapter ì—”ë“œí¬ì¸íŠ¸ (AuthHubAdapter.java)

  | ë©”ì„œë“œ                       | ì—”ë“œí¬ì¸íŠ¸                             | ìš”ì²­                                      | ì‘ë‹µ                                           |
  |---------------------------|-----------------------------------|-----------------------------------------|----------------------------------------------|
  | fetchPublicKeys()         | GET /api/v1/auth/jwks             | -                                       | List<PublicKey> (JWKS)                       |
  | refreshAccessToken()      | POST {refreshEndpoint}            | X-Tenant-ID í—¤ë” + {"refreshToken":"..."} | TokenPair (accessToken, refreshToken)        |
  | extractExpiredTokenInfo() | POST {extractExpiredInfoEndpoint} | {"token":"..."}                         | ExpiredTokenInfo (expired, userId, tenantId) |

  4.2 AuthHub í˜¸ì¶œ ì‹œ ì „ë‹¬ë˜ëŠ” í—¤ë”

  // refreshAccessToken í˜¸ì¶œ ì‹œ
  webClient.post()
      .uri(properties.getRefreshEndpoint())
      .header("X-Tenant-ID", tenantId)  // â† Tenant ì‹ë³„ì
      .contentType(MediaType.APPLICATION_JSON)
      .bodyValue(new RefreshTokenRequest(refreshToken))

  ---
  5. Exchange Attribute (Gateway ë‚´ë¶€ ì „íŒŒ)

  í•„í„° ê°„ ë°ì´í„° ê³µìœ ë¥¼ ìœ„í•´ ServerWebExchange.getAttributes()ì— ì €ì¥:

  | Attribute      | íƒ€ì…           | ì„¤ì • ìœ„ì¹˜                   | ìš©ë„        |
  |----------------|--------------|-------------------------|-----------|
  | userId         | String       | JwtAuthenticationFilter | ì‚¬ìš©ì ì‹ë³„    |
  | tenantId       | String       | JwtAuthenticationFilter | í…Œë„ŒíŠ¸ ì‹ë³„    |
  | permissionHash | String       | JwtAuthenticationFilter | ê¶Œí•œ í•´ì‹œ     |
  | roles          | Set<String>  | JwtAuthenticationFilter | ì—­í•  ëª©ë¡     |
  | mfaVerified    | Boolean      | JwtAuthenticationFilter | MFA ì¸ì¦ ì—¬ë¶€ |
  | tenantContext  | TenantConfig | TenantIsolationFilter   | í…Œë„ŒíŠ¸ ì„¤ì •    |
  | traceId        | String       | TraceIdFilter           | ì¶”ì  ID     |

  ---
  6. ì „ì²´ íë¦„ ë‹¤ì´ì–´ê·¸ë¨

  Client Request
      â”‚
      â”œâ”€ Authorization: Bearer <access_token>
      â”œâ”€ Cookie: refresh_token=<refresh_token>
      â”‚
      â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ TraceIdFilter   â”‚ â”€â†’ X-Trace-Id ìƒì„±/ì „íŒŒ
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ RateLimitFilter â”‚ â”€â†’ IP/Endpoint Rate Limit
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ TokenRefreshFilter  â”‚ â”€â†’ Access Token ë§Œë£Œ ì‹œ:
  â”‚                     â”‚    1. AuthHub.extractExpiredTokenInfo() í˜¸ì¶œ
  â”‚                     â”‚    2. AuthHub.refreshAccessToken() í˜¸ì¶œ
  â”‚                     â”‚    3. Authorization í—¤ë” êµì²´
  â”‚                     â”‚    4. X-User-Id ì¶”ê°€
  â”‚                     â”‚    5. ìƒˆ refresh_token Cookie ì„¤ì •
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ JwtAuthenticationFilter â”‚ â”€â†’ JWT ê²€ì¦ í›„:
  â”‚                         â”‚    1. Exchange Attribute ì„¤ì •
  â”‚                         â”‚    2. X-User-Id í—¤ë” ì¶”ê°€
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ TenantIsolationFilter   â”‚ â”€â†’ Tenant Config ì¡°íšŒ í›„:
  â”‚                         â”‚    1. X-Tenant-Id í—¤ë” ì¶”ê°€
  â”‚                         â”‚    2. X-Roles í—¤ë” ì¶”ê°€ (JSON)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â–¼
      Backend Service
           â”‚
           â”œâ”€ Authorization: Bearer <access_token>
           â”œâ”€ X-Trace-Id: <uuid>
           â”œâ”€ X-User-Id: <user_id>
           â”œâ”€ X-Tenant-Id: <tenant_id>
           â””â”€ X-Roles: ["ADMIN","USER"]

  ---

âº ğŸ“‹ ìš”ì•½

  í† í° í˜•íƒœ:
  - Access Token: Authorization: Bearer <JWT> í—¤ë”
  - Refresh Token: refresh_token Cookie (HttpOnly, Secure, SameSite=Strict)

  Downstream ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬ë˜ëŠ” ì»¤ìŠ¤í…€ í—¤ë”:
  1. X-Trace-Id - ë¶„ì‚° ì¶”ì  ID
  2. X-User-Id - JWT subject (ì‚¬ìš©ì ID)
  3. X-Tenant-Id - í…Œë„ŒíŠ¸ ì‹ë³„ì
  4. X-Roles - ì‚¬ìš©ì ì—­í•  (JSON ë°°ì—´)

  AuthHub í˜¸ì¶œ ì‹œ ì‚¬ìš©í•˜ëŠ” í—¤ë”:
  - X-Tenant-ID - Token Refresh ì‹œ í…Œë„ŒíŠ¸ ì‹ë³„ìš©

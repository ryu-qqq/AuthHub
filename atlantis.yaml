# ============================================================================
# AuthHub - Atlantis Configuration
# ============================================================================
# PR-based Terraform automation for AuthHub infrastructure
# 배포 흐름: develop → stage (PR) → main (PR)
# ============================================================================

version: 3

automerge: false
delete_source_branch_on_merge: false
# Disable parallel plan to prevent plugin cache conflicts
parallel_plan: false
parallel_apply: false

projects:
  # ============================================================================
  # STAGE Environment
  # ============================================================================

  # ECR repository for web-api (Stage)
  - name: authhub-ecr-stage
    dir: terraform/environments/stage/ecr
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true

  # ECS Cluster (Stage)
  - name: authhub-ecs-cluster-stage
    dir: terraform/environments/stage/ecs-cluster
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true

  # ElastiCache (Stage)
  - name: authhub-elasticache-stage
    dir: terraform/environments/stage/elasticache
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true

  # ECS Service for web-api (Stage)
  - name: authhub-ecs-web-api-stage
    dir: terraform/environments/stage/ecs-web-api
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true

  # ============================================================================
  # PROD Environment
  # ============================================================================

  # ECR repository for web-api (Prod)
  - name: authhub-ecr-prod
    dir: terraform/ecr
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "../*.tf"]
      enabled: true

  # ECS Cluster (Prod)
  - name: authhub-ecs-cluster-prod
    dir: terraform/ecs-cluster
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "../*.tf"]
      enabled: true

  # ElastiCache (Prod)
  - name: authhub-elasticache-prod
    dir: terraform/elasticache
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "../*.tf"]
      enabled: true

  # ECS Service for web-api (Prod)
  - name: authhub-ecs-web-api-prod
    dir: terraform/ecs-web-api
    workspace: default
    autoplan:
      when_modified: ["*.tf", "*.tfvars", "../*.tf"]
      enabled: true

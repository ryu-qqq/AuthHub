âº ì¢‹ì€ ì§ˆë¬¸ì…ë‹ˆë‹¤! ì œê°€ ì„¤ëª…ì´ ë¶€ì¡±í–ˆë„¤ìš”. ì „ì²´ í”Œë¡œìš°ë¥¼ ëª…í™•íˆ ì •ë¦¬í•´ë“œë¦´ê²Œìš”.

  ---
  ğŸ” Gateway vs AuthHub ì—­í•  ë¶„ë‹´

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                           ì „ì²´ ì¸ì¦/ì¸ê°€ í”Œë¡œìš°                               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                             â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
  â”‚  â”‚  Client  â”‚ â”€â”€â”€â”€â”€â”€â†’ â”‚   Gateway    â”‚ â”€â”€â”€â”€â”€â”€â†’ â”‚   AuthHub    â”‚            â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
  â”‚                              â”‚                        â”‚                     â”‚
  â”‚                              â”‚                        â”‚                     â”‚
  â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”             â”‚
  â”‚                       â”‚  1ì°¨ ì¸ì¦    â”‚          â”‚  2ì°¨ ì¸ê°€    â”‚             â”‚
  â”‚                       â”‚  (Authentication)â”‚     â”‚  (Authorization)â”‚          â”‚
  â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
  â”‚                              â”‚                        â”‚                     â”‚
  â”‚                       - JWT ê²€ì¦                - ì—­í• ë³„ API ì ‘ê·¼ ì œì–´       â”‚
  â”‚                       - í† í° ìœ íš¨ì„±             - í…Œë„ŒíŠ¸ ë°ì´í„° ê²©ë¦¬         â”‚
  â”‚                       - ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ        - ë¦¬ì†ŒìŠ¤ ì†Œìœ ì ê²€ì¦         â”‚
  â”‚                       - í—¤ë”ë¡œ ì „ë‹¬             - ë¹„ì¦ˆë‹ˆìŠ¤ ê¶Œí•œ ê²€ì¦         â”‚
  â”‚                                                                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  ğŸ“‹ ìƒí™©ë³„ í”Œë¡œìš°

  1ï¸âƒ£ ë¡œê·¸ì¸ ìš”ì²­ (Public API)

  Client                    Gateway                     AuthHub
    â”‚                          â”‚                           â”‚
    â”‚ POST /api/v1/auth/login  â”‚                           â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
    â”‚                          â”‚                           â”‚
    â”‚                          â”‚ ğŸ”“ Public ê²½ë¡œ            â”‚
    â”‚                          â”‚ JWT ê²€ì¦ SKIP             â”‚
    â”‚                          â”‚ í—¤ë” ì¶”ê°€ ì—†ì´ ì „ë‹¬        â”‚
    â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
    â”‚                          â”‚                           â”‚
    â”‚                          â”‚                           â”‚ ë¡œê·¸ì¸ ì²˜ë¦¬
    â”‚                          â”‚                           â”‚ JWT ë°œê¸‰
    â”‚                          â”‚                           â”‚
    â”‚                          â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                           â”‚
    â”‚  Access Token + Refresh  â”‚                           â”‚

  ì´ ê²½ìš° X-User-Id í—¤ë” ì—†ìŒ â†’ AuthHubëŠ” "ì¸ì¦ ì•ˆ ëœ ìš”ì²­"ìœ¼ë¡œ íŒë‹¨ â†’ OK (Public APIë‹ˆê¹Œ)

  ---
  2ï¸âƒ£ Admin API ìš”ì²­ (Authenticated)

  Client                    Gateway                     AuthHub
    â”‚                          â”‚                           â”‚
    â”‚ GET /api/v1/tenants      â”‚                           â”‚
    â”‚ Authorization: Bearer JWTâ”‚                           â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
    â”‚                          â”‚                           â”‚
    â”‚                          â”‚ ğŸ” JWT ê²€ì¦               â”‚
    â”‚                          â”‚ userId: 123 ì¶”ì¶œ          â”‚
    â”‚                          â”‚ tenantId: 456 ì¶”ì¶œ        â”‚
    â”‚                          â”‚ roles: [TENANT_ADMIN]     â”‚
    â”‚                          â”‚                           â”‚
    â”‚                          â”‚ X-User-Id: 123            â”‚
    â”‚                          â”‚ X-Tenant-Id: 456          â”‚
    â”‚                          â”‚ X-Roles: [TENANT_ADMIN]   â”‚
    â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
    â”‚                          â”‚                           â”‚
    â”‚                          â”‚                           â”‚ ğŸ›¡ï¸ ì¸ê°€ ê²€ì¦
    â”‚                          â”‚                           â”‚ 1. í—¤ë”ì—ì„œ ì •ë³´ ì¶”ì¶œ
    â”‚                          â”‚                           â”‚ 2. TENANT_ADMINì´ ì´ API í˜¸ì¶œ ê°€ëŠ¥?
    â”‚                          â”‚                           â”‚ 3. tenantId=456 ë°ì´í„°ë§Œ ì¡°íšŒ
    â”‚                          â”‚                           â”‚
    â”‚                          â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                           â”‚
    â”‚  Tenant ëª©ë¡ (456ë§Œ)     â”‚                           â”‚

  ì´ ê²½ìš° X-User-Id í—¤ë” ìˆìŒ â†’ AuthHubëŠ” "ì¸ì¦ëœ ìš”ì²­"ìœ¼ë¡œ íŒë‹¨ â†’ ì¸ê°€ ê²€ì¦ ìˆ˜í–‰

  ---
  â“ ì‚¬ìš©ì ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€

  Q1. "Gatewayê°€ í•­ìƒ ì•ì— ìˆëŠ”ë° ì™œ í—¤ë” ìœ ë¬´ë¡œ íŒë‹¨?"

  A: Gatewayê°€ í•­ìƒ ì•ì— ìˆì–´ë„, Public APIì—ëŠ” í—¤ë”ë¥¼ ì¶”ê°€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

  | API ìœ í˜•                | Gateway ë™ì‘     | X-User-Id í—¤ë” | AuthHub íŒë‹¨  |
  |-----------------------|----------------|--------------|-------------|
  | Public (ë¡œê·¸ì¸, JWKS)    | JWT ê²€ì¦ SKIP    | âŒ ì—†ìŒ         | ì¸ì¦ ë¶ˆí•„ìš”      |
  | Authenticated (Admin) | JWT ê²€ì¦ + í—¤ë” ì¶”ê°€ | âœ… ìˆìŒ         | ì¸ì¦ë¨ â†’ ì¸ê°€ ê²€ì¦ |

  ---
  Q2. "AuthHubì—ì„œ ê¶Œí•œ ì²˜ë¦¬ëŠ” ì–´ë””ì„œ ì–´ë–»ê²Œ?"

  A: AuthHubì—ì„œ 2ì°¨ ì¸ê°€(Authorization)ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

  // AuthHubì˜ ì—­í• 

  // 1ï¸âƒ£ í—¤ë”ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ (Filter)
  GatewayAuthenticationFilter {
      // X-User-Id: 123 â†’ userId = 123
      // X-Tenant-Id: 456 â†’ tenantId = 456
      // X-Roles: ["ROLE_TENANT_ADMIN"] â†’ roles
      // â†’ SecurityContextì— ì €ì¥
  }

  // 2ï¸âƒ£ APIë³„ ì—­í•  ê²€ì¦ (Controller)
  @RestController
  public class TenantQueryController {

      @GetMapping("/api/v1/tenants")
      @PreAuthorize("hasAnyRole('SUPER_ADMIN', 'TENANT_ADMIN')")  // â† ì—¬ê¸°ì„œ ì¸ê°€
      public List<Tenant> getTenants() {
          // TENANT_ADMINì€ ìê¸° í…Œë„ŒíŠ¸ë§Œ, SUPER_ADMINì€ ì „ì²´
      }
  }

  // 3ï¸âƒ£ í…Œë„ŒíŠ¸ ë°ì´í„° ê²©ë¦¬ (Repository/Adapter)
  public class TenantQueryAdapter {

      public List<Tenant> findAll() {
          Long tenantId = SecurityContextHolder.getCurrentTenantId();

          if (SecurityContextHolder.hasRole("SUPER_ADMIN")) {
              return repository.findAll();  // ì „ì²´ ì¡°íšŒ
          } else {
              return repository.findByTenantId(tenantId);  // ìê¸° í…Œë„ŒíŠ¸ë§Œ
          }
      }
  }

  ---
  Q3. "JwtAuthenticationFilterëŠ” ì–´ë–»ê²Œ?"

  A: ì‚­ì œí•˜ê±°ë‚˜ ë¡œê·¸ì¸ API ì „ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

  í˜„ì¬ ìƒí™©:
  ê¸°ì¡´ JwtAuthenticationFilter
  â”œâ”€ JWT ê²€ì¦ â† Gatewayê°€ ì´ë¯¸ í•¨ (ì¤‘ë³µ!)
  â”œâ”€ SecurityContext ì„¤ì • â† ìƒˆ Filterê°€ í—¤ë” ê¸°ë°˜ìœ¼ë¡œ í•¨
  â””â”€ ì—­í•  ì¶”ì¶œ â† ìƒˆ Filterê°€ X-Rolesì—ì„œ í•¨

  ê²°ë¡ : ê¸°ì¡´ JwtAuthenticationFilterì˜ ì—­í• ì€ GatewayAuthenticationFilterê°€ ëŒ€ì²´í•©ë‹ˆë‹¤.

  ë‹¨, ë¡œê·¸ì¸ APIì—ì„œ JWTë¥¼ ë°œê¸‰í•˜ëŠ” ë¡œì§(JwtTokenProvider)ì€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

  ---
  âœ… ì •ë¦¬: ìˆ˜ì •ëœ ì„¤ê³„

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  AuthHub ë‚´ë¶€ ì¸ê°€ íë¦„                                                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                             â”‚
  â”‚  Request (from Gateway)                                                     â”‚
  â”‚       â”‚                                                                     â”‚
  â”‚       â–¼                                                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
  â”‚  â”‚ GatewayAuthenticationFilter â”‚  â† X-User-Id, X-Tenant-Id, X-Roles íŒŒì‹±   â”‚
  â”‚  â”‚ (OncePerRequestFilter)      â”‚  â† SecurityContext ì„¤ì •                   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
  â”‚       â”‚                                                                     â”‚
  â”‚       â–¼                                                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
  â”‚  â”‚ Spring Security             â”‚  â† @PreAuthorize("hasRole('ADMIN')")      â”‚
  â”‚  â”‚ (Method Security)           â”‚  â† ì—­í• ë³„ API ì ‘ê·¼ ì œì–´                    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
  â”‚       â”‚                                                                     â”‚
  â”‚       â–¼                                                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
  â”‚  â”‚ Controller                  â”‚  â† UseCase í˜¸ì¶œ                           â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
  â”‚       â”‚                                                                     â”‚
  â”‚       â–¼                                                                     â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
  â”‚  â”‚ Repository/Adapter          â”‚  â† tenantId í•„í„° ì ìš© (ë°ì´í„° ê²©ë¦¬)        â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
  â”‚                                                                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  ğŸ”§ êµ¬í˜„í•´ì•¼ í•  ê²ƒ (ìˆ˜ì •)

  | ì»´í¬ë„ŒíŠ¸                        | ì—­í•                          | ìœ„ì¹˜                 |
  |-----------------------------|----------------------------|--------------------|
  | GatewayAuthenticationFilter | X-* í—¤ë” â†’ SecurityContext   | auth/filter/       |
  | SecurityContext             | userId, tenantId, roles ì €ì¥ | auth/component/    |
  | SecurityContextHolder       | ThreadLocal ê´€ë¦¬             | auth/component/    |
  | @PreAuthorize               | ì—­í• ë³„ API ì ‘ê·¼ ì œì–´              | Controller         |
  | TenantSecurityChecker       | í…Œë„ŒíŠ¸ ê¶Œí•œ ê²€ì¦ Bean             | auth/component/    |
  | í…Œë„ŒíŠ¸ í•„í„°ë§                     | tenantId ê¸°ë°˜ ë°ì´í„° ì¡°íšŒ         | Repository/Adapter |

  ---
  ì´ì œ í”Œë¡œìš°ê°€ ëª…í™•í•´ì¡Œë‚˜ìš”? ì¶”ê°€ ì§ˆë¬¸ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”!

  Todos
  â˜’ Phase 1.1: ë³´ì•ˆ ì¸í”„ë¼ ìƒì„¸ ì„¤ê³„ ë¬¸ì„œ ì‘ì„±
  â˜ Phase 1.1: ë³´ì•ˆ ì¸í”„ë¼ êµ¬í˜„ (SecurityContext, Filter, ì–´ë…¸í…Œì´ì…˜)
  â˜ Phase 1.1: springdoc-openapi ì„¤ì •
  â˜ Phase 1.2: Tenant BC ì¬ì‘ì„± (Domain â†’ Application â†’ Persistence â†’ REST API)
  â˜ Phase 1.3: Organization BC ì¬ì‘ì„± (Domain â†’ Application â†’ Persistence â†’ REST API)
  â˜ Phase 1 ê²€ì¦: ì „ì²´ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸

= AuthHub API Documentation
:doctype: book
:icons: font
:source-highlighter: highlightjs
:toc: left
:toclevels: 3
:sectlinks:
:sectnums:

[[overview]]
== Overview

AuthHub는 마이크로서비스 아키텍처의 **인증/인가 중앙 서버**입니다.

JWT 발급, 사용자/테넌트/조직/역할/권한 관리, 엔드포인트 권한 명세 제공을 담당합니다.

=== Base URL

[cols="1,3"]
|===
| Environment | URL

| Development
| `http://localhost:8080`

| Production
| `https://api.authhub.com`
|===

[[architecture]]
== 아키텍처

[[architecture-system-overview]]
=== 시스템 개요

[source]
----
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Client (Web/Mobile)                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Connectly Gateway                                      │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │ 1. JWT 검증 (AuthHub JWKS로 RS256 공개키 조회)                             │  │
│  │ 2. Rate Limiting (IP/User 기반)                                           │  │
│  │ 3. Permission 검사 (AuthHub의 Endpoint Permission Spec 사용)               │  │
│  │ 4. 헤더 주입 → X-User-Id, X-Tenant-Id, X-User-Roles                       │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
          │                              │                              │
          ▼                              ▼                              ▼
┌──────────────────┐          ┌──────────────────┐          ┌──────────────────┐
│     AuthHub      │          │   Order Service  │          │  Product Service │
│  (인증/권한 중앙) │          │   (주문 서비스)   │          │   (상품 서비스)   │
├──────────────────┤          ├──────────────────┤          ├──────────────────┤
│ • 로그인/토큰발급 │          │ • 헤더로 인증정보 │          │ • 헤더로 인증정보 │
│ • JWKS 제공      │          │   수신           │          │   수신           │
│ • 사용자 관리    │          │ • 비즈니스 로직만 │          │ • 비즈니스 로직만 │
│ • 테넌트/조직관리│          │   집중           │          │   집중           │
│ • 역할/권한 관리 │          │                  │          │                  │
│ • Endpoint 권한  │          │                  │          │                  │
│   Spec 관리/제공 │          │                  │          │                  │
└──────────────────┘          └──────────────────┘          └──────────────────┘
----

[[architecture-server-roles]]
=== 서버별 역할

[cols="1,4", options="header"]
|===
| 서버 | 역할

| **AuthHub**
| 인증(JWT 발급), JWKS 제공, 사용자/테넌트/조직/역할/권한 관리, Endpoint Permission Spec 관리

| **Gateway**
| JWT 검증(RS256), Rate Limiting, Permission 검사, 헤더 주입

| **Backend Services**
| 비즈니스 로직만 집중, 헤더로 인증정보 수신 (JWT 검증 없음)
|===

[[architecture-jwt]]
=== JWT 인증 흐름

[source]
----
┌──────────┐                  ┌─────────────┐                  ┌──────────┐
│  Client  │                  │   Gateway   │                  │ AuthHub  │
└────┬─────┘                  └──────┬──────┘                  └────┬─────┘
     │                               │                              │
     │  1. Request + Bearer Token    │                              │
     │ ─────────────────────────────▶│                              │
     │                               │                              │
     │                               │  2. Get Public Key (JWKS)    │
     │                               │ ────────────────────────────▶│
     │                               │                              │
     │                               │◀──────────────────────────── │
     │                               │     RS256 Public Key         │
     │                               │                              │
     │                               │  3. Verify JWT Signature     │
     │                               │  4. Extract Claims           │
     │                               │  5. Check Permission Spec    │
     │                               │  6. Inject Headers           │
     │                               │                              │
     │  7. Response                  │                              │
     │ ◀─────────────────────────────│                              │
     │                               │                              │
----

==== JWT Claims 구조

[source,json]
----
{
  "sub": "user-uuid-v7",
  "tid": "tenant-uuid-v7",
  "tenant_name": "테넌트명",
  "oid": "organization-uuid-v7",
  "org_name": "조직명",
  "email": "user@example.com",
  "roles": ["TENANT_ADMIN", "ORDER_MANAGER"],
  "permissions": ["user:read", "order:create"],
  "iat": 1704067200,
  "exp": 1704070800
}
----

[[architecture-permission]]
=== 권한 검사 흐름

[source]
----
┌─────────────────────────────────────────────────────────────────────────────────┐
│                 1. Endpoint Permission 등록 (AuthHub 관리)                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ POST /api/v1/endpoint-permissions                                        │    │
│  │ {                                                                        │    │
│  │   "httpMethod": "POST",                                                  │    │
│  │   "pathPattern": "/api/v1/orders",                                       │    │
│  │   "serviceName": "order-service",                                        │    │
│  │   "requiredRoles": ["TENANT_ADMIN", "ORDER_MANAGER"],                    │    │
│  │   "requiredPermissions": ["order:create"],                               │    │
│  │   "isPublic": false                                                      │    │
│  │ }                                                                        │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                  2. Gateway가 Permission Spec 조회/캐싱                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ GET /api/v1/endpoint-permissions/spec                                    │    │
│  │                                                                          │    │
│  │ Redis Cache:                                                             │    │
│  │   "POST:/api/v1/orders" → {roles: [...], permissions: [...]}            │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     3. 요청 시 Permission 검사 (Gateway)                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ Client: POST /api/v1/orders (Bearer Token)                               │    │
│  │                                                                          │    │
│  │ Gateway PermissionFilter:                                                │    │
│  │   1. JWT Claims에서 roles, permissions 추출                              │    │
│  │   2. "POST:/api/v1/orders" 권한 스펙 조회                                │    │
│  │   3. 사용자 roles/permissions와 비교 (OR 조건)                           │    │
│  │   4. 매칭되면 통과, 아니면 403 Forbidden                                 │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────┘
----

[[architecture-role-hierarchy]]
=== 역할 계층 구조

[source]
----
SUPER_ADMIN (tenant_id = NULL, scope = GLOBAL)
    │
    └── 모든 테넌트 관리, 시스템 설정, 엔드포인트 권한 관리

TENANT_ADMIN (tenant_id = N, scope = TENANT)
    │
    └── 특정 테넌트 내 조직/사용자/역할 관리

ORG_ADMIN (tenant_id = N, organization_id = M, scope = ORGANIZATION)
    │
    └── 특정 조직 내 사용자 관리

ORG_USER (tenant_id = N, organization_id = M, scope = ORGANIZATION)
    │
    └── 일반 사용자 (본인 정보 조회만)
----

==== 역할별 기본 권한

[cols="1,3", options="header"]
|===
| 역할 | 권한

| SUPER_ADMIN
| tenant:*, user:*, role:*, permission:*, endpoint:*, organization:*, system:*

| TENANT_ADMIN
| user:create/read/update/delete, role:read/assign, organization:*

| ORG_ADMIN
| user:read/update (조직 내), role:assign (조직 내)

| ORG_USER
| user:read (본인만)
|===

[[architecture-gateway-integration]]
=== Gateway 연동 (Webhook)

AuthHub에서 권한/설정 변경 시 Gateway 캐시를 무효화합니다.

[cols="2,2,3", options="header"]
|===
| Webhook | 트리거 | Gateway 엔드포인트

| Public Key 변경
| RSA 키 로테이션
| `/actuator/refresh-public-keys`

| Permission Spec 변경
| 엔드포인트 권한 변경
| `/webhooks/permission/spec-sync`

| 사용자 권한 변경
| 역할 할당/해제
| `/webhooks/permission/user-invalidate`

| Tenant Config 변경
| 테넌트 설정 변경
| `/internal/gateway/tenants/config-changed`
|===

[[response-format]]
== 응답 형식

=== 성공 응답

[source,json]
----
{
    "result": "SUCCESS",
    "data": { ... },
    "message": null
}
----

=== 에러 응답

[source,json]
----
{
    "result": "FAIL",
    "data": null,
    "message": "에러 메시지",
    "errors": [
        {
            "field": "필드명",
            "message": "필드 에러 메시지"
        }
    ]
}
----

[[http-status-codes]]
== HTTP 상태 코드

[cols="1,3", options="header"]
|===
| 상태 코드 | 설명

| `200 OK`
| 요청 성공 (조회, 수정, 삭제)

| `201 Created`
| 리소스 생성 성공

| `400 Bad Request`
| 잘못된 요청 (유효성 검증 실패)

| `401 Unauthorized`
| 인증 실패 (JWT 없음, 만료, 유효하지 않음)

| `403 Forbidden`
| 권한 없음 (인증은 됐으나 접근 권한 없음)

| `404 Not Found`
| 리소스를 찾을 수 없음

| `409 Conflict`
| 리소스 충돌 (중복 등)

| `500 Internal Server Error`
| 서버 내부 오류
|===

[[api-permissions]]
== API 권한 요약

[cols="1,2,2,2", options="header"]
|===
| Method | Endpoint | 권한 | 설명

| POST
| /api/v1/auth/login
| **Public**
| 로그인

| POST
| /api/v1/auth/refresh
| **Public**
| 토큰 갱신

| GET
| /api/v1/auth/.well-known/jwks.json
| **Public**
| JWKS 조회

| POST
| /api/v1/tenants
| SUPER_ADMIN
| 테넌트 생성

| GET
| /api/v1/tenants
| SUPER_ADMIN
| 테넌트 목록 조회

| POST
| /api/v1/organizations
| TENANT_ADMIN
| 조직 생성

| POST
| /api/v1/users
| SUPER_ADMIN, TENANT_ADMIN
| 사용자 생성

| GET
| /api/v1/users
| SUPER_ADMIN, TENANT_ADMIN, ORG_ADMIN
| 사용자 목록 조회

| GET
| /api/v1/users/me
| Authenticated
| 내 정보 조회

| GET
| /api/v1/roles
| TENANT_ADMIN
| 역할 목록 조회

| POST
| /api/v1/endpoint-permissions
| SUPER_ADMIN
| 엔드포인트 권한 등록

| GET
| /api/v1/endpoint-permissions/spec
| **Internal** (Gateway)
| 권한 스펙 조회
|===

[[api-v1]]
== API V1

include::v1/auth/auth.adoc[]

include::v1/tenant/tenant.adoc[]

include::v1/organization/organization.adoc[]

include::v1/user/user.adoc[]

include::v1/role/role.adoc[]

include::v1/permission/permission.adoc[]

include::v1/endpoint-permission/endpoint-permission.adoc[]

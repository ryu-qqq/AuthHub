[[system]]
=== System API (서버 간 통신 - 입점/온보딩)

입점 승인 등 시스템 수준의 작업을 처리하는 API입니다.

IMPORTANT: System API는 Kubernetes 클러스터 내부에서만 접근 가능하며, **X-Service-Token** 헤더로 인증합니다.

[[system-authentication]]
==== 인증 방식

System API는 JWT 인증 대신 **X-Service-Token** 헤더를 사용합니다.

[cols="1,3", options="header"]
|===
| 헤더 | 설명

| `X-Service-Token`
| 서비스 간 통신용 비밀 토큰 (환경 변수 `SECURITY_SERVICE_TOKEN_SECRET`으로 설정)
|===

[[system-tenant-onboarding]]
==== 테넌트 온보딩

입점 승인 시 Tenant, Organization, User를 일괄 생성합니다.

NOTE: 이 API는 입점 서비스에서 입점 승인 시 호출됩니다. 임시 비밀번호가 반환되므로 호출자가 마스터 사용자에게 이메일로 발송해야 합니다.

===== HTTP Request

operation::system-tenant-onboarding[snippets='http-request,request-fields']

===== HTTP Response

operation::system-tenant-onboarding[snippets='http-response,response-fields']

===== cURL 예시

operation::system-tenant-onboarding[snippets='curl-request']

===== 생성되는 리소스

[cols="1,3", options="header"]
|===
| 리소스 | 설명

| Tenant
| 테넌트(회사) 엔티티 - ACTIVE 상태로 생성

| Organization
| 기본 조직 엔티티 - 테넌트에 속하는 기본 조직

| User
| 마스터 관리자 - ADMIN 역할 자동 부여
|===

===== 에러 응답

[cols="1,2,3", options="header"]
|===
| HTTP Status | Error Code | 설명

| 400 Bad Request
| VALIDATION_ERROR
| 필수 필드 누락 또는 형식 오류

| 401 Unauthorized
| UNAUTHORIZED
| X-Service-Token 헤더 누락 또는 유효하지 않음

| 409 Conflict
| EMAIL_ALREADY_EXISTS
| 마스터 이메일이 이미 존재함
|===

===== 사용 흐름

[source]
----
┌─────────────────┐                     ┌──────────┐
│  입점 서비스     │                     │ AuthHub  │
└────────┬────────┘                     └────┬─────┘
         │                                    │
         │  1. 입점 승인                       │
         │  POST /system/tenants/onboarding   │
         │ ──────────────────────────────────▶│
         │    {tenantName, masterEmail, ...}  │
         │                                    │
         │                                    │ 2. Tenant 생성
         │                                    │ 3. Organization 생성
         │                                    │ 4. User 생성 (ADMIN)
         │                                    │ 5. 임시 비밀번호 생성
         │                                    │
         │  6. 응답                            │
         │ ◀────────────────────────────────── │
         │    {tenantId, orgId, userId,       │
         │     temporaryPassword}             │
         │                                    │
         │  7. 마스터 사용자에게 이메일 발송    │
         │  (temporaryPassword 포함)          │
         │                                    │
----

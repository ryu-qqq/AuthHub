[[internal]]
=== Internal API (서비스 간 통신)

Gateway 등 내부 서비스에서 호출하는 API입니다.

IMPORTANT: Internal API는 Kubernetes 클러스터 내부에서만 접근 가능하며, **X-Service-Token** 헤더로 인증합니다.

[[internal-authentication]]
==== 인증 방식

Internal API는 JWT 인증 대신 **X-Service-Token** 헤더를 사용합니다.

[cols="1,3", options="header"]
|===
| 헤더 | 설명

| `X-Service-Token`
| 서비스 간 통신용 비밀 토큰 (환경 변수 `SECURITY_SERVICE_TOKEN_SECRET`으로 설정)
|===

===== 요청 예시

[source,http]
----
GET /api/v1/auth/permissions/spec HTTP/1.1
Host: auth-hub.internal:8080
X-Service-Token: your-service-secret-token
Accept: application/json
----

[[internal-permission-spec]]
==== 권한 명세 조회 (Gateway용)

Gateway에서 캐싱할 권한 명세를 조회합니다.

이 API는 Gateway가 시작 시 또는 주기적으로 호출하여 권한 검사에 사용할 명세를 캐싱하는 용도입니다.

===== HTTP Request

[source,http]
----
GET /api/v1/auth/permissions/spec HTTP/1.1
Host: auth-hub.internal:8080
X-Service-Token: your-service-secret-token
Accept: application/json
----

===== HTTP Response

[source,http]
----
HTTP/1.1 200 OK
Content-Type: application/json

{
    "success": true,
    "data": {
        "endpoints": [
            {
                "method": "POST",
                "pattern": "/api/v1/auth/users",
                "requiredPermissions": ["user:create"],
                "requiredRoles": [],
                "isPublic": false
            },
            {
                "method": "GET",
                "pattern": "/api/v1/auth/users/{userId}",
                "requiredPermissions": ["user:read"],
                "requiredRoles": [],
                "isPublic": false
            }
        ],
        "version": "2024-01-15T10:30:00Z"
    }
}
----

[[internal-user-permissions]]
==== 사용자 권한 조회 (Gateway용)

Gateway에서 사용자의 역할 및 권한 목록을 조회합니다.

===== HTTP Request

[source,http]
----
GET /api/v1/auth/permissions/users/{userId} HTTP/1.1
Host: auth-hub.internal:8080
X-Service-Token: your-service-secret-token
Accept: application/json
----

===== HTTP Response

[source,http]
----
HTTP/1.1 200 OK
Content-Type: application/json

{
    "success": true,
    "data": {
        "userId": "550e8400-e29b-41d4-a716-446655440000",
        "roles": ["TENANT_ADMIN", "ORDER_MANAGER"],
        "permissions": ["user:read", "user:create", "order:*"]
    }
}
----

[[internal-spec-usage]]
==== 사용 시나리오

[source]
----
┌────────────────────────────────────────────────────────────────────────────────┐
│                    Gateway Permission Spec 캐싱 흐름                            │
└────────────────────────────────────────────────────────────────────────────────┘

1. Gateway 시작 시
   ┌─────────────┐        ┌─────────────┐
   │   Gateway   │  GET   │   AuthHub   │
   │             │ ─────▶ │             │
   │             │        │ /api/v1/    │
   │             │ ◀───── │ auth/       │
   │   Redis     │  JSON  │ permissions │
   │   Cache     │        │ /spec       │
   └─────────────┘        └─────────────┘

2. 요청 처리 시
   ┌──────────┐     ┌─────────────┐     ┌─────────────┐
   │  Client  │ ──▶ │   Gateway   │ ──▶ │  Backend    │
   │          │     │             │     │  Service    │
   │          │     │ Permission  │     │             │
   │          │     │ Check from  │     │             │
   │          │     │ Redis Cache │     │             │
   └──────────┘     └─────────────┘     └─────────────┘

3. 권한 변경 시 (Webhook)
   ┌─────────────┐  Webhook   ┌─────────────┐
   │   AuthHub   │ ─────────▶ │   Gateway   │
   │             │            │             │
   │ Permission  │  POST      │ Cache       │
   │ Changed     │ /webhooks/ │ Invalidate  │
   │             │ permission │             │
   └─────────────┘ /spec-sync └─────────────┘
----

[[internal-response-fields]]
==== Response 필드 상세 설명

[cols="1,4", options="header"]
|===
| 필드 | 설명

| `endpoints[].method`
| HTTP 메서드 (GET, POST, PUT, DELETE 등)

| `endpoints[].pattern`
| 경로 패턴 (예: `/api/v1/auth/users/{userId}`)

| `endpoints[].requiredRoles`
| 필요 역할 목록 (OR 조건, 빈 배열이면 역할 검사 스킵)

| `endpoints[].requiredPermissions`
| 필요 권한 목록 (OR 조건, 빈 배열이면 권한 검사 스킵)

| `endpoints[].isPublic`
| 공개 여부 (`true`면 인증/권한 검사 스킵)

| `version`
| 스펙 버전 (ISO-8601 형식, Gateway에서 캐시 무효화 판단에 사용)
|===

[[internal-vs-admin-api]]
==== Internal API vs Admin API 비교

[cols="1,2,2", options="header"]
|===
| 구분 | Internal API | Admin API

| 경로
| `/api/v1/auth/*` (X-Service-Token)
| `/api/v1/auth/*` (JWT)

| 인증 방식
| X-Service-Token 헤더
| JWT (Bearer Token)

| 사용 주체
| Gateway, 내부 서비스
| 관리자 (Admin Console)

| 네트워크 접근
| Kubernetes 내부만
| 외부 접근 가능 (admin.connectly.com)

| 용도
| 서비스 간 데이터 동기화
| CRUD 관리 작업
|===
